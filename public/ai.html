<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf AI</title>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- DOMPurify for sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts - Clean Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- DOCX.js for Word document generation -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js"></script>

<!-- FileSaver.js for downloading files -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
         <link rel="icon" type="image/x-icon" href="./favicon/favicon.ico">
<!-- PptxGenJS for PowerPoint generation -->
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<!-- Leaf Intelligence PowerPoint Export -->
<script src="exportToPPTX.js"></script>
<!-- PNG favicons for different sizes -->
<link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">

<!-- Apple Touch Icons for iOS devices -->
<link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">

<!-- Android Chrome icons -->
<link rel="icon" type="image/png" sizes="192x192" href="./favicon/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./favicon/android-chrome-512x512.png">
<link rel="stylesheet" href="aistyle.css">


</head>
<body>
 <!-- Skeleton Loader - Exact UI Mirror -->
<!-- Add immediately after <body> tag -->
<div class="app-skeleton-overlay" id="appSkeletonOverlay">
    
    <!-- SIDEBAR - Exact 260px match -->
    <aside class="skel-sidebar">
        <!-- Sidebar Header -->
        <div class="skel-sidebar-header">
            <div class="skel-brand">
                <div class="skel-logo skeleton-shimmer"></div>
                <div class="skel-brand-text">
                    <div class="skeleton-shimmer" style="height: 14px; width: 100px; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer" style="height: 10px; width: 80px; border-radius: 4px;"></div>
                </div>
            </div>
            <div class="skel-sidebar-toggle skeleton-shimmer"></div>
        </div>
        
        <!-- Sidebar Content -->
        <div class="skel-sidebar-content">
            <!-- New Conversation Button -->
            <div class="skel-sidebar-section">
                <div class="skel-nav-btn primary skeleton-shimmer"></div>
            </div>
            
            <!-- Your Files -->
            <div class="skel-sidebar-section">
                <div class="skel-nav-btn skeleton-shimmer"></div>
            </div>
            
            <!-- Conversations Section -->
            <div class="skel-sidebar-section">
                <div class="skel-section-title skeleton-shimmer"></div>
                <div class="skel-conversation skeleton-shimmer"></div>
                <div class="skel-conversation skeleton-shimmer" style="opacity: 0.8;"></div>
                <div class="skel-conversation skeleton-shimmer" style="opacity: 0.6;"></div>
                <div class="skel-conversation skeleton-shimmer" style="opacity: 0.4;"></div>
            </div>
        </div>
        
        <!-- Sidebar Footer -->
        <div class="skel-sidebar-footer">
            <div class="skel-user-profile">
                <div class="skel-avatar skeleton-shimmer"></div>
                <div class="skel-user-info">
                    <div class="skeleton-shimmer" style="height: 12px; width: 60px; border-radius: 4px;"></div>
                    <div class="skeleton-shimmer" style="height: 10px; width: 100px; border-radius: 4px;"></div>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- MAIN WRAPPER -->
    <div class="skel-main-wrapper">
        <!-- Navbar -->
        <nav class="skel-navbar">
            <div class="skel-navbar-left">
                <!-- Empty on desktop, toggle on mobile -->
            </div>
            <div class="skel-navbar-right">
                <div class="skel-navbar-btn skeleton-shimmer"></div>
                <div class="skel-navbar-btn skeleton-shimmer"></div>
            </div>
        </nav>
        
        <!-- Content Area -->
        <div class="skel-content-area">
            <div class="skel-chat-wrapper">
                <!-- Welcome State - Centered -->
                <div class="skel-welcome">
                    <!-- Logo Orb with actual leaf image -->
                    <div class="skel-logo-orb">
                        <div class="skel-logo-glow"></div>
                        <!-- <img src="leaf.png" alt="" style="position: relative; z-index: 1;"> -->
                    </div>
                    
                    <!-- Greeting -->
                    <div class="skel-greeting skeleton-shimmer"></div>
                    <div class="skel-subtitle skeleton-shimmer"></div>
                    
                    <!-- Input Bar -->
                    <div class="skel-input-bar">
                        <div class="skel-input-inner">
                            <div class="skel-input-icon skeleton-shimmer"></div>
                            <div class="skel-input-field skeleton-shimmer"></div>
                            <div class="skel-input-selector skeleton-shimmer"></div>
                            <div class="skel-input-send skeleton-shimmer"></div>
                        </div>
                    </div>
                    
                    <!-- Example Pills -->
                    <div class="skel-pills">
                        <div class="skel-pill skeleton-shimmer"></div>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div style="margin-top: 32px; display: flex; flex-direction: column; align-items: center; gap: 12px;">
                        <div class="skel-spinner">
                            <div class="skel-spinner-dot"></div>
                            <div class="skel-spinner-dot"></div>
                            <div class="skel-spinner-dot"></div>
                        </div>
                        <span class="skel-loader-text" id="skeletonStatusText">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="skel-footer">
                <div class="skel-footer-text skeleton-shimmer"></div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================
     REPLACE THE PROMPTS MODAL (lines 157-202)
     ============================================ -->

<div class="prompts-overlay" id="promptsOverlay" onclick="closePromptsCenter(event)">
    <div class="prompts-container" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="prompts-header">
            <div class="prompts-header-left">
                <h2 class="prompts-title">My Prompts</h2>
                <p class="prompts-subtitle">Your saved prompts for quick access.</p>
            </div>
            <div class="prompts-header-actions">
                <!-- ADD PROMPT BUTTON -->
                <button class="btn-add-prompt" onclick="createNewPrompt()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Prompt
                </button>
                <div class="prompts-search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" placeholder="Search prompts..." id="promptsSearchInput" oninput="filterPrompts(this.value)">
                </div>
                <button class="prompts-close-btn" onclick="closePromptsCenter()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Body -->
        <div class="prompts-body">
            <div class="prompts-grid" id="promptsGrid">
                <!-- Prompts will be loaded dynamically -->
            </div>
            
            <!-- Empty State -->
            <div class="prompts-empty" id="promptsEmpty" style="display: none;">
                <svg class="prompts-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                </svg>
                <h3 class="prompts-empty-title">No prompts yet</h3>
                <p class="prompts-empty-desc">Create your first prompt to get started.</p>
                <button class="btn-create-prompt" onclick="createNewPrompt()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Create Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Global Drag Overlay -->
<div id="globalDragOverlay" class="drag-overlay">
    <div class="drag-overlay-content">
        <div class="drag-overlay-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
        </div>
        <h3>Drop files here to upload</h3>
        <p>Supported: Documents, Images, Audio, Video & more</p>
    </div>
</div>

<!-- Upload Toast -->
<div id="uploadToast" class="upload-toast">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <span id="uploadToastMessage">File uploaded successfully</span>
</div>
<!-- Delete Conversation Modal -->
<div id="deleteConversationModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Delete Conversation</h3>
            <button onclick="LeafConversations.closeDeleteModal()" class="modal-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-icon warning">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <p class="modal-message">Are you sure you want to delete this conversation? This action cannot be undone.</p>
            <p class="modal-conversation-title" id="deleteConversationTitle"></p>
        </div>
        <div class="modal-footer">
            <button onclick="LeafConversations.closeDeleteModal()" class="modal-btn modal-btn-secondary">Cancel</button>
            <button onclick="LeafConversations.confirmDelete()" class="modal-btn modal-btn-danger">Delete Conversation</button>
        </div>
    </div>
</div>

<!-- Rename Conversation Modal -->
<div id="renameConversationModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">Rename Conversation</h3>
            <button onclick="LeafConversations.closeRenameModal()" class="modal-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="modal-icon primary">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
            </div>
            <label for="conversationTitleInput" class="modal-label">Conversation Title</label>
            <input 
                type="text" 
                id="conversationTitleInput" 
                class="modal-input" 
                placeholder="Enter new title"
                maxlength="100"
            >
        </div>
        <div class="modal-footer">
            <button onclick="LeafConversations.closeRenameModal()" class="modal-btn modal-btn-secondary">Cancel</button>
            <button onclick="LeafConversations.confirmRename()" class="modal-btn modal-btn-primary">Save Changes</button>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdfViewerModal" class="pdf-viewer-modal" style="display: none;">
    <div class="pdf-modal-backdrop" onclick="closePdfViewer()"></div>
    <div class="pdf-modal-container">
        <div class="pdf-modal-header">
            <div class="pdf-modal-title">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <span id="pdfViewerTitle">Document</span>
            </div>
            <div class="pdf-modal-actions">
                <a id="pdfDownloadBtn" href="#" download class="pdf-action-btn" title="Download">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </a>
                <a id="pdfNewTabBtn" href="#" target="_blank" class="pdf-action-btn" title="Open in New Tab">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>
                <button onclick="closePdfViewer()" class="pdf-close-btn" title="Close">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="pdf-modal-body">
            <iframe id="pdfViewerFrame" class="pdf-viewer-frame"></iframe>
        </div>
    </div>
</div>

<!-- ========================================
     FILES CENTER MODAL  
     ======================================== -->
<div class="files-overlay" id="filesOverlay" onclick="closeFilesCenter(event)">
    <div class="files-container" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="files-modal-header">
            <h2 class="files-modal-title">My Documents</h2>
            <div class="files-header-actions">
                <button class="btn-export">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Export
                </button>
                <button class="btn-new-doc" onclick="uploadNewFile()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Document
                </button>
                <button class="files-close-btn" onclick="closeFilesCenter()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="files-tabs">
            <button class="files-tab active" onclick="switchFilesTab('all', this)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                All Documents
            </button>
            <button class="files-tab" onclick="switchFilesTab('reports', this)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Saved Reports
            </button>
            <button class="files-tab" onclick="switchFilesTab('uploads', this)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Uploaded Media
            </button>
            <button class="files-tab" onclick="switchFilesTab('drafts', this)">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Drafts
            </button>
        </div>
        
        <!-- Toolbar -->
        <div class="files-toolbar">
            <div class="files-filters">
                <button class="filter-chip">
                    Sort By: Last Updated
                    <span class="remove">×</span>
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="files-search">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" placeholder="Search..." id="filesSearchInput">
                </div>
                <div class="files-view-toggle">
                    <button class="view-btn active" title="List view">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                    </button>
                    <button class="view-btn" title="Grid view">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Body / Table -->
        <div class="files-body">
            <table class="files-table" id="filesTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox"></th>
                        <th>Name</th>
                        <th>Last Activity</th>
                        <th>Recipients</th>
                        <th>Status</th>
                        <th style="width: 140px;"></th>
                    </tr>
                </thead>
                <tbody id="filesTableBody">
                    <!-- Files will be loaded dynamically -->
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div class="files-empty-state" id="filesEmpty" style="display: none;">
                <svg class="files-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <h3 class="files-empty-title">No files yet</h3>
                <p class="files-empty-desc">Upload files or save reports from your research.</p>
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="files-pagination">
            <div class="pagination-info">
                <select style="padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.8125rem;">
                    <option>10 Documents</option>
                    <option>25 Documents</option>
                    <option>50 Documents</option>
                </select>
            </div>
            <div class="pagination-controls">
                <div class="pagination-pages">
                    <button class="page-btn active">1</button>
                    <button class="page-btn">2</button>
                    <button class="page-btn">3</button>
                    <span style="color: #9ca3af;">...</span>
                    <button class="page-btn">8</button>
                    <button class="page-btn">9</button>
                    <button class="page-btn">10</button>
                </div>
                <button class="page-btn nav" disabled>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <button class="page-btn nav">
                    Next
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>



    <!-- Prompt Guide Handbook Modal -->
    <div class="handbook-overlay" id="promptGuideOverlay" onclick="closePromptGuideOnOverlay(event)">
        <div class="handbook-container">
            <!-- Close Button -->
            <button class="handbook-close" onclick="closePromptGuide()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <div class="handbook-book">
                <!-- Book Spine -->
                <div class="handbook-spine">
                    <div class="spine-decoration"></div>
                    <span class="spine-text">Prompt Guide</span>
                    <div class="spine-decoration"></div>
                </div>
                
                <!-- Pages Container -->
                <div class="handbook-pages">
                    <!-- Cover Page -->
                    <div class="handbook-page handbook-cover active" data-page="0">
                        <div class="cover-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <h1 class="cover-title">The Prompt Guide</h1>
                        <div class="cover-ornament"></div>
                        <p class="cover-subtitle">A Comprehensive Handbook for Crafting Effective AI Research Queries</p>
                        <div class="cover-ornament"></div>
                        <p class="cover-edition">First Edition</p>
                        <p class="cover-year">Leaf Intelligence</p>
                    </div>
                    
                    <!-- Page 1: Introduction -->
                    <div class="handbook-page" data-page="1">
                        <div class="page-header">
                            <div class="page-chapter">Chapter I</div>
                            <h2 class="page-title">The Art of Inquiry</h2>
                            <p class="page-subtitle">Understanding how to communicate with AI</p>
                        </div>
                        <div class="page-content">
                            <p>Welcome to the Leaf Intelligence Prompt Guide. This handbook will teach you the principles of crafting effective queries that yield precise, comprehensive, and actionable research results.</p>
                            
                            <h3>Why Prompts Matter</h3>
                            <p>The quality of your question directly determines the quality of your answer. A well-crafted prompt acts as a precise instrument, cutting through vast knowledge bases to extract exactly what you need.</p>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â‚¬Å¾Ã‚Â¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¡</span>
                                <div class="handbook-tip-content">
                                    Think of prompting as giving directions to a highly capable research assistant. The clearer your directions, the better the results.
                                </div>
                            </div>
                            
                            <h3>The Golden Rules</h3>
                            <ul>
                                <li><strong>Be Specific</strong> ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â Vague questions yield vague answers</li>
                                <li><strong>Provide Context</strong> ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â Help the AI understand your situation</li>
                                <li><strong>State Your Goal</strong> ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â What do you want to accomplish?</li>
                                <li><strong>Choose the Right Depth</strong> ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â Quick Search vs Deep Research</li>
                            </ul>
                        </div>
                        <div class="page-number">1</div>
                    </div>
                    
                    <!-- Page 2: Quick Search -->
                    <div class="handbook-page" data-page="2">
                        <div class="page-header">
                            <div class="page-chapter">Chapter II</div>
                            <h2 class="page-title">Quick Search Mastery</h2>
                            <p class="page-subtitle">Fast answers for straightforward questions</p>
                        </div>
                        <div class="page-content">
                            <p>Quick Search is your go-to for factual queries, definitions, and straightforward regulatory questions. It scans the knowledge base rapidly and returns concise, accurate information in approximately 30 seconds.</p>
                            
                            <h3>When to Use Quick Search</h3>
                            <ul>
                                <li>Definitions and terminology</li>
                                <li>Specific regulatory requirements</li>
                                <li>Quick fact-checking</li>
                                <li>Simple procedural questions</li>
                            </ul>
                            
                            <div class="handbook-example">
                                <p><strong>Effective Quick Search Prompts:</strong></p>
                                <div class="example-good">What is the definition of a 505(b)(2) application?</div>
                                <div class="example-good">What are the FDA's requirements for biosimilar naming?</div>
                                <div class="example-good">What is the timeline for EMA's centralized procedure?</div>
                            </div>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¡</span>
                                <div class="handbook-tip-content">
                                    Quick Search works best with direct questions that have definitive answers. Save complex analysis for Deep Research.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">2</div>
                    </div>
                    
                    <!-- Page 3: Deep Research -->
                    <div class="handbook-page" data-page="3">
                        <div class="page-header">
                            <div class="page-chapter">Chapter III</div>
                            <h2 class="page-title">Deep Research Excellence</h2>
                            <p class="page-subtitle">Comprehensive analysis for complex questions</p>
                        </div>
                        <div class="page-content">
                            <p>Deep Research is designed for complex regulatory questions that require multi-source analysis, comparative studies, and thorough examination. Allow approximately 10 minutes for comprehensive results.</p>
                            
                            <h3>When to Use Deep Research</h3>
                            <ul>
                                <li>Regulatory pathway comparisons</li>
                                <li>Strategic development questions</li>
                                <li>Complex compliance analysis</li>
                                <li>Multi-jurisdictional requirements</li>
                            </ul>
                            
                            <div class="handbook-example">
                                <p><strong>Effective Deep Research Prompts:</strong></p>
                                <div class="example-good">Compare the FDA and EMA approval pathways for cell and gene therapies, including timeline differences and key requirements.</div>
                                <div class="example-good">What are the strategic considerations for choosing between a 505(b)(1) and 505(b)(2) pathway for a modified-release formulation?</div>
                            </div>
                            
                            <h3>Structuring Complex Queries</h3>
                            <p>For best results, break down your question into clear components: What do you need to know? Why? What will you do with the information?</p>
                        </div>
                        <div class="page-number">3</div>
                    </div>
                    
                    <!-- Page 4: Prompt Formulas -->
                    <div class="handbook-page" data-page="4">
                        <div class="page-header">
                            <div class="page-chapter">Chapter IV</div>
                            <h2 class="page-title">Proven Prompt Formulas</h2>
                            <p class="page-subtitle">Templates for consistent results</p>
                        </div>
                        <div class="page-content">
                            <h3>The Context + Question Formula</h3>
                            <p>Provide relevant background before your question to get tailored responses.</p>
                            <div class="handbook-example">
                                <div class="example-good">"We're developing a biosimilar to [reference product]. What are the FDA's requirements for demonstrating interchangeability?"</div>
                            </div>
                            
                            <h3>The Comparison Formula</h3>
                            <p>When comparing options, specify what aspects matter to you.</p>
                            <div class="handbook-example">
                                <div class="example-good">"Compare expedited FDA pathways (Fast Track, Breakthrough, Accelerated Approval) for oncology drugs in terms of eligibility criteria and benefits."</div>
                            </div>
                            
                            <h3>The Checklist Formula</h3>
                            <p>Ask for structured, actionable outputs.</p>
                            <div class="handbook-example">
                                <div class="example-good">"What documentation is required for a pre-IND meeting request? Please provide as a checklist."</div>
                            </div>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¹</span>
                                <div class="handbook-tip-content">
                                    Specifying your desired output format (checklist, comparison table, summary) helps focus the response.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">4</div>
                    </div>
                    
                    <!-- Page 5: Common Mistakes -->
                    <div class="handbook-page" data-page="5">
                        <div class="page-header">
                            <div class="page-chapter">Chapter V</div>
                            <h2 class="page-title">Common Pitfalls</h2>
                            <p class="page-subtitle">Mistakes to avoid in your queries</p>
                        </div>
                        <div class="page-content">
                            <h3>Pitfall #1: Being Too Vague</h3>
                            <div class="handbook-example">
                                <div class="example-bad">Tell me about FDA regulations.</div>
                                <div class="example-good">What are the FDA's CMC requirements for monoclonal antibody products?</div>
                            </div>
                            
                            <h3>Pitfall #2: Assuming Context</h3>
                            <div class="handbook-example">
                                <div class="example-bad">What's the timeline?</div>
                                <div class="example-good">What is the typical FDA review timeline for a standard BLA submission?</div>
                            </div>
                            
                            <h3>Pitfall #3: Multiple Unrelated Questions</h3>
                            <div class="handbook-example">
                                <div class="example-bad">What's a 510(k) and also tell me about European MDR and what's pharmacovigilance?</div>
                                <div class="example-good">Ask each question separately for focused, detailed answers.</div>
                            </div>
                            
                            <h3>Pitfall #4: Wrong Research Depth</h3>
                            <p>Using Quick Search for complex strategic questions, or Deep Research for simple definitions, wastes time and reduces quality.</p>
                        </div>
                        <div class="page-number">5</div>
                    </div>
                    
                    <!-- Page 6: Advanced Techniques -->
                    <div class="handbook-page" data-page="6">
                        <div class="page-header">
                            <div class="page-chapter">Chapter VI</div>
                            <h2 class="page-title">Advanced Techniques</h2>
                            <p class="page-subtitle">Elevating your research mastery</p>
                        </div>
                        <div class="page-content">
                            <h3>Follow-up Questions</h3>
                            <p>Build on previous answers to dive deeper. The AI remembers your conversation context.</p>
                            <div class="handbook-example">
                                <div class="example-good">Initial: "What is the Breakthrough Therapy designation?"</div>
                                <div class="example-good">Follow-up: "What clinical evidence is typically needed to qualify?"</div>
                            </div>
                            
                            <h3>Scenario-Based Queries</h3>
                            <p>Present hypothetical situations for strategic guidance.</p>
                            <div class="handbook-example">
                                <div class="example-good">"If a Phase 2 trial shows promising efficacy but limited safety data, what regulatory strategies could accelerate development?"</div>
                            </div>
                            
                            <h3>Request Specific Formats</h3>
                            <ul>
                                <li>"Summarize in bullet points..."</li>
                                <li>"Create a comparison table..."</li>
                                <li>"Provide a step-by-step guide..."</li>
                                <li>"List the pros and cons..."</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â½ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¯</span>
                                <div class="handbook-tip-content">
                                    The more specific your request, the more useful the response. Don't hesitate to ask for exactly what you need.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">6</div>
                    </div>
                    
                    <!-- Page 7: Quick Reference -->
                    <div class="handbook-page" data-page="7">
                        <div class="page-header">
                            <div class="page-chapter">Reference</div>
                            <h2 class="page-title">Quick Reference Card</h2>
                            <p class="page-subtitle">Keep these principles at hand</p>
                        </div>
                        <div class="page-content">
                            <h3>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚ÂÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Quick Search (~30 seconds)</h3>
                            <ul>
                                <li>Definitions & terminology</li>
                                <li>Specific requirements</li>
                                <li>Factual questions</li>
                                <li>Simple procedures</li>
                            </ul>
                            
                            <h3>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â§ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â  Deep Research (~10 minutes)</h3>
                            <ul>
                                <li>Complex comparisons</li>
                                <li>Strategic analysis</li>
                                <li>Multi-source research</li>
                                <li>Comprehensive reviews</li>
                            </ul>
                            
                            <h3>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦ Prompt Checklist</h3>
                            <ul>
                                <li>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¹Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Is my question specific?</li>
                                <li>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¹Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Have I provided necessary context?</li>
                                <li>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¹Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Is my goal clear?</li>
                                <li>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¹Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Am I using the right research depth?</li>
                                <li>ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¹Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â Have I specified my desired format?</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¡</span>
                                <div class="handbook-tip-content">
                                    Practice makes perfect. The more you use Leaf Intelligence, the more intuitive effective prompting becomes.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">7</div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="handbook-nav">
                        <button class="handbook-nav-btn" id="prevPageBtn" onclick="prevHandbookPage()" disabled>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span>Previous</span>
                        </button>
                        
                        <div class="handbook-dots" id="handbookDots">
                            <!-- Dots generated by JS -->
                        </div>
                        
                        <button class="handbook-nav-btn" id="nextPageBtn" onclick="nextHandbookPage()">
                            <span>Next</span>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Handbook -->
    <div class="handbook-overlay" id="privacyGuideOverlay" onclick="closePrivacyGuideOnOverlay(event)">
        <div class="handbook-container">
            <!-- Close Button -->
            <button class="handbook-close" onclick="closePrivacyGuide()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <div class="handbook-book">
                <!-- Book Spine -->
                <div class="handbook-spine">
                    <div class="spine-decoration"></div>
                    <span class="spine-text">Privacy Policy</span>
                    <div class="spine-decoration"></div>
                </div>
                
                <!-- Pages Container -->
                <div class="handbook-pages">
                    <!-- Cover Page -->
                    <div class="handbook-page handbook-cover active" data-page="0">
                        <div class="cover-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                        <h1 class="cover-title">Privacy Policy</h1>
                        <div class="cover-ornament"></div>
                        <p class="cover-subtitle">Our Commitment to Protecting Your Data</p>
                        <div class="cover-ornament"></div>
                        <p class="cover-edition">Effective Date: December 2024</p>
                        <p class="cover-year">Leaf Intelligence</p>
                    </div>
                    
                    <!-- Page 1: Introduction -->
                    <div class="handbook-page" data-page="1">
                        <div class="page-header">
                            <div class="page-chapter">Chapter I</div>
                            <h2 class="page-title">Introduction</h2>
                            <p class="page-subtitle">Our approach to your privacy</p>
                        </div>
                        <div class="page-content">
                            <p>At Leaf Intelligence, we take your privacy seriously. This policy explains how we collect, use, protect, and share information when you use our AI-powered regulatory intelligence platform.</p>
                            
                            <h3>Our Core Principles</h3>
                            <ul>
                                <li><strong>Transparency</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ We're clear about what data we collect and why</li>
                                <li><strong>Control</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ You decide how your data is used</li>
                                <li><strong>Security</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ We protect your information with industry-leading practices</li>
                                <li><strong>Compliance</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ We follow all applicable privacy laws and regulations</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢</span>
                                <div class="handbook-tip-content">
                                    Your research queries and documents are encrypted both in transit and at rest. We never sell your personal information to third parties.
                                </div>
                            </div>
                            
                            <h3>What This Policy Covers</h3>
                            <p>This privacy policy applies to all users of Leaf Intelligence's web platform, including free and paid subscribers. It covers both personal information and research data you provide while using our services.</p>
                        </div>
                        <div class="page-number">1</div>
                    </div>
                    
                    <!-- Page 2: Data Collection -->
                    <div class="handbook-page" data-page="2">
                        <div class="page-header">
                            <div class="page-chapter">Chapter II</div>
                            <h2 class="page-title">Information We Collect</h2>
                            <p class="page-subtitle">What data we gather and why</p>
                        </div>
                        <div class="page-content">
                            <h3>Account Information</h3>
                            <p>When you create an account, we collect:</p>
                            <ul>
                                <li>Name and email address</li>
                                <li>Company or organization name</li>
                                <li>Professional role and industry</li>
                                <li>Payment information (processed securely by our payment provider)</li>
                            </ul>
                            
                            <h3>Research Data</h3>
                            <p>To provide our AI research services, we collect:</p>
                            <ul>
                                <li>Search queries and prompts</li>
                                <li>Documents you upload for analysis</li>
                                <li>Research preferences and saved searches</li>
                                <li>Conversation history with our AI assistant</li>
                            </ul>
                            
                            <h3>Usage Information</h3>
                            <ul>
                                <li>Device and browser information</li>
                                <li>IP address and location data</li>
                                <li>Feature usage patterns and analytics</li>
                                <li>Error reports and performance metrics</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢Ãƒâ€šÃ‚Â¡</span>
                                <div class="handbook-tip-content">
                                    We use usage data to improve our service, fix bugs, and develop new features that better serve your research needs.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">2</div>
                    </div>
                    
                    <!-- Page 3: How We Use Your Data -->
                    <div class="handbook-page" data-page="3">
                        <div class="page-header">
                            <div class="page-chapter">Chapter III</div>
                            <h2 class="page-title">How We Use Your Information</h2>
                            <p class="page-subtitle">The purposes behind data collection</p>
                        </div>
                        <div class="page-content">
                            <h3>Providing Our Services</h3>
                            <p>Your data enables us to:</p>
                            <ul>
                                <li>Process and respond to your research queries</li>
                                <li>Maintain your account and conversation history</li>
                                <li>Provide customer support and technical assistance</li>
                                <li>Send service updates and important notifications</li>
                            </ul>
                            
                            <h3>Improving Our Platform</h3>
                            <p>We analyze aggregated, anonymized data to:</p>
                            <ul>
                                <li>Enhance AI model performance and accuracy</li>
                                <li>Identify and fix technical issues</li>
                                <li>Develop new features and capabilities</li>
                                <li>Optimize user experience and interface design</li>
                            </ul>
                            
                            <h3>Research and Development</h3>
                            <p>We may use anonymized research queries to train and improve our AI models, ensuring better regulatory intelligence for all users. Individual queries are never shared or made identifiable.</p>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡Ãƒâ€šÃ‚Â¡</span>
                                <div class="handbook-tip-content">
                                    You can opt out of having your anonymized data used for model training in your account settings at any time.
                                </div>
                            </div>
                        </div>
                        <div class="page-number">3</div>
                    </div>
                    
                    <!-- Page 4: Data Sharing -->
                    <div class="handbook-page" data-page="4">
                        <div class="page-header">
                            <div class="page-chapter">Chapter IV</div>
                            <h2 class="page-title">Information Sharing</h2>
                            <p class="page-subtitle">When and how we share data</p>
                        </div>
                        <div class="page-content">
                            <h3>We Never Sell Your Data</h3>
                            <p>Leaf Intelligence does not and will not sell your personal information or research data to third parties. Your trust is paramount to our business.</p>
                            
                            <h3>Service Providers</h3>
                            <p>We share limited data with trusted partners who help us operate our platform:</p>
                            <ul>
                                <li><strong>Cloud Infrastructure</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Secure data storage and processing</li>
                                <li><strong>Payment Processors</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Billing and subscription management</li>
                                <li><strong>Analytics Services</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Anonymized usage statistics</li>
                                <li><strong>Customer Support Tools</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Help desk and ticketing systems</li>
                            </ul>
                            
                            <p>All service providers are contractually bound to protect your data and use it only for specified purposes.</p>
                            
                            <h3>Legal Requirements</h3>
                            <p>We may disclose information when required by law, such as:</p>
                            <ul>
                                <li>Court orders or legal proceedings</li>
                                <li>Compliance with regulatory requirements</li>
                                <li>Protecting our rights and property</li>
                                <li>Preventing fraud or security threats</li>
                            </ul>
                        </div>
                        <div class="page-number">4</div>
                    </div>
                    
                    <!-- Page 5: Data Security -->
                    <div class="handbook-page" data-page="5">
                        <div class="page-header">
                            <div class="page-chapter">Chapter V</div>
                            <h2 class="page-title">Security Measures</h2>
                            <p class="page-subtitle">How we protect your information</p>
                        </div>
                        <div class="page-content">
                            <h3>Technical Safeguards</h3>
                            <ul>
                                <li><strong>Encryption</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ TLS/SSL for data in transit, AES-256 for data at rest</li>
                                <li><strong>Access Controls</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Role-based permissions and multi-factor authentication</li>
                                <li><strong>Network Security</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Firewalls, intrusion detection, and monitoring</li>
                                <li><strong>Regular Audits</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Security assessments and penetration testing</li>
                            </ul>
                            
                            <h3>Organizational Practices</h3>
                            <ul>
                                <li>Limited employee access to user data</li>
                                <li>Comprehensive security training programs</li>
                                <li>Incident response and breach notification procedures</li>
                                <li>Secure development lifecycle practices</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂºÃƒâ€šÃ‚Â¡ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â</span>
                                <div class="handbook-tip-content">
                                    We maintain SOC 2 Type II compliance and undergo regular independent security audits to ensure the highest standards of data protection.
                                </div>
                            </div>
                            
                            <h3>Your Responsibility</h3>
                            <p>Please help us keep your account secure by using strong passwords, enabling two-factor authentication, and never sharing your credentials.</p>
                        </div>
                        <div class="page-number">5</div>
                    </div>
                    
                    <!-- Page 6: Your Rights -->
                    <div class="handbook-page" data-page="6">
                        <div class="page-header">
                            <div class="page-chapter">Chapter VI</div>
                            <h2 class="page-title">Your Privacy Rights</h2>
                            <p class="page-subtitle">Control over your personal data</p>
                        </div>
                        <div class="page-content">
                            <h3>Access and Portability</h3>
                            <p>You have the right to:</p>
                            <ul>
                                <li>Request a copy of your personal data</li>
                                <li>Export your research history and documents</li>
                                <li>Receive your data in a machine-readable format</li>
                            </ul>
                            
                            <h3>Correction and Updates</h3>
                            <ul>
                                <li>Update your account information at any time</li>
                                <li>Correct inaccurate personal data</li>
                                <li>Modify your communication preferences</li>
                            </ul>
                            
                            <h3>Deletion and Restriction</h3>
                            <ul>
                                <li>Request deletion of your account and associated data</li>
                                <li>Opt out of analytics and model training</li>
                                <li>Restrict processing of your information</li>
                            </ul>
                            
                            <div class="handbook-tip">
                                <span class="handbook-tip-icon">ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€šÃ‚Â§</span>
                                <div class="handbook-tip-content">
                                    To exercise any of these rights, contact us at privacy@leafintelligence.com. We'll respond within 30 days.
                                </div>
                            </div>
                            
                            <h3>California and EU Rights</h3>
                            <p>If you're in California (CCPA) or the EU (GDPR), you have additional rights including the right to object to processing and file complaints with supervisory authorities.</p>
                        </div>
                        <div class="page-number">6</div>
                    </div>
                    
                    <!-- Page 7: Additional Information -->
                    <div class="handbook-page" data-page="7">
                        <div class="page-header">
                            <div class="page-chapter">Chapter VII</div>
                            <h2 class="page-title">Additional Information</h2>
                            <p class="page-subtitle">Cookies, retention, and updates</p>
                        </div>
                        <div class="page-content">
                            <h3>Cookies and Tracking</h3>
                            <p>We use cookies and similar technologies for:</p>
                            <ul>
                                <li>Session management and authentication</li>
                                <li>User preferences and settings</li>
                                <li>Analytics and performance monitoring</li>
                                <li>Security and fraud prevention</li>
                            </ul>
                            <p>You can control cookies through your browser settings, though some features may not work properly if disabled.</p>
                            
                            <h3>Data Retention</h3>
                            <ul>
                                <li><strong>Active Accounts</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Data retained as long as account is active</li>
                                <li><strong>Closed Accounts</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Most data deleted within 90 days</li>
                                <li><strong>Legal Requirements</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Some data retained for compliance (typically 7 years)</li>
                                <li><strong>Anonymized Data</strong> ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ May be retained indefinitely for analytics</li>
                            </ul>
                            
                            <h3>Policy Updates</h3>
                            <p>We may update this privacy policy periodically. We'll notify you of significant changes via email and in-app notifications. Continued use after changes constitutes acceptance.</p>
                            
                            <h3>Contact Us</h3>
                            <p><strong>Email:</strong> privacy@leafintelligence.com<br>
                            <strong>Mail:</strong> Leaf Intelligence Privacy Team, [Your Address]</p>
                        </div>
                        <div class="page-number">7</div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="handbook-nav">
                        <button class="handbook-nav-btn" id="privacyPrevPageBtn" onclick="prevPrivacyPage()" disabled>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span>Previous</span>
                        </button>
                        
                        <div class="handbook-dots" id="privacyHandbookDots">
                            <!-- Dots generated by JS -->
                        </div>
                        
                        <button class="handbook-nav-btn" id="privacyNextPageBtn" onclick="nextPrivacyPage()">
                            <span>Next</span>
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] hidden items-center justify-center" id="shareModal" onclick="closeShareModal(event)">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all" onclick="event.stopPropagation()">
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-white font-medium text-lg">Share Conversation</h3>
                    <button onclick="closeShareModal()" class="text-white/80 hover:text-white transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="p-6">
                <!-- Share Link -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Share Link</label>
                    <div class="flex gap-2">
                        <input type="text" id="shareLink" value="https://leaf.ai/chat/abc123xyz" readonly 
                               class="flex-1 px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600 focus:outline-none">
                        <button onclick="copyShareLink()" class="px-4 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                </div>
                
                <!-- Share Options -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Share via</label>
                    <div class="grid grid-cols-4 gap-3">
                        <button onclick="shareVia('email')" class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600">Email</span>
                        </button>
                        <button onclick="shareVia('slack')" class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                                <svg class="w-5 h-5 text-purple-600" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600">Slack</span>
                        </button>
                        <button onclick="shareVia('teams')" class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                            <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
                                <svg class="w-5 h-5 text-indigo-600" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.625 8.073h-5.27V5.674a2.548 2.548 0 0 0-2.548-2.549h-3.89a2.548 2.548 0 0 0-2.549 2.549v2.399H.375v11.802a2.548 2.548 0 0 0 2.549 2.549h15.152a2.548 2.548 0 0 0 2.549-2.549V8.073zm-10.71-2.399a.637.637 0 0 1 .637-.637h2.896a.637.637 0 0 1 .637.637v2.399h-4.17V5.674z"/>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600">Teams</span>
                        </button>
                        <button onclick="shareVia('download')" class="flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-colors group">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center group-hover:bg-gray-200 transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </div>
                            <span class="text-xs text-gray-600">Export</span>
                        </button>
                    </div>
                </div>
                
                <!-- Access Control -->
                <div class="border-t border-gray-100 pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Who can access</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="access" value="anyone" class="w-4 h-4 text-emerald-500 focus:ring-emerald-500">
                            <div>
                                <p class="text-sm font-medium text-gray-800">Anyone with the link</p>
                                <p class="text-xs text-gray-500">Anyone can view this conversation</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="access" value="team" checked class="w-4 h-4 text-emerald-500 focus:ring-emerald-500">
                            <div>
                                <p class="text-sm font-medium text-gray-800">Team members only</p>
                                <p class="text-xs text-gray-500">Only people in your organization</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>


<!-- Account Management Modal -->
<div class="account-modal-overlay" id="accountModalOverlay" onclick="if(event.target === this) LeafAccount.closeModal()">
    <div class="account-modal">
        <!-- Header -->
        <div class="account-modal-header">
            <h2 class="account-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Account Settings
            </h2>
            <button class="account-modal-close" onclick="LeafAccount.closeModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Navigation Tabs -->
        <div class="account-modal-nav">
            <div class="account-nav-tab active" onclick="LeafAccount.switchTab('profile')" data-tab="profile">Profile</div>
            <div class="account-nav-tab" onclick="LeafAccount.switchTab('security')" data-tab="security">Security</div>
            <div class="account-nav-tab" onclick="LeafAccount.switchTab('sessions')" data-tab="sessions">Sessions</div>
            <div class="account-nav-tab" onclick="LeafAccount.switchTab('usage')" data-tab="usage">Usage</div>
        </div>

        <!-- Modal Body -->
        <div class="account-modal-body">
            <!-- Profile Section -->
            <div class="account-section active" id="accountSectionProfile">
                <div class="account-user-header">
                    <div class="account-avatar-large" id="accountAvatarLarge">U</div>
                    <div class="account-user-details">
                        <h3 id="accountFullName">User Name</h3>
                        <p id="accountEmail">user@example.com</p>
                        <span class="badge">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Active Account
                        </span>
                    </div>
                </div>

                <form id="profileForm" onsubmit="LeafAccount.saveProfile(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="accountFirstName" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="accountLastName" placeholder="Doe">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" class="form-input" id="accountEmailInput" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Company / Organization</label>
                        <input type="text" class="form-input" id="accountCompany" placeholder="Acme Pharma">
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn-secondary" onclick="LeafAccount.closeModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>

            <!-- Security Section -->
            <div class="account-section" id="accountSectionSecurity">
                <h3 style="font-weight: 600; margin-bottom: 20px;">Change Password</h3>
                <form id="passwordForm" onsubmit="LeafAccount.changePassword(event)">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="currentPassword" placeholder="ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢">
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="newPassword" placeholder="ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmNewPassword" placeholder="ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢">
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">Update Password</button>
                </form>

                <hr style="margin: 32px 0; border: none; border-top: 1px solid #e5e7eb;">

                <h3 style="font-weight: 600; margin-bottom: 12px; color: #dc2626;">Danger Zone</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 16px;">
                    Once you delete your account, there is no going back. Please be certain.
                </p>
                <button class="btn-danger" onclick="LeafAccount.deleteAccount()">Delete Account</button>
            </div>

            <!-- Sessions Section -->
            <div class="account-section" id="accountSectionSessions">
                <h3 style="font-weight: 600; margin-bottom: 8px;">Active Sessions</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 20px;">
                    Manage your active sessions. You can revoke access from other devices.
                </p>
                <div id="sessionsList">
                    <!-- Sessions will be loaded here -->
                    <div class="conv-loading">
                        <div class="conv-loading-spinner">
                            <div class="conv-loading-dot"></div>
                            <div class="conv-loading-dot"></div>
                            <div class="conv-loading-dot"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Section -->
            <div class="account-section" id="accountSectionUsage">
                <h3 style="font-weight: 600; margin-bottom: 20px;">Usage Statistics</h3>
                <div id="usageStats">
                    <div class="usage-stat">
                        <span class="usage-stat-label">Total Queries</span>
                        <span class="usage-stat-value" id="statTotalQueries">0</span>
                    </div>
                    <div class="usage-stat">
                        <span class="usage-stat-label">This Month</span>
                        <span class="usage-stat-value" id="statMonthlyQueries">0</span>
                    </div>
                    <div class="usage-stat">
                        <span class="usage-stat-label">Total Conversations</span>
                        <span class="usage-stat-value" id="statTotalConversations">0</span>
                    </div>
                    <div class="usage-stat">
                        <span class="usage-stat-label">Member Since</span>
                        <span class="usage-stat-value" id="statMemberSince">-</span>
                    </div>
                </div>

                <div style="margin-top: 24px; padding: 16px; background: #f0fdf4; border-radius: 10px; border: 1px solid #a7f3d0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span style="font-weight: 600; color: #047857;">Pro Plan</span>
                    </div>
                    <p style="font-size: 0.875rem; color: #065f46;">Unlimited queries and all features enabled.</p>
                </div>
            </div>
        </div>

        <!-- Logout Button (fixed at bottom) -->
        <div style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
            <button onclick="LeafAccount.logout()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-weight: 500; color: #374151; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#fecaca'; this.style.color='#dc2626'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'; this.style.color='#374151'">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                Sign Out
            </button>
        </div>
    </div>
</div>



    <div class="app-container">
        <!-- Sidebar Overlay (for mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                 <div class="brand-container flex items-center gap-3 cursor-pointer group flex-shrink-0" onclick="displayAIDetails()">
                    <div class="logo-container relative">
                        <img src="leaf.png" alt="Leaf Intelligence" class="h-10 w-10 object-contain relative z-10 transition-transform duration-300 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-400 via-cyan-400 to-purple-400 opacity-30 blur-xl rounded-full glow-effect"></div>
                    </div>
                    
                    <div class="flex flex-col">
                        <span class="brand-text text-sm font-semibold bg-gradient-to-r from-emerald-600 via-teal-600 to-blue-600 bg-clip-text text-transparent whitespace-nowrap">
                            Leaf Intelligence
                        </span>
                        <div class="flex items-center gap-1">
                            <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                            <span class="text-xxs text-gray-500 font-medium">AI Research Platform</span>
                        </div>
                    </div>
                </div>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- New Conversation Button -->
                <div class="sidebar-section">
                    <div class="sidebar-item" onclick="clearChatHistory()" style="background: linear-gradient(135deg, #ecfdf5 0%, #eff6ff 100%); color: #059669;">
                        <svg class="sidebar-item-icon" style="color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>New Conversation</span>
                    </div>
                </div>
                   <!-- <button class="nav-item mt-3" onclick="navigateToExplore()">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span>Files</span>
            </button> -->
                  <button class="nav-item mb-5" onclick="navigateToLibrary()">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span>Prompt Library</span>
            </button>
             <!-- Replace the old sidebar-section with this -->
<!-- Replace the old sidebar-section with this -->
<div class="starter-section">
    <div class="starter-header">
        Conversations
        <span class="starter-header-action" id="viewAllConversations" onclick="LeafConversations.toggleViewAll()" style="display: none;">View all</span>
    </div>
    <div id="conversationsListContainer" class="conversations-limited">
        <!-- Conversations will be loaded here dynamically -->
        <div class="conv-loading">
            <div class="conv-loading-spinner">
                <div class="conv-loading-dot"></div>
                <div class="conv-loading-dot"></div>
                <div class="conv-loading-dot"></div>
            </div>
            <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 8px;">Loading conversations...</p>
        </div>
    </div>
</div>

<!-- Conversations icon for minimized state -->
<div class="conversations-minimized-icon" title="Conversations">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
</div>

                
            </div>

            <!-- Sidebar Footer - User Profile -->
        <div class="sidebar-footer" id="sidebarFooter">
    <!-- User Profile Button -->
    <div class="user-profile-enhanced" onclick="LeafAccount.openModal()">
        <div class="user-profile-avatar" id="sidebarUserAvatar">U</div>
        <div class="user-profile-info">
            <div class="user-profile-name" id="sidebarUserName">Loading...</div>
            <div class="user-profile-email" id="sidebarUserEmail">...</div>
        </div>
        <svg class="user-profile-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
        </svg>
    </div>
</div>
        
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper">
            <!-- Top Navbar -->
            <nav class="navbar">
                <div class="navbar-left">
                    <!-- Breadcrumb Trail -->
                    <div class="breadcrumb-trail" id="breadcrumbTrail">
                        <span class="breadcrumb-item brand">leaf AI</span>
                        <span class="breadcrumb-separator">/</span>
                        <div class="breadcrumb-dropdown" id="breadcrumbDropdown">
                            <span class="breadcrumb-current" id="currentChatName">New conversation</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Center - Logo -->
              
                <!-- Right Actions -->
                <div class=" navbar-right">
                  

                    <!-- Share Button -->
                    <button class="hidden navbar-btn" title="Share conversation" onclick="showShareModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                        </svg>
                        <!-- <span>Share</span> -->
                    </button>

                    <!-- New Conversation Button -->
                    <button class="navbar-btn navbar-btn-primary" onclick="clearChatHistory()" title="Start new conversation">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <!-- <span>New Conversation</span> -->
                    </button>

                  
                    
                </div>
            </nav>

            

 <!-- Content area with chat and results -->
    <div class="content-area " style="display: flex; flex: 1; overflow: hidden; justify-content: center; background:#ffffff ;" >
        
     <!-- Chat Container -->
            <div class="chat-wrapper" >
                <div id='chatdiv' >
                    <!-- Chat Content -->
                    <div id="chatContent" class=" transition-all w-full h-full overflow-y-scroll ">
                        <div class="seamless-card">
                            <div class="p-6">
                                <!-- Chat Messages Container -->
                                <div id="chatContainer" class="space-y-6">
                                    <!-- Messages will appear here -->
                                </div>
                            </div>
                            
                            <div id="emptyChatState" class="sidebar-empty-state">
                                <div id="placeholderMessage" class="rounded-lg w-full space-y-6 px-4 py-6">
                                    <div class="max-w-4xl mx-auto text-center">
                                        <div class="chat-welcome" id="chatWelcome">
                                            <div class="chat-logo-container">
                                                <div class="chat-logo-orb">
                        <img src="leaf.png" alt="Leaf Intelligence" class="h-20 w-20 object-contain relative z-10 transition-transform duration-300 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-400 via-cyan-400 to-purple-400 opacity-30 blur-xl rounded-full glow-effect"></div>
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-300 to-cyan-300 opacity-20 blur-2xl rounded-full scale-150"></div>
                       </div>
                                            </div>
                                            <h1 class="chat-welcome-greeting">Good Morning, <span id="chatGreetingName">User</span></h1>
                                            <p class="chat-welcome-subtitle">What's on <span class="highlight">your mind?</span></p>
                                        </div>
                                        
                                        <!-- Input Box -->
                                        <!-- <div id="initialInputBar">
                                            <div class="relative bg-white rounded-2xl border-2 border-gray-200 transition-all hover:border-gray-300 focus-within:border-blue-500 focus-within:shadow-lg">
                                                <div class="flex items-center gap-2 p-2">
                                                    <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center">
                                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                                        </svg>
                                                    </div>
                                                    
                                              
                                                    <textarea 
                                                        id="aiInputInitial" 
                                                        placeholder="Ask about FDA approvals, clinical trials, EMA regulations..."
                                                        class="flex-1 outline-none text-gray-800 placeholder-gray-400 bg-transparent text-sm py-2 resize-none min-h-[40px] max-h-[120px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent"
                                                        rows="1"
                                                        oninput="autoResize(this)"
                                                        onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitInitialQuery(); }"
                                                    ></textarea>
                                                    
                                                  
                                                    <div class="relative flex-shrink-0">
                                                        <button 
                                                            type="button"
                                                            id="reasoningDropdownInitial"
                                                            onclick="toggleReasoningDropdown('initial')"
                                                            class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors group border-2 border-orange-300 bg-orange-50 "
                                                            title="Select reasoning level (required)"
                                                        >
                                                            <div class="flex items-center gap-2">
                                                                <svg id="reasoningIconInitial" class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                </svg>
                                                                <div class="flex flex-col items-start">
                                                                    <span id="reasoningLabelInitial" class="text-xs font-medium text-orange-700">Level of Detail</span>
                                                                    <span id="reasoningSubtextInitial" class="text-xs text-gray-500 hidden"></span>
                                                                </div>
                                                            </div>
                                                            <svg class="w-4 h-4 text-gray-400 transition-transform" id="chevronInitial" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                        
                                                        <div id="reasoningMenuInitial" class="hidden absolute right-0 bottom-full mb-2 w-80 bg-white rounded-xl shadow-2xl border-2 border-gray-200 z-[9999]">
                                                            <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-purple-50">
                                                                <p class="text-sm font-medium text-gray-900">Choose Research Depth</p>
                                                                <p class="text-xs text-gray-600 mt-0.5">Select how thoroughly AI should analyze your query</p>
                                                            </div>
                                                            
                                                            <button onclick="selectReasoningLevel('initial', 'quick')" class="reasoning-option w-full text-left px-4 py-4 hover:bg-emerald-50 transition-colors flex items-start gap-3 group border-b border-gray-100">
                                                                <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center group-hover:bg-emerald-200 transition-colors">
                                                                    <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="flex-1">
                                                                    <div class="flex items-center gap-2 mb-1">
                                                                        <span class="font-medium text-gray-900">Quick Search</span>
                                                                        <span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full font-medium">~30 sec</span>
                                                                    </div>
                                                                    <p class="text-xs text-gray-600 leading-relaxed">Fast AI search across full knowledge base. Good for straightforward questions requiring 2-3 sources.</p>
                                                                </div>
                                                            </button>
                                                            
                                                            <button onclick="selectReasoningLevel('initial', 'deep')" class="reasoning-option w-full text-left px-4 py-4 hover:bg-purple-50 transition-colors flex items-start gap-3 group">
                                                                <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                                                                    <svg class="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="flex-1">
                                                                    <div class="flex items-center gap-2 mb-1">
                                                                        <span class="font-medium text-gray-900">Deep Research</span>
                                                                        <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full font-medium">~10 min</span>
                                                                    </div>
                                                                    <p class="text-xs text-gray-600 leading-relaxed">Comprehensive multi-source analysis with citations. Best for complex regulatory questions requiring detailed research.</p>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="w-px h-6 bg-gray-200"></div>
                                                    
                                                    <button 
                                                        onclick="submitInitialQuery()" 
class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-all shadow-[0_2px_8px_rgba(16,185,129,0.3)] flex items-center justify-center group"
                                                        title="Send message"
                                                    >
                                                          <svg class="w-5 h-5 transform group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                    </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div> -->

<div id="initialInputBar">
    <!-- File Preview Area -->
    <div id="filePreviewInitial" class="file-upload-preview">
        <!-- Files will be dynamically added here -->
    </div>
    
    <div class="relative bg-white rounded-2xl border-2 border-gray-200 transition-all hover:border-gray-300 focus-within:border-emerald-500 focus-within:shadow-lg upload-zone" id="initialUploadZone">
        <div class="flex items-center gap-2 p-2">
            <!-- Attachment Button -->
            <button type="button" class="attachment-btn" id="attachBtnInitial" onclick="triggerFileInput('initial')" title="Attach files">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
                <span class="attachment-badge" id="attachBadgeInitial" style="display: none;">0</span>
            </button>
            <input type="file" id="fileInputInitial" style="display: none;" multiple onchange="handleFileSelect(event, 'initial')">
            
            <!-- Input Field -->
            <textarea 
                id="aiInputInitial" 
                placeholder="Ask about FDA approvals, clinical trials, EMA regulations..."
                class="flex-1 outline-none text-gray-800 placeholder-gray-400 bg-transparent text-sm py-2 resize-none min-h-[40px] max-h-[120px] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent"
                rows="1"
                oninput="autoResize(this)"
                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitInitialQuery(); }"
            ></textarea>
            
            <!-- Reasoning Level Selector (keep existing) -->
                                                            <div class="relative flex-shrink-0">
                                                        <button 
                                                            type="button"
                                                            id="reasoningDropdownInitial"
                                                            onclick="toggleReasoningDropdown('initial')"
                                                            class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors group border-2 border-orange-300 bg-orange-50 "
                                                            title="Select reasoning level (required)"
                                                        >
                                                            <div class="flex items-center gap-2">
                                                                <svg id="reasoningIconInitial" class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                </svg>
                                                                <div class="flex flex-col items-start">
                                                                    <span id="reasoningLabelInitial" class="text-xs font-medium text-orange-700">Level of Detail</span>
                                                                    <span id="reasoningSubtextInitial" class="text-xs text-gray-500 hidden"></span>
                                                                </div>
                                                            </div>
                                                            <svg class="w-4 h-4 text-gray-400 transition-transform" id="chevronInitial" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                            </svg>
                                                        </button>
                                                        
                                                        <div id="reasoningMenuInitial" class="hidden absolute right-0 bottom-full mb-2 w-80 bg-white rounded-xl shadow-2xl border-2 border-gray-200 z-[9999]">
                                                            <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-purple-50">
                                                                <p class="text-sm font-medium text-gray-900">Choose Research Depth</p>
                                                                <p class="text-xs text-gray-600 mt-0.5">Select how thoroughly AI should analyze your query</p>
                                                            </div>
                                                            
                                                            <button onclick="selectReasoningLevel('initial', 'quick')" class="reasoning-option w-full text-left px-4 py-4 hover:bg-emerald-50 transition-colors flex items-start gap-3 group border-b border-gray-100">
                                                                <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center group-hover:bg-emerald-200 transition-colors">
                                                                    <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="flex-1">
                                                                    <div class="flex items-center gap-2 mb-1">
                                                                        <span class="font-medium text-gray-900">Quick Search</span>
                                                                        <span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full font-medium">~30 sec</span>
                                                                    </div>
                                                                    <p class="text-xs text-gray-600 leading-relaxed">Fast AI search across full knowledge base. Good for straightforward questions requiring 2-3 sources.</p>
                                                                </div>
                                                            </button>
                                                            
                                                            <button onclick="selectReasoningLevel('initial', 'deep')" class="reasoning-option w-full text-left px-4 py-4 hover:bg-purple-50 transition-colors flex items-start gap-3 group">
                                                                <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                                                                    <svg class="w-6 h-6 text-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                                    </svg>
                                                                </div>
                                                                <div class="flex-1">
                                                                    <div class="flex items-center gap-2 mb-1">
                                                                        <span class="font-medium text-gray-900">Deep Research</span>
                                                                        <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full font-medium">~10 min</span>
                                                                    </div>
                                                                    <p class="text-xs text-gray-600 leading-relaxed">Comprehensive multi-source analysis with citations. Best for complex regulatory questions requiring detailed research.</p>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </div>
            
            <!-- Divider -->
            <div class="w-px h-6 bg-gray-200"></div>
            
            <!-- Send Button -->
            <button 
                onclick="submitInitialQuery()" 
                class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-all shadow-[0_2px_8px_rgba(16,185,129,0.3)] flex items-center justify-center group"
                title="Send message"
            >
                <svg class="w-5 h-5 transform group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Optional: Drag & Drop Zone Below Input -->
    <div id="initialDragDropZone" class="initial-upload-zone" onclick="triggerFileInput('initial')" style="display: none;">
        <div class="upload-zone-content">
            <div class="upload-zone-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
            </div>
            <div class="upload-zone-text">
                <h4><span>Click to Upload</span> or drag and drop</h4>
                <p>Max. File size: 25 MB</p>
            </div>
            <div class="upload-supported-types">
                <span class="file-type-pill">📄 Documents</span>
                <span class="file-type-pill">📊 Spreadsheets</span>
                <span class="file-type-pill">🖼 Images</span>
                <span class="file-type-pill">🎵 Audio</span>
                <span class="file-type-pill">🎥 Video</span>
            </div>
        </div>
    </div>
</div>
                                        
                                        <!-- Example Pills -->
                                        <div class="mt-6 flex flex-wrap gap-2 justify-center text-xs" id="examplepils">
                                            <button onclick="showPromptGuide()" class="px-4 py-2 bg-gradient-to-r from-amber-50 to-orange-50 hover:from-amber-100 hover:to-orange-100 text-amber-800 rounded-lg transition-all hover:shadow-sm border border-amber-200 flex items-center gap-1.5">
                                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                                </svg>
                                                Prompt Guide
                                            </button>
                                        </div>
       
        </div>
        
    </div>
    
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Continuous Chat Input 
                        <div id="continuousChatInput" style="display: none; " class="input-bar-container">
                            <div class="input-bar-wrapper">
                                <div class="input-bar">
                                    <button type="button" class="input-action-btn" title="Attach file" onclick="document.getElementById('fileInputContinuous').click()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                                        </svg>
                                    </button>
                                    <input type="file" id="fileInputContinuous" style="display: none;" multiple>
                                    
                                    <textarea 
                                        id="aiInputContinuous" 
                                        placeholder="Ask a follow-up question..."
                                        rows="1"
                                        oninput="autoResize(this)"
                                        onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitContinuousQuery(); }"
                                    ></textarea>
                                    
                                    <div class="relative flex-shrink-0">
                                        <button 
                                            type="button"
                                            id="reasoningDropdownContinuous"
                                            onclick="toggleReasoningDropdown('continuous')"
                                            class="reasoning-selector"
                                            title="Select reasoning level"
                                        >
                                            <svg id="reasoningIconContinuous" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            <span id="reasoningLabelContinuous">Quick</span>
                                            <svg class="chevron-icon" id="chevronContinuous" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        
                                        <div id="reasoningMenuContinuous" class="hidden reasoning-dropdown">
                                            <div class="reasoning-dropdown-header">
                                                <p class="text-sm font-medium text-gray-900">Choose Research Depth</p>
                                                <p class="text-xs text-gray-600 mt-0.5">Select analysis level</p>
                                            </div>
                                            
                                            <button onclick="selectReasoningLevel('continuous', 'quick')" class="reasoning-option">
                                                <div class="reasoning-option-icon quick">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                    </svg>
                                                </div>
                                                <div class="reasoning-option-content">
                                                    <div class="reasoning-option-title">
                                                        <span>Quick Search</span>
                                                        <span class="reasoning-time quick">~30s</span>
                                                    </div>
                                                    <p class="reasoning-option-desc">Fast AI-powered search across knowledge base.</p>
                                                </div>
                                            </button>
                                            
                                            <button onclick="selectReasoningLevel('continuous', 'deep')" class="reasoning-option">
                                                <div class="reasoning-option-icon deep">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                    </svg>
                                                </div>
                                                <div class="reasoning-option-content">
                                                    <div class="reasoning-option-title">
                                                        <span>Deep Research</span>
                                                        <span class="reasoning-time deep">~10m</span>
                                                    </div>
                                                    <p class="reasoning-option-desc">Comprehensive multi-source analysis with citations.</p>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <button onclick="submitContinuousQuery()" type="button" class="send-btn" title="Send message">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div> -->
<div id="continuousChatInput" style="display: none;" class="input-bar-container">
    <div class="input-bar-wrapper">
        <!-- File Preview Area -->
        <div id="filePreviewContinuous" class="file-upload-preview">
            <!-- Files will be dynamically added here -->
        </div>
        
        <div class="input-bar upload-zone" id="continuousUploadZone">
            <!-- Attachment Button -->
            <button type="button" class="attachment-btn" id="attachBtnContinuous" onclick="triggerFileInput('continuous')" title="Attach files">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                </svg>
                <span class="attachment-badge" id="attachBadgeContinuous" style="display: none;">0</span>
            </button>
            <input type="file" id="fileInputContinuous" style="display: none;" multiple onchange="handleFileSelect(event, 'continuous')">
            
            <!-- Text Input -->
            <textarea 
                id="aiInputContinuous" 
                placeholder="Ask a follow-up question..."
                rows="1"
                oninput="autoResize(this)"
                onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitContinuousQuery(); }"
            ></textarea>
            
              <div class="relative flex-shrink-0">
                                        <button 
                                            type="button"
                                            id="reasoningDropdownContinuous"
                                            onclick="toggleReasoningDropdown('continuous')"
                                            class="reasoning-selector"
                                            title="Select reasoning level"
                                        >
                                            <svg id="reasoningIconContinuous" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                            <span id="reasoningLabelContinuous">Quick</span>
                                            <svg class="chevron-icon" id="chevronContinuous" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        
                                        <div id="reasoningMenuContinuous" class="hidden reasoning-dropdown">
                                            <div class="reasoning-dropdown-header">
                                                <p class="text-sm font-medium text-gray-900">Choose Research Depth</p>
                                                <p class="text-xs text-gray-600 mt-0.5">Select analysis level</p>
                                            </div>
                                            
                                            <button onclick="selectReasoningLevel('continuous', 'quick')" class="reasoning-option">
                                                <div class="reasoning-option-icon quick">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                                    </svg>
                                                </div>
                                                <div class="reasoning-option-content">
                                                    <div class="reasoning-option-title">
                                                        <span>Quick Search</span>
                                                        <span class="reasoning-time quick">~30s</span>
                                                    </div>
                                                    <p class="reasoning-option-desc">Fast AI-powered search across knowledge base.</p>
                                                </div>
                                            </button>
                                            
                                            <button onclick="selectReasoningLevel('continuous', 'deep')" class="reasoning-option">
                                                <div class="reasoning-option-icon deep">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                                    </svg>
                                                </div>
                                                <div class="reasoning-option-content">
                                                    <div class="reasoning-option-title">
                                                        <span>Deep Research</span>
                                                        <span class="reasoning-time deep">~10m</span>
                                                    </div>
                                                    <p class="reasoning-option-desc">Comprehensive multi-source analysis with citations.</p>
                                                </div>
                                            </button>
                                        </div>
                                    </div>
            
            <!-- Send Button -->
            <button onclick="submitContinuousQuery()" type="button" class="send-btn" title="Send message">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

                                  <div class=" bg-white px-6 py-2">
                <div class="max-w-4xl mx-auto">
                    <p class="text-xs text-gray-500 text-center mb-3">
                        Leaf AI can make mistakes. Your data is not used to train AI models.
                    </p>
                    <!-- <div class="flex items-center justify-center gap-4 text-xs">
                        
                       
                        <a href="#" onclick="showPrivacyGuide(); return false;" class="flex items-center gap-1.5 text-gray-600 hover:text-gray-900 hover:underline transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Privacy Guide
                        </a>
                    </div> -->
                </div>
            </div>
                    </div>

        <!-- Results Panel (hidden by default) -->
        <div class="results-panel hidden" id="resultsPanel">
            <!-- Results Header -->
            <div class="results-header">
                <div class="results-header-top">
                    <h2 class="results-header-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Research Results
                    </h2>
                    <button class="results-close-btn" onclick="closeResultsPanel()" title="Close panel">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="results-tabs" id="resultsTabs">
                    <button onclick="switchResultsTab('stats')" id="tabStats" class="results-tab stats hidden">
                        <span class="source-dot stats"></span>
                        <span>Analysis</span>
                        <span class="tab-count stats" id="statsCount">ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã…Â </span>
                    </button>
                    <button onclick="switchResultsTab('trials')" id="tabTrials" class="results-tab trials hidden">
                        <span class="source-dot trials"></span>
                        <span>Trials</span>
                        <span class="tab-count trials" id="trialsCount">0</span>
                    </button>
                    <button onclick="switchResultsTab('fda')" id="tabFda" class="results-tab fda hidden">
                        <span class="source-dot fda"></span>
                        <span>FDA</span>
                        <span class="tab-count fda" id="fdaCount">0</span>
                    </button>
                    <button onclick="switchResultsTab('ob')" id="tabOb" class="results-tab ob hidden">
                        <span class="source-dot ob"></span>
                        <span>Patents</span>
                        <span class="tab-count ob" id="obCount">0</span>
                    </button>
                    <button onclick="switchResultsTab('pubmed')" id="tabPubmed" class="results-tab pubmed hidden">
                        <span class="source-dot pubmed"></span>
                        <span>Literature</span>
                        <span class="tab-count pubmed" id="pubmedCount">0</span>
                    </button>
                </div>
            </div>

            <!-- Results Content -->
            <div class="results-content" id="resultsContent">
                <div id="statsResults" class="results-tab-content">
                    <div class="stats-panel-content" id="statsPanelContent">
                        <div class="stats-panel-header">
                            <div class="stats-panel-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 20V10M12 20V4M6 20v-6"/>
                                </svg>
                            </div>
                            <div class="stats-panel-title">Statistical Analysis</div>
                        </div>
                        <div class="stats-panel-summary" id="statsSummaryPanel"></div>
                        <div class="stats-panel-chart" id="statsChartPanel"></div>
                    </div>
                </div>
                <div id="trialsResults" class="results-tab-content">
                    <div class="results-cards" id="trialsCards"></div>
                </div>
                <div id="fdaResults" class="results-tab-content">
                    <div class="results-cards" id="fdaCards"></div>
                </div>
                <div id="obResults" class="results-tab-content">
                    <div class="results-cards" id="obCards"></div>
                </div>
                <div id="pubmedResults" class="results-tab-content">
                    <div class="results-cards" id="pubmedCards"></div>
                </div>
            </div>

            <!-- Pagination -->
            <div class="results-pagination hidden" id="resultsPagination">
                <button class="pagination-btn" id="prevPageBtn" onclick="prevResultsPage()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Previous
                </button>
                <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
                <button class="pagination-btn" id="nextPageBtn" onclick="nextResultsPage()">
                    Next
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>


               
                </div>

                
            </div>
       
        
   
    <script>
        // ============================================
// RESULTS PANEL STATE
// ============================================
const resultsState = {
    panelOpen: false,
    activeTab: null,
    stats: { chartData: null, statsResults: null, hasData: false },
    trials: { data: [], filteredData: [], page: 1, perPage: 8 },
    fda: { data: [], page: 1, perPage: 6 },
    ob: { data: [], page: 1, perPage: 6 },
    pubmed: { data: [], page: 1, perPage: 8 }
};
// PubMed article state
const pubmedState = {
    selectedArticles: new Set(),
    abstractViews: new Set(),
    abstractSummaries: {},
    annotationsEnabled: false,
    searchTerm: '',
    expandedSearch: false
};
// Trials filter state
const trialsFilters = {
    hasResults: false,
    isCompleted: false,
    phaseFilters: {
        'PRE_PHASE': true,
        'PHASE1': true,
        'PHASE1_PHASE2': true,
        'PHASE2': true,
        'PHASE3': true,
        'PHASE4': true
    }
};

// Store last query response
let lastQueryResponse = null;

// Conversation tracking for followup detection
let currentConversationId = null;
let currentCitations = null; // ADD THIS LINE

// Chart instances for cleanup
const chartInstances = new Map();

// ============================================
// FILE UPLOAD SYSTEM
// ============================================

// Supported file types configuration
const FILE_TYPES = {
    // Documents & Text
    document: {
        extensions: ['.txt', '.md', '.rtf', '.pdf', '.doc', '.docx', '.odt', '.html', '.htm', '.xml', '.tex', '.csv', '.tsv'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`,
        colorClass: 'document'
    },
    // PDF specific
    pdf: {
        extensions: ['.pdf'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>`,
        colorClass: 'pdf'
    },
    // Spreadsheets & Data
    spreadsheet: {
        extensions: ['.xls', '.xlsx', '.ods', '.csv', '.tsv', '.json', '.yaml', '.yml', '.parquet', '.feather', '.sqlite', '.db'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`,
        colorClass: 'spreadsheet'
    },
    // Presentations
    presentation: {
        extensions: ['.ppt', '.pptx', '.odp'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>`,
        colorClass: 'presentation'
    },
    // Images
    image: {
        extensions: ['.png', '.jpg', '.jpeg', '.gif', '.webp', '.tiff', '.bmp', '.svg', '.ico'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`,
        colorClass: 'image'
    },
    // Audio
    audio: {
        extensions: ['.mp3', '.wav', '.m4a', '.aac', '.ogg', '.flac'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>`,
        colorClass: 'audio'
    },
    // Video
    video: {
        extensions: ['.mp4', '.mov', '.avi', '.mkv', '.webm'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>`,
        colorClass: 'video'
    },
    // Code
    code: {
        extensions: ['.js', '.py', '.java', '.cpp', '.c', '.h', '.css', '.scss', '.ts', '.jsx', '.tsx', '.php', '.rb', '.go', '.rs', '.swift'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>`,
        colorClass: 'code'
    },
    // Data files
    data: {
        extensions: ['.json', '.yaml', '.yml', '.xml', '.csv', '.tsv'],
        icon: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>`,
        colorClass: 'data'
    }
};

// Store uploaded files
const uploadedFiles = {
    initial: [],
    continuous: []
};

// Max file size (25 MB)
const MAX_FILE_SIZE = 25 * 1024 * 1024;

// Get file type info
function getFileTypeInfo(filename) {
    const ext = '.' + filename.split('.').pop().toLowerCase();
    
    // Check PDF first (specific)
    if (ext === '.pdf') {
        return FILE_TYPES.pdf;
    }
    
    // Check other types
    for (const [type, config] of Object.entries(FILE_TYPES)) {
        if (config.extensions.includes(ext)) {
            return config;
        }
    }
    
    // Default document type
    return FILE_TYPES.document;
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Generate unique ID
function generateFileId() {
    return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Trigger file input
function triggerFileInput(context) {
    document.getElementById(`fileInput${context.charAt(0).toUpperCase() + context.slice(1)}`).click();
}

// Handle file selection
function handleFileSelect(event, context) {
    const files = Array.from(event.target.files);
    files.forEach(file => addFile(file, context));
    event.target.value = ''; // Reset input
}

// Add file to upload queue
function addFile(file, context) {
    // Validate file size
    if (file.size > MAX_FILE_SIZE) {
        showUploadToast(`File "${file.name}" exceeds 25 MB limit`, 'error');
        return;
    }
    
    const fileInfo = getFileTypeInfo(file.name);
    const fileData = {
        id: generateFileId(),
        file: file,
        name: file.name,
        size: file.size,
        type: fileInfo.colorClass,
        icon: fileInfo.icon,
        progress: 0,
        status: 'pending', // pending, uploading, completed, error
        uploaded: false
    };
    
    uploadedFiles[context].push(fileData);
    renderFilePreview(context);
    updateAttachmentBadge(context);
    
    // Start upload simulation (replace with actual upload)
    simulateUpload(fileData, context);
}

// Simulate file upload (replace with actual upload logic)
function simulateUpload(fileData, context) {
    fileData.status = 'uploading';
    renderFilePreview(context);
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15 + 5;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            fileData.progress = 100;
            fileData.status = 'completed';
            fileData.uploaded = true;
            renderFilePreview(context);
        } else {
            fileData.progress = Math.round(progress);
            renderFilePreview(context);
        }
    }, 200);
}

// Replace your existing renderFilePreview function with this:

function renderFilePreview(context) {
    const container = document.getElementById(`filePreview${context.charAt(0).toUpperCase() + context.slice(1)}`);
    const files = uploadedFiles[context];
    
    if (files.length === 0) {
        container.classList.remove('has-files');
        container.innerHTML = '';
        return;
    }
    
    container.classList.add('has-files');
    container.innerHTML = files.map(file => {
        // Compact chip for completed files
        if (file.status === 'completed') {
            return `
                <div class="file-upload-item completed" id="${file.id}">
                    <div class="file-type-icon ${file.type}">
                        ${file.icon}
                    </div>
                    <div class="file-upload-info">
                        <div class="file-upload-name" title="${escapeHtml(file.name)}">${truncateFilename(file.name, 20)}</div>
                    </div>
                    <div class="file-upload-actions">
                        <button class="file-action-btn remove" onclick="removeFile('${file.id}', '${context}')" title="Remove">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Full width with progress for uploading/error states
        return `
            <div class="file-upload-item ${file.status}" id="${file.id}">
                <div class="file-type-icon ${file.type}">
                    ${file.icon}
                </div>
                <div class="file-upload-info">
                    <div class="file-upload-name">${escapeHtml(file.name)}</div>
                    <div class="file-upload-meta">
                        <span class="file-upload-size">${formatFileSize(file.size)}</span>
                        ${file.status === 'uploading' ? `
                            <div class="file-upload-progress">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${file.progress}%"></div>
                                </div>
                                <span class="progress-percentage">${file.progress}%</span>
                            </div>
                        ` : ''}
                        ${file.status === 'error' ? `
                            <span class="file-upload-status error">
                                <svg class="status-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Upload Failed
                            </span>
                        ` : ''}
                    </div>
                </div>
                <div class="file-upload-actions">
                    ${file.status === 'error' ? `
                        <button class="file-action-btn retry" onclick="retryUpload('${file.id}', '${context}')" title="Retry">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    ` : ''}
                    <button class="file-action-btn remove" onclick="removeFile('${file.id}', '${context}')" title="Remove">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Add this helper function to truncate long filenames
function truncateFilename(filename, maxLength) {
    if (filename.length <= maxLength) return filename;
    
    const ext = filename.split('.').pop();
    const nameWithoutExt = filename.slice(0, filename.lastIndexOf('.'));
    const truncatedName = nameWithoutExt.slice(0, maxLength - ext.length - 4) + '...';
    
    return truncatedName + '.' + ext;
}
// Remove file
function removeFile(fileId, context) {
    uploadedFiles[context] = uploadedFiles[context].filter(f => f.id !== fileId);
    renderFilePreview(context);
    updateAttachmentBadge(context);
}

// Retry upload
function retryUpload(fileId, context) {
    const fileData = uploadedFiles[context].find(f => f.id === fileId);
    if (fileData) {
        fileData.progress = 0;
        fileData.status = 'pending';
        simulateUpload(fileData, context);
    }
}

// Update attachment badge
function updateAttachmentBadge(context) {
    const badge = document.getElementById(`attachBadge${context.charAt(0).toUpperCase() + context.slice(1)}`);
    const btn = document.getElementById(`attachBtn${context.charAt(0).toUpperCase() + context.slice(1)}`);
    const count = uploadedFiles[context].length;
    
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
        btn.classList.add('has-files');
    } else {
        badge.style.display = 'none';
        btn.classList.remove('has-files');
    }
}

// Show upload toast
function showUploadToast(message, type = 'info') {
    const toast = document.getElementById('uploadToast');
    const msgEl = document.getElementById('uploadToastMessage');
    
    msgEl.textContent = message;
    toast.className = 'upload-toast' + (type === 'error' ? ' error' : '');
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// DRAG AND DROP HANDLERS
// ============================================

let dragCounter = 0;

// Initialize drag and drop
function initDragAndDrop() {
    const overlay = document.getElementById('globalDragOverlay');
    
    // Prevent default drag behaviors on document
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Global drag enter
    document.body.addEventListener('dragenter', (e) => {
        dragCounter++;
        if (e.dataTransfer.types.includes('Files')) {
            overlay.classList.add('active');
        }
    });
    
    // Global drag leave
    document.body.addEventListener('dragleave', (e) => {
        dragCounter--;
        if (dragCounter === 0) {
            overlay.classList.remove('active');
        }
    });
    
    // Global drop
    document.body.addEventListener('drop', (e) => {
        dragCounter = 0;
        overlay.classList.remove('active');
        
        if (e.dataTransfer.files.length > 0) {
            // Determine which context to use based on visibility
            const continuousInput = document.getElementById('continuousChatInput');
            const context = continuousInput.style.display !== 'none' ? 'continuous' : 'initial';
            
            Array.from(e.dataTransfer.files).forEach(file => {
                addFile(file, context);
            });
        }
    });
    
    // Setup zone-specific drag handlers
    setupZoneDragHandlers('initial');
    setupZoneDragHandlers('continuous');
}

function setupZoneDragHandlers(context) {
    const zone = document.getElementById(`${context}UploadZone`);
    if (!zone) return;
    
    zone.addEventListener('dragover', (e) => {
        zone.classList.add('drag-over');
    });
    
    zone.addEventListener('dragleave', (e) => {
        zone.classList.remove('drag-over');
    });
    
    zone.addEventListener('drop', (e) => {
        zone.classList.remove('drag-over');
    });
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initDragAndDrop);

// ============================================
// GET FILES FOR SUBMISSION
// ============================================

// Get uploaded files for a context (use in your submit functions)
function getUploadedFiles(context) {
    return uploadedFiles[context]
        .filter(f => f.status === 'completed')
        .map(f => f.file);
}

// Clear files after submission
function clearUploadedFiles(context) {
    uploadedFiles[context] = [];
    renderFilePreview(context);
    updateAttachmentBadge(context);
}
        // ============================================
        // SIDEBAR & NAVIGATION FUNCTIONS
        // ============================================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('minimized');
            
            if (window.innerWidth <= 768) {
                if (!sidebar.classList.contains('minimized')) {
                    overlay.classList.add('active');
                } else {
                    overlay.classList.remove('active');
                }
            }
        }

        function toggleSection(section) {
            const content = document.getElementById(`${section}Content`);
            const chevron = document.getElementById(`${section}Chevron`);
            
            if (content && chevron) {
                content.classList.toggle('hidden');
                chevron.classList.toggle('expanded');
            }
        }

        function toggleNavMenu() {
            const menu = document.getElementById('navMenu');
            menu.classList.toggle('active');
        }

        function toggleUserMenu() {
            // Placeholder for user menu functionality
            console.log('User menu clicked');
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            // Close nav menu
            const navMenu = document.getElementById('navMenu');
            if (navMenu && !e.target.closest('.navbar-icon-btn') && !e.target.closest('.dropdown-menu')) {
                navMenu.classList.remove('active');
            }
            
            // Close reasoning dropdowns
            if (!e.target.closest('.relative')) {
                closeAllDropdowns();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth > 768) {
                overlay.classList.remove('active');
            }
        });

        // ============================================
        // LEAF AI - STANDALONE VERSION
        // Complete chat interface with streaming AI responses
        // ============================================

        // Global state variables
        let isProcessing = false;
        let conversationStarted = false;
        let currentQuestion = '';
        let currentStreamId = null;
        let conversationHistory = [];
        let selectedReasoningLevel = {
            initial: null,
            continuous: 'quick'
        };
        let detectedTrials = new Map();

        // Storage for response content
        let responseMarkdown = new Map();
        let userPrompts = new Map();

        window.userPrompts = userPrompts;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¦ Leaf AI initialized');
            setupGreeting();
            setupEventListeners();
        });

        function setupGreeting() {
            const greetingName = document.getElementById('chatGreetingName');
            if (greetingName) {
                const hour = new Date().getHours();
                let greeting = 'Good Morning';
                if (hour >= 12 && hour < 18) greeting = 'Good Afternoon';
                else if (hour >= 18) greeting = 'Good Evening';
                
                // Update the greeting text
                const greetingElement = document.querySelector('.chat-welcome-greeting');
                if (greetingElement) {
                    greetingElement.innerHTML = `${greeting}, <span id="chatGreetingName">User</span>`;
                }
                
                const userName = 'User'; // You can customize this
                greetingName.textContent = userName;
            }
        }

        function setupEventListeners() {
            // Auto-resize text areas
            const initialInput = document.getElementById('aiInputInitial');
            const continuousInput = document.getElementById('aiInputContinuous');
            
            if (initialInput) {
                initialInput.addEventListener('input', () => autoResize(initialInput));
            }
            
            if (continuousInput) {
                continuousInput.addEventListener('input', () => autoResize(continuousInput));
            }
        }

        // ============================================
        // AUTO-RESIZE TEXTAREA
        // ============================================
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ============================================
        // REASONING LEVEL DROPDOWN
        // ============================================
        function toggleReasoningDropdown(type) {
            const menu = document.getElementById(`reasoningMenu${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const chevron = document.getElementById(`chevron${type.charAt(0).toUpperCase() + type.slice(1)}`);
            
            if (menu) {
                const isOpen = !menu.classList.contains('hidden');
                
                // Close all other dropdowns
                closeAllDropdowns();
                
                if (!isOpen) {
                    menu.classList.remove('hidden');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                }
            }
        }

        function closeAllDropdowns() {
            const dropdowns = ['reasoningMenuInitial', 'reasoningMenuContinuous'];
            const chevrons = ['chevronInitial', 'chevronContinuous'];
            
            dropdowns.forEach((id, index) => {
                const menu = document.getElementById(id);
                const chevron = document.getElementById(chevrons[index]);
                
                if (menu) menu.classList.add('hidden');
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            });
        }

        function selectReasoningLevel(type, level) {
            selectedReasoningLevel[type] = level;
            
            const levelInfo = {
                current: { label: 'Current Page', shortLabel: 'Current', subtext: 'Instant', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
                quick: { label: 'Quick Search', shortLabel: 'Quick', subtext: '~30 seconds', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                deep: { label: 'Deep Research', shortLabel: 'Deep', subtext: '~10 minutes', icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z' }
            };
            
            const info = levelInfo[level];
            const capitalize = type.charAt(0).toUpperCase() + type.slice(1);
            
            const label = document.getElementById(`reasoningLabel${capitalize}`);
            const subtext = document.getElementById(`reasoningSubtext${capitalize}`);
            const icon = document.getElementById(`reasoningIcon${capitalize}`);
            const button = document.getElementById(`reasoningDropdown${capitalize}`);
            
            // Use short label for continuous, full label for initial
            if (label) {
                label.textContent = type === 'continuous' ? info.shortLabel : info.label;
            }
            if (subtext) {
                subtext.textContent = info.subtext;
                subtext.classList.remove('hidden');
            }
            if (icon) {
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${info.icon}"></path>`;
            }
            if (button) {
                button.classList.remove('animate-pulse', 'border-orange-300', 'bg-orange-50');
                if (type === 'initial') {
                    button.classList.add('border-gray-200', 'bg-white');
                }
            }
            
            closeAllDropdowns();
        }

        function inheritReasoningLevel() {
            if (selectedReasoningLevel.initial) {
                selectedReasoningLevel.continuous = selectedReasoningLevel.initial;
                selectReasoningLevel('continuous', selectedReasoningLevel.initial);
            }
        }

        function getReasoningLevel(type) {
            return selectedReasoningLevel[type] || 'quick';
        }

        function getTimeEstimate(level) {
            const estimates = {
                current: '~5 seconds',
                quick: '~30 seconds',
                deep: '~10 minutes'
            };
            return estimates[level] || '~30 seconds';
        }

        // ============================================
        // CHAT SUBMISSION
        // ============================================
        function submitInitialQuery() {
            // Check if reasoning level is selected FIRST
            if (!selectedReasoningLevel.initial) {
                const button = document.getElementById('reasoningDropdownInitial');
                if (button) {
                    button.classList.add('animate-pulse');
                }
                showNotification('Please select a reasoning level before submitting', 'warning');
                return;
            }
            
            const input = document.getElementById('aiInputInitial');
            const question = input.value.trim();

            const placeholder = document.getElementById('initialInputBar');
            const examplepils = document.getElementById('examplepils');
            const reasoningLevel = getReasoningLevel('initial');
            
            if (examplepils) examplepils.classList.add('hidden');
            if (placeholder) placeholder.classList.add('hidden');
            
            if (!question || isProcessing) return;
            
            document.getElementById('continuousChatInput').style.display = 'flex';
            conversationStarted = true;
            
            // Inherit reasoning level for continuous chat
            inheritReasoningLevel();
            
            // Hide empty state
            updateEmptyState();

            // Add to conversation list in sidebar
            addConversationToSidebar(question);

            // processQuery(question, [], reasoningLevel);

            const files = getUploadedFiles('initial');
processQuery(question, files, reasoningLevel);
// Clear files after submission
clearUploadedFiles('initial');

            
            // Clear input
            input.value = '';
        }

        function submitContinuousQuery() {
            const input = document.getElementById('aiInputContinuous');
            const question = input.value.trim();
            const reasoningLevel = getReasoningLevel('continuous');
            
            if (!question || isProcessing) return;
            
            // processQuery(question, [], reasoningLevel);

const files = getUploadedFiles('continuous');
processQuery(question, files, reasoningLevel);
// Clear files after submission
clearUploadedFiles('continuous');
            
            // Clear input
            input.value = '';
            autoResize(input);
        }

        // ============================================
        // ADD CONVERSATION TO SIDEBAR
        // ============================================
        function addConversationToSidebar(question) {
            const conversationList = document.getElementById('conversationsContent');
            if (!conversationList) return;
            
            // Remove empty state text if exists
            const emptyText = conversationList.querySelector('.sidebar-empty');
            if (emptyText) emptyText.remove();
            
            // Truncate question for display
            const displayText = question.length > 30 ? question.substring(0, 30) + '...' : question;
            
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.innerHTML = `
                <svg class="sidebar-item-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                </svg>
                <span>${escapeHtml(displayText)}</span>
            `;
            
            conversationList.insertBefore(item, conversationList.firstChild);
        }

        // ============================================
        // QUERY PROCESSING
        // ============================================
        async function processQuery(question, files = [], reasoningLevel = 'quick') {
            isProcessing = true;
            currentQuestion = question;
            
            // Store user message in history
            conversationHistory.push({
                role: 'user',
                content: question,
                files: files.map(f => f.name),
                timestamp: new Date().toISOString()
            });
            
            addUserMessage(question, files, reasoningLevel);
            startAIResponse(question, files, reasoningLevel);
        }

        // ============================================
        // ADD USER MESSAGE
        // ============================================
        function addUserMessage(text, files = [], reasoningLevel = 'quick') {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'user-message-container fade-in-up';
            
            // Get current timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            // Get reasoning level info with icons
            const levelInfo = {
                current: { label: 'Current Page', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
                quick: { label: 'Quick Search', icon: 'M13 10V3L4 14h7v7l9-11h-7z' },
                deep: { label: 'Deep Research', icon: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z' }
            };
            
            const levelData = levelInfo[reasoningLevel] || levelInfo.quick;
            
            // Build attachment bar HTML if files exist
            let attachmentHtml = '';
            if (files.length > 0) {
                attachmentHtml = `
                    <div class="user-attachment-bar">
                        ${files.map(file => `
                            <div class="attachment-chip">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <span>${file.name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="user-message-wrapper">
                    <div class="user-message-bubble ${files.length > 0 ? 'has-attachment' : ''}">
                        <span class="message-text">${escapeHtml(text)}</span>
                        ${attachmentHtml}
                    </div>
                    <div class="user-message-meta">
                        <div class="user-message-depth ${reasoningLevel}">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="${levelData.icon}"></path>
                            </svg>
                            ${levelData.label}
                        </div>
                        <span class="user-message-time">${timeString}</span>
                        <svg class="user-message-status" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--forest-400)" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                </div>
            `;
            container.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });

            updateEmptyState();
        }

        // ============================================
        // START AI RESPONSE
        // ============================================
        async function startAIResponse(question, files = [], reasoningLevel = 'quick') {
            const container = document.getElementById('chatContainer');
            currentStreamId = 'stream-' + Date.now();

            const responseDiv = document.createElement('div');
            responseDiv.className = 'fade-in-up ai-response-wrapper';
            responseDiv.id = currentStreamId;
            
            // Initial loading state with leaf loader
            responseDiv.innerHTML = `
                <div class="ai-response">
                    <!-- Header with Leaf Avatar -->
                    <div class="response-header hidden">
                        <div class="ai-avatar">
                            <svg viewBox="0 0 40 52" fill="none">
                                <path d="M20 4 L30 10 L34 20 L32 32 L24 42 L20 46 L16 42 L8 32 L6 20 L10 10 Z" fill="#247a64"/>
                                <path d="M20 8 L20 42" stroke="#4db897" stroke-width="1.5" opacity="0.5"/>
                                <path d="M20 14 L14 20 M20 14 L26 20" stroke="#4db897" stroke-width="1" opacity="0.4"/>
                                <path d="M20 24 L12 30 M20 24 L28 30" stroke="#4db897" stroke-width="1" opacity="0.3"/>
                            </svg>
                        </div>
                        <div class="ai-info">
                            <div class="ai-name">Leaf Intelligence</div>
                            <div class="ai-subtitle">Evidence-Based Analysis</div>
                        </div>
                        <div class="response-status processing" id="status-${currentStreamId}">
                            <span class="status-dot pulsing"></span>
                            Processing
                        </div>
                    </div>
                    
                    <!-- Leaf Loader -->
                    <div class="initial-loader" id="initialLoader-${currentStreamId}">
                        <div class="leaf-loader">
                            <div class="leaf-bar"></div>
                            <div class="leaf-bar"></div>
                            <div class="leaf-bar"></div>
                            <div class="leaf-bar"></div>
                            <div class="leaf-bar"></div>
                        </div>
                        <span class="loader-text">Analyzing your request...</span>
                    </div>
                </div>
            `;
            container.appendChild(responseDiv);
            responseDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });

            await new Promise(resolve => setTimeout(resolve, 800));

            // Build the full AI response structure
            const artifactHTML = `
                <div class="ai-response">
                    <!-- Header -->
                    <div class="response-header hidden">
                        <div class="ai-avatar">
                            <svg viewBox="0 0 40 52" fill="none">
                                <path d="M20 4 L30 10 L34 20 L32 32 L24 42 L20 46 L16 42 L8 32 L6 20 L10 10 Z" fill="#247a64"/>
                                <path d="M20 8 L20 42" stroke="#4db897" stroke-width="1.5" opacity="0.5"/>
                                <path d="M20 14 L14 20 M20 14 L26 20" stroke="#4db897" stroke-width="1" opacity="0.4"/>
                                <path d="M20 24 L12 30 M20 24 L28 30" stroke="#4db897" stroke-width="1" opacity="0.3"/>
                            </svg>
                        </div>
                        <div class="ai-info">
                            <div class="ai-name">Leaf Intelligence</div>
                            <div class="ai-subtitle">Evidence-Based Analysis</div>
                        </div>
                        <div class="response-status" id="status-${currentStreamId}">
                            <span class="status-dot pulsing"></span>
                            Researching
                        </div>
                    </div>
                    
                    <!-- Thinking State (Collapsible) -->
                    <div class="thinking-container" id="thinking-${currentStreamId}">
                        <div class="thinking-header expanded" onclick="toggleThinking('${currentStreamId}')">
                            <div class="thinking-icon">
                                <svg viewBox="0 0 28 28" fill="none">
                                    <circle cx="14" cy="14" r="12" fill="#b3ece8" stroke="#1a9d96" stroke-width="2"/>
                                    <path d="M14 8v6l4 2" stroke="#14807a" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="thinking-label">
                                Researching...
                            </div>
                            <svg class="thinking-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="thinking-body expanded" id="thinkingBody-${currentStreamId}">
                            <div class="thinking-steps">
                                <div class="steps-timeline" id="stepsTimeline-${currentStreamId}">
                                    <div class="step-item active" id="step-understand-${currentStreamId}">
                                        <div class="step-node"><div class="step-node-inner"></div></div>
                                        <div class="step-content">
                                            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2"/>
                                            </svg>
                                            <span class="step-text">Understanding your query...</span>
                                        </div>
                                    </div>
                                    <div class="step-item" id="step-search-${currentStreamId}">
                                        <div class="step-node"><div class="step-node-inner"></div></div>
                                        <div class="step-content">
                                            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="11" cy="11" r="8"/>
                                                <path d="M21 21l-4.35-4.35"/>
                                            </svg>
                                            <span class="step-text">Searching knowledge base and sources...</span>
                                        </div>
                                    </div>
                                    <div class="step-item" id="step-synthesize-${currentStreamId}">
                                        <div class="step-node"><div class="step-node-inner"></div></div>
                                        <div class="step-content">
                                            <svg class="step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
                                                <rect x="9" y="3" width="6" height="4" rx="1"/>
                                                <path d="M9 12h6m-6 4h6"/>
                                            </svg>
                                            <span class="step-text">Synthesizing evidence...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Response Content -->
                    <div class="response-content" id="content-${currentStreamId}">
                        <div class="content-loader">
                            <div class="leaf-loader small">
                                <div class="leaf-bar"></div>
                                <div class="leaf-bar"></div>
                                <div class="leaf-bar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ✅ NEW: Source Documents Panel -->
<div class="source-files-panel" id="sourceFiles-${currentStreamId}" >
    <div class="source-files-header" onclick="toggleSourceFiles('${currentStreamId}')">
        <div class="source-files-icon">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
        </div>
        <div class="source-files-title">
            <span>Source Documents</span>
            <span class="source-files-count" id="sourceFilesCount-${currentStreamId}">0</span>
        </div>
        <svg class="source-files-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
        </svg>
    </div>
    <div class="source-files-body" id="sourceFilesBody-${currentStreamId}">
        <div class="source-files-list" id="sourceFilesList-${currentStreamId}">
            <!-- Files will be injected here -->
        </div>
    </div>
</div>

<!-- Data view cards - inline with content -->
<div class="data-cards-inline" id="followups-${currentStreamId}" >
    <div class="data-cards-list" id="followupList-${currentStreamId}">
        <!-- Data cards will be added here -->
    </div>
</div>
                    <!-- References Section (Collapsible) -->


                    <!-- Action Bar -->
                    <div class="action-bar">
                        <button class="hidden response-action-btn" onclick="saveReport(event)" title="Save Report">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                            </svg>
                            <span>Save Report</span>
                        </button>
                        
                        <button class="response-action-btn" onclick="savePrompt(event)" title="Save Prompt">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                            </svg>
                            <span>Save Prompt</span>
                        </button>
                        
                        <button class="response-action-btn" onclick="downloadWord(event)" title="Download as Word">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span>Word</span>
                        </button>
                        
                        <button class="response-action-btn" onclick="downloadPowerPoint(event)" title="Download as PowerPoint">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h4"/>
                            </svg>
                            <span>PowerPoint</span>
                        </button>
                        
                        <button class="hidden response-action-btn" onclick="shareResponse(event)" title="Share">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                            </svg>
                            <span>Share</span>
                        </button>
                        <div class="action-spacer"></div>
                        <span class="source-count" id="sourceCount-${currentStreamId}">Analyzing sources...</span>
                    </div>
                
                </div>
            
                
            `;
                     
            responseDiv.innerHTML = artifactHTML;

            // Start research process
            await conductResearch(currentStreamId, question, files, reasoningLevel);
        }
     
// ============================================
// CHART RENDERING FUNCTIONS
// ============================================

/**
 * Render a chart from chartData object
 * @param {string} containerId - DOM element ID to render chart into
 * @param {object} chartData - Chart configuration from stats agent
 */
function renderChart(containerId, chartData) {
    if (!chartData || !chartData.data) {
        console.warn('No chart data to render');
        return null;
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.warn('Chart container not found:', containerId);
        return null;
    }
    
    // Clean up existing chart if any
    if (chartInstances.has(containerId)) {
        chartInstances.get(containerId).destroy();
        chartInstances.delete(containerId);
    }
    
    // Create canvas element
    const canvas = document.createElement('canvas');
    canvas.id = `canvas-${containerId}`;
    canvas.style.maxHeight = '300px';
    container.innerHTML = '';
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    
    // Map chart type
    let chartType = chartData.type || 'bar';
    if (chartType === 'histogram') chartType = 'bar';
    
    // Prepare data
    const labels = chartData.data.map(d => d.label);
    const values = chartData.data.map(d => d.value);
    
    // Color palette (forest theme)
    const colors = [
        'rgba(36, 122, 100, 0.8)',   // forest-500
        'rgba(45, 154, 126, 0.8)',   // forest-400
        'rgba(77, 184, 151, 0.8)',   // forest-300
        'rgba(20, 128, 122, 0.8)',   // teal-500
        'rgba(26, 157, 150, 0.8)',   // teal-400
        'rgba(46, 196, 182, 0.8)',   // teal-300
        'rgba(180, 83, 9, 0.8)',     // amber-700
        'rgba(217, 119, 6, 0.8)',    // amber-600
        'rgba(239, 68, 68, 0.8)',    // red-500
        'rgba(99, 102, 241, 0.8)',   // indigo
    ];
    
    const borderColors = colors.map(c => c.replace('0.8', '1'));
    
    // Chart configuration
    const config = {
        type: chartType,
        data: {
            labels: labels,
            datasets: [{
                label: chartData.yAxis || 'Count',
                data: values,
                backgroundColor: chartType === 'pie' ? colors.slice(0, labels.length) : colors[0],
                borderColor: chartType === 'pie' ? borderColors.slice(0, labels.length) : borderColors[0],
                borderWidth: 1,
                borderRadius: chartType === 'bar' ? 4 : 0,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                title: {
                    display: !!chartData.title,
                    text: chartData.title || '',
                    font: { size: 14, weight: '600', family: "'IBM Plex Sans', sans-serif" },
                    color: '#1a4a3f',
                    padding: { bottom: 16 }
                },
                legend: {
                    display: chartType === 'pie',
                    position: 'right',
                    labels: {
                        font: { size: 11, family: "'IBM Plex Sans', sans-serif" },
                        padding: 12,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(10, 31, 26, 0.9)',
                    titleFont: { size: 12, family: "'IBM Plex Sans', sans-serif" },
                    bodyFont: { size: 11, family: "'IBM Plex Sans', sans-serif" },
                    padding: 10,
                    cornerRadius: 6
                }
            },
            scales: chartType !== 'pie' ? {
                x: {
                    title: {
                        display: !!chartData.xAxis,
                        text: chartData.xAxis || '',
                        font: { size: 11, weight: '500', family: "'IBM Plex Sans', sans-serif" },
                        color: '#5a5f5e'
                    },
                    ticks: {
                        font: { size: 10, family: "'IBM Plex Sans', sans-serif" },
                        color: '#757a79'
                    },
                    grid: { display: false }
                },
                y: {
                    title: {
                        display: !!chartData.yAxis,
                        text: chartData.yAxis || '',
                        font: { size: 11, weight: '500', family: "'IBM Plex Sans', sans-serif" },
                        color: '#5a5f5e'
                    },
                    ticks: {
                        font: { size: 10, family: "'IBM Plex Sans', sans-serif" },
                        color: '#757a79',
                        precision: 0
                    },
                    grid: { color: 'rgba(10, 31, 26, 0.06)' },
                    beginAtZero: true
                }
            } : undefined
        }
    };
    
    // Create and store chart
    const chart = new Chart(ctx, config);
    chartInstances.set(containerId, chart);
    
    return chart;
}

/**
 * Render stats results as a formatted card
 * @param {string} containerId - DOM element ID
 * @param {object} statsResults - Statistics results from stats agent
 */
function renderStatsCard(containerId, statsResults) {
    const container = document.getElementById(containerId);
    if (!container || !statsResults) return;
    
    let html = '<div class="stats-results-card">';
    
    const result = statsResults.result;
    if (!result) {
        html += '<p class="text-gray-500">No statistics available</p>';
        html += '</div>';
        container.innerHTML = html;
        return;
    }
    
    // Render different types of results
    if (statsResults.operation === 'enrollment_stats' && result.average) {
        html += `
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">${result.average?.toLocaleString() || 'N/A'}</div>
                    <div class="stat-label">Average Enrollment</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${result.median?.toLocaleString() || 'N/A'}</div>
                    <div class="stat-label">Median</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${result.min?.toLocaleString() || 'N/A'}</div>
                    <div class="stat-label">Minimum</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${result.max?.toLocaleString() || 'N/A'}</div>
                    <div class="stat-label">Maximum</div>
                </div>
            </div>
            <div class="stat-footnote">
                Based on ${result.trialsWithData || 0} of ${statsResults.sampleSize || 0} trials with enrollment data
            </div>
        `;
    } else if (result.trialsWithPlacebo !== undefined) {
        // Placebo analysis
        html += `
            <div class="stats-grid">
                <div class="stat-item highlight">
                    <div class="stat-value">${result.trialsWithPlacebo}</div>
                    <div class="stat-label">Placebo-Controlled</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${result.trialsWithoutPlacebo}</div>
                    <div class="stat-label">No Placebo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${result.percentageWithPlacebo}</div>
                    <div class="stat-label">Percentage</div>
                </div>
            </div>
        `;
    } else if (result.distribution || result.byClass) {
        // Distribution results
        const dist = result.distribution || result.byClass || result;
        html += '<div class="stats-distribution">';
        Object.entries(dist).forEach(([key, value]) => {
            if (typeof value === 'number') {
                const label = key.replace(/_/g, ' ').replace(/PHASE/g, 'Phase ');
                html += `
                    <div class="distribution-row">
                        <span class="distribution-label">${label}</span>
                        <span class="distribution-value">${value}</span>
                    </div>
                `;
            }
        });
        html += '</div>';
    } else if (result.totalTrials !== undefined) {
        // Simple count
        html += `
            <div class="stat-item large">
                <div class="stat-value">${result.totalTrials}</div>
                <div class="stat-label">Total Trials</div>
            </div>
        `;
        
        if (result.filtered) {
            html += '<div class="stats-filters">';
            Object.entries(result.filtered).forEach(([key, value]) => {
                html += `<span class="filter-badge">${key}: ${value}</span>`;
            });
            html += '</div>';
        }
    }
    
    html += '</div>';
    container.innerHTML = html;
}

/**
 * Create the chart/stats container HTML for artifact
 */
function createChartContainerHTML(streamId) {
    return `
        <div class="chart-section" id="chartSection-${streamId}" style="display: none;">
            <div class="chart-header">
                <div class="chart-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10M12 20V4M6 20v-6"/>
                    </svg>
                </div>
                <div class="chart-title">Statistical Analysis</div>
                <div class="chart-badge followup-badge" id="followupBadge-${streamId}" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Followup Analysis
                </div>
            </div>
            <div class="chart-content">
                <div class="stats-container" id="statsContainer-${streamId}"></div>
                <div class="chart-container" id="chartContainer-${streamId}"></div>
            </div>
        </div>
    `;
}

// ============================================
// CITATION MARKER PROCESSING - ROBUST VERSION
// ============================================

/**
 * ============================================
 * AUTO-INJECT CITATIONS SYSTEM
 * ============================================
 * 
 * Post-processes AI responses to automatically inject
 * citation markers based on matching patterns with
 * the available data. No reliance on AI formatting.
 * 
 * Add this to ai.html in the <script> section
 */

// ============================================
// MAIN AUTO-INJECTION FUNCTION
// ============================================

/**
 * Auto-inject citation markers into text based on available data
 * @param {string} text - The AI response text (markdown)
 * @param {Object} citations - The citations object with trials, fda, pubmed, orangeBook
 * @returns {string} - Text with citation markers injected
 */
function autoInjectCitations(text, citations) {
    if (!citations || !text) return text;
    
    let processed = text;
    const injected = { trials: 0, fda: 0, pubmed: 0, ob: 0 };
    
    // Track what we've already cited to avoid duplicates
    const cited = new Set();
    
    // ========================================
    // 1. INJECT CLINICAL TRIAL CITATIONS
    // ========================================
    if (citations.trials && Object.keys(citations.trials).length > 0) {
        
        // Pattern 1: Direct NCT ID mentions (NCT12345678)
        // Matches: NCT12345678, NCT-12345678, NCT 12345678
        processed = processed.replace(/\bNCT[-\s]?(\d{8})\b/gi, (match, digits) => {
            const nctId = `NCT${digits}`;
            if (citations.trials[nctId] && !cited.has(nctId)) {
                cited.add(nctId);
                injected.trials++;
                return `${match} [TRIAL:${nctId}]`;
            }
            return match;
        });
        
        // Pattern 2: Match trial titles/names in text
        Object.entries(citations.trials).forEach(([nctId, trial]) => {
            if (cited.has(nctId)) return;
            
            // Try to match brief title (first 40 chars, escaped for regex)
            const briefTitle = trial.briefTitle || '';
            if (briefTitle.length > 15) {
                const searchTerm = escapeRegexString(briefTitle.substring(0, 40));
                const titleRegex = new RegExp(`(${searchTerm}[^\\[]*?)(?!\\[TRIAL:)`, 'i');
                
                if (titleRegex.test(processed) && !cited.has(nctId)) {
                    processed = processed.replace(titleRegex, (match) => {
                        cited.add(nctId);
                        injected.trials++;
                        return `${match.trim()} [TRIAL:${nctId}]`;
                    });
                }
            }
        });
    }
    
    // ========================================
    // 2. INJECT FDA CITATIONS
    // ========================================
    if (citations.fda && Object.keys(citations.fda).length > 0) {
        
        // Pattern 1: Direct NDA/BLA/ANDA mentions
        // Matches: NDA 123456, NDA123456, NDA-123456, ANDA 123456, BLA 123456
        processed = processed.replace(/\b(NDA|BLA|ANDA)[-\s]?(\d{6,7})\b/gi, (match, type, digits) => {
            const appNum = `${type.toUpperCase()}${digits}`;
            
            const foundKey = Object.keys(citations.fda).find(k => 
                k === appNum || k.endsWith(digits)
            );
            
            if (foundKey && !cited.has(foundKey)) {
                cited.add(foundKey);
                injected.fda++;
                return `${match} [FDA:${foundKey}]`;
            }
            return match;
        });
        
        // Pattern 2: Match drug/trade names
        Object.entries(citations.fda).forEach(([appNum, drug]) => {
            if (cited.has(appNum)) return;
            
            // Match trade name (brand name)
            const tradeName = drug.tradeName || '';
            if (tradeName.length > 2) {
                // Case insensitive, whole word match
                const nameRegex = new RegExp(
                    `\\b(${escapeRegexString(tradeName)})\\b(?![^\\[]*\\])`, 
                    'gi'
                );
                
                if (nameRegex.test(processed) && !cited.has(appNum)) {
                    // Only inject on first occurrence
                    let injectedOnce = false;
                    processed = processed.replace(nameRegex, (match) => {
                        if (!injectedOnce && !cited.has(appNum)) {
                            cited.add(appNum);
                            injected.fda++;
                            injectedOnce = true;
                            return `${match} [FDA:${appNum}]`;
                        }
                        return match;
                    });
                }
            }
            
            // Match generic/drug name
            const drugName = drug.drugName || '';
            if (drugName.length > 3 && !cited.has(appNum)) {
                const drugRegex = new RegExp(
                    `\\b(${escapeRegexString(drugName)})\\b(?![^\\[]*\\])`, 
                    'gi'
                );
                
                if (drugRegex.test(processed)) {
                    let injectedOnce = false;
                    processed = processed.replace(drugRegex, (match) => {
                        if (!injectedOnce && !cited.has(appNum)) {
                            cited.add(appNum);
                            injected.fda++;
                            injectedOnce = true;
                            return `${match} [FDA:${appNum}]`;
                        }
                        return match;
                    });
                }
            }
        });
    }
    
    // ========================================
    // 3. INJECT PUBMED CITATIONS
    // ========================================
    if (citations.pubmed && Object.keys(citations.pubmed).length > 0) {
        
        // Pattern 1: Direct PMID mentions
        processed = processed.replace(/\bPMID[:\s-]*(\d{7,8})\b/gi, (match, pmid) => {
            if (citations.pubmed[pmid] && !cited.has(`pmid_${pmid}`)) {
                cited.add(`pmid_${pmid}`);
                injected.pubmed++;
                return `${match} [PUBMED:${pmid}]`;
            }
            return match;
        });
        
        // Pattern 2: Match author citations (Author et al., Year)
        Object.entries(citations.pubmed).forEach(([pmid, article]) => {
            if (cited.has(`pmid_${pmid}`)) return;
            
            const authors = article.authors || [];
            const year = article.year || '';
            
            if (authors.length > 0 && year) {
                let firstAuthor = authors[0];
                if (typeof firstAuthor === 'string') {
                    firstAuthor = firstAuthor.split(/[\s,]/)[0];
                }
                
                if (firstAuthor && firstAuthor.length > 2) {
                    const authorPatterns = [
                        `${escapeRegexString(firstAuthor)}\\s+et\\s+al\\.?,?\\s*\\(?${year}\\)?`,
                        `${escapeRegexString(firstAuthor)}\\s*\\(${year}\\)`,
                        `${escapeRegexString(firstAuthor)}.*?${year}`
                    ];
                    
                    for (const pattern of authorPatterns) {
                        const authorRegex = new RegExp(`(${pattern})(?!\\s*\\[PUBMED:)`, 'gi');
                        
                        if (authorRegex.test(processed) && !cited.has(`pmid_${pmid}`)) {
                            processed = processed.replace(authorRegex, (match) => {
                                cited.add(`pmid_${pmid}`);
                                injected.pubmed++;
                                return `${match} [PUBMED:${pmid}]`;
                            });
                            break;
                        }
                    }
                }
            }
            
            // Pattern 3: Match article title (partial)
            const title = article.title || '';
            if (title.length > 20 && !cited.has(`pmid_${pmid}`)) {
                const titleSnippet = escapeRegexString(title.substring(0, 30));
                const titleRegex = new RegExp(`(${titleSnippet}[^\\[]{0,50})(?!\\[PUBMED:)`, 'i');
                
                if (titleRegex.test(processed)) {
                    processed = processed.replace(titleRegex, (match) => {
                        if (!cited.has(`pmid_${pmid}`)) {
                            cited.add(`pmid_${pmid}`);
                            injected.pubmed++;
                            return `${match.trim()} [PUBMED:${pmid}]`;
                        }
                        return match;
                    });
                }
            }
        });
    }
    
    // ========================================
    // 4. INJECT ORANGE BOOK CITATIONS
    // ========================================
    if (citations.orangeBook && Object.keys(citations.orangeBook).length > 0) {
        const obContextRegex = /patent|exclusivity|orange\s*book|generic|therapeutic\s*equivalen/i;
        
        if (obContextRegex.test(processed)) {
            Object.entries(citations.orangeBook).forEach(([applNo, entry]) => {
                if (cited.has(`ob_${applNo}`)) return;
                
                const tradeName = entry.tradeName || '';
                const ingredient = entry.ingredient || '';
                
                const searchTerms = [tradeName, ingredient].filter(t => t.length > 2);
                
                searchTerms.forEach(term => {
                    if (cited.has(`ob_${applNo}`)) return;
                    
                    const contextRegex = new RegExp(
                        `((?:patent|exclusivity|orange\\s*book|generic)[^.]{0,100}\\b${escapeRegexString(term)}\\b)` +
                        `|` +
                        `(\\b${escapeRegexString(term)}\\b[^.]{0,100}(?:patent|exclusivity|orange\\s*book|generic))`,
                        'gi'
                    );
                    
                    if (contextRegex.test(processed) && !cited.has(`ob_${applNo}`)) {
                        const termRegex = new RegExp(
                            `\\b(${escapeRegexString(term)})\\b(?![^\\[]*\\])`,
                            'i'
                        );
                        
                        let injectedOnce = false;
                        processed = processed.replace(termRegex, (match) => {
                            if (!injectedOnce && !cited.has(`ob_${applNo}`)) {
                                cited.add(`ob_${applNo}`);
                                injected.ob++;
                                injectedOnce = true;
                                return `${match} [OB:${applNo}]`;
                            }
                            return match;
                        });
                    }
                });
            });
        }
    }
    
    console.log('[AutoInject] Citation injection complete:', {
        injected,
        total: injected.trials + injected.fda + injected.pubmed + injected.ob,
        citedItems: cited.size
    });
    
    return processed;
}

/**
 * Escape special regex characters in a string
 */
function escapeRegexString(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ============================================
// ENHANCED PROCESSING PIPELINE
// ============================================

/**
 * Complete citation processing pipeline
 * 1. Auto-inject citations based on data matching
 * 2. Process any existing markers (with flexible regex)
 * 3. Clean up any duplicate markers
 */
function processCitationsComplete(markdown, citations) {
    if (!markdown) return '';
    if (!citations) return markdown;
    
    console.log('[Citations] Starting complete processing pipeline');
    console.log('[Citations] Available data:', {
        trials: Object.keys(citations.trials || {}).length,
        fda: Object.keys(citations.fda || {}).length,
        pubmed: Object.keys(citations.pubmed || {}).length,
        orangeBook: Object.keys(citations.orangeBook || {}).length
    });
    
    // Step 1: Auto-inject citations based on data
    let processed = autoInjectCitations(markdown, citations);
    
    // Step 2: Process all markers (both AI-generated and auto-injected)
    processed = processCitationMarkersRobust(processed, citations);
    
    // Step 3: Clean up any duplicate cards
    processed = processed.replace(
        /(<cite-card[^>]+><\/cite-card>)\s*\1/g, 
        '$1'
    );
    
    return processed;
}

/**
 * Process citation markers - robust version with flexible regex
 */
function processCitationMarkersRobust(markdown, citations) {
    if (!citations) return markdown;
    
    let processed = markdown;
    let converted = { trials: 0, fda: 0, pubmed: 0, ob: 0 };
    
    // Trial markers
    processed = processed.replace(/\[TRIAL:\s*(NCT\d+)\]/gi, (match, nctId) => {
        const normalized = nctId.toUpperCase();
        if (citations.trials?.[normalized]) {
            converted.trials++;
            return `<cite-card data-type="trial" data-id="${normalized}"></cite-card>`;
        }
        return '';
    });
    
    // PubMed markers
    processed = processed.replace(/\[PUBMED:\s*(\d+)\]/gi, (match, pmid) => {
        if (citations.pubmed?.[pmid]) {
            converted.pubmed++;
            return `<cite-card data-type="pubmed" data-id="${pmid}"></cite-card>`;
        }
        return '';
    });
    
    // FDA markers
    processed = processed.replace(/\[FDA:\s*([A-Za-z]*\d+)\]/gi, (match, appNum) => {
        const normalized = appNum.toUpperCase();
        const found = citations.fda?.[normalized] || 
                     citations.fda?.[`NDA${normalized}`] ||
                     citations.fda?.[`BLA${normalized}`] ||
                     citations.fda?.[`ANDA${normalized}`];
        
        if (found) {
            const key = Object.keys(citations.fda).find(k => 
                citations.fda[k] === found
            );
            converted.fda++;
            return `<cite-card data-type="fda" data-id="${key}"></cite-card>`;
        }
        return '';
    });
    
    // Orange Book markers
    processed = processed.replace(/\[OB:\s*([A-Za-z]*\d+)\]/gi, (match, applNo) => {
        const normalized = applNo.toUpperCase();
        const found = citations.orangeBook?.[normalized] ||
                     citations.orangeBook?.[`NDA${normalized}`];
        
        if (found) {
            const key = Object.keys(citations.orangeBook).find(k => 
                citations.orangeBook[k] === found
            );
            converted.ob++;
            return `<cite-card data-type="orangebook" data-id="${key}"></cite-card>`;
        }
        return '';
    });
    
    console.log('[Citations] Markers converted to cards:', converted);
    
    return processed;
}

// Expose to window
if (typeof window !== 'undefined') {
    window.autoInjectCitations = autoInjectCitations;
    window.processCitationsComplete = processCitationsComplete;
    window.processCitationMarkersRobust = processCitationMarkersRobust;
}

/**
 * ============================================
 * SMART CITATION DETECTION - FRONTEND ONLY
 * ============================================
 * 
 * Automatically detects IDs like NCT07293351, NDA218411, PMID12345678
 * in rendered markdown and wraps them with interactive citation cards.
 * 
 * Uses resultsState (already populated from API response) - no backend changes needed.
 * 
 * HOW TO USE:
 * 1. Add this entire script to ai.html (in the <script> section)
 * 2. Call `smartCitations.process(contentElement)` after markdown renders
 * 
 * That's it! The system will automatically detect and enhance IDs.
 */

const smartCitations = {
    
    // ========================================
    // CONFIGURATION
    // ========================================
    
    config: {
        // ID patterns to detect
        patterns: {
            trial: /\b(NCT\d{8})\b/gi,
            fda: /\b((?:NDA|BLA|ANDA)\s*\d{6,7})\b/gi,
            pubmed: /\b(?:PMID[:\s]*)?(\d{7,8})\b/gi  // Only match 7-8 digit numbers that might be PMIDs
        },
        // CSS classes
        classes: {
            wrapper: 'smart-cite',
            card: 'smart-cite-card',
            badge: 'smart-cite-badge'
        }
    },

    // ========================================
    // MAIN PROCESS FUNCTION
    // ========================================
    
    /**
     * Process a content element to detect and enhance citations
     * @param {HTMLElement} contentElement - The element containing rendered markdown
     */
    process(contentElement) {
        if (!contentElement) return;
        
        console.log('[SmartCitations] Processing content...');
        
        // Get available data from resultsState
        const availableData = this.getAvailableData();
        console.log('[SmartCitations] Available data:', {
            trials: availableData.trials.size,
            fda: availableData.fda.size,
            pubmed: availableData.pubmed.size
        });
        
        // Walk through text nodes and replace IDs
        this.walkTextNodes(contentElement, availableData);
        
        // Add event listeners to new citation elements
        this.attachEventListeners(contentElement);
        
        console.log('[SmartCitations] Processing complete');
    },

    // ========================================
    // DATA LOOKUP
    // ========================================
    
    /**
     * Build lookup maps from resultsState
     */
    getAvailableData() {
        const data = {
            trials: new Map(),
            fda: new Map(),
            pubmed: new Map(),
            ob: new Map()
        };
        
        // Build trial lookup by NCT ID
        if (resultsState?.trials?.data) {
            resultsState.trials.data.forEach(trial => {
                const nctId = trial.protocolSection?.identificationModule?.nctId;
                if (nctId) {
                    data.trials.set(nctId.toUpperCase(), trial);
                }
            });
        }
        
        // Build FDA lookup by application number
        if (resultsState?.fda?.data) {
            resultsState.fda.data.forEach(drug => {
                // Try various fields for app number
                const appNum = drug.application_number || 
                              drug.applicationNumber || 
                              drug.ApplNo ||
                              drug.openfda?.application_number?.[0];
                if (appNum) {
                    // Normalize: remove spaces, uppercase
                    const normalized = String(appNum).replace(/\s+/g, '').toUpperCase();
                    data.fda.set(normalized, drug);
                }
            });
        }
        
        // Build PubMed lookup by PMID
        if (resultsState?.pubmed?.data) {
            resultsState.pubmed.data.forEach(article => {
                const pmid = article.pmid || article.uid || article.PMID;
                if (pmid) {
                    data.pubmed.set(String(pmid), article);
                }
            });
        }
        
        // Build Orange Book lookup
        if (resultsState?.ob?.data) {
            resultsState.ob.data.forEach(entry => {
                const applNo = entry.Appl_No || entry.applNo || entry.application_number;
                if (applNo) {
                    const normalized = String(applNo).replace(/\s+/g, '').toUpperCase();
                    data.ob.set(normalized, entry);
                }
            });
        }
        
        return data;
    },

    /**
     * Find data for a given ID
     */
    findData(id, type, availableData) {
        const normalized = String(id).replace(/\s+/g, '').toUpperCase();
        
        if (type === 'trial') {
            return availableData.trials.get(normalized);
        }
        
        if (type === 'fda') {
            // Try with and without prefix
            return availableData.fda.get(normalized) ||
                   availableData.fda.get(`NDA${normalized}`) ||
                   availableData.fda.get(`ANDA${normalized}`) ||
                   availableData.fda.get(`BLA${normalized}`);
        }
        
        if (type === 'pubmed') {
            return availableData.pubmed.get(normalized);
        }
        
        return null;
    },

    // ========================================
    // TEXT NODE PROCESSING
    // ========================================
    
    /**
     * Walk through text nodes and replace IDs with citation elements
     */
    walkTextNodes(element, availableData) {
        const walker = document.createTreeWalker(
            element,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: (node) => {
                    // Skip if inside a link, code block, or already processed
                    const parent = node.parentElement;
                    if (!parent) return NodeFilter.FILTER_REJECT;
                    
                    const tag = parent.tagName.toLowerCase();
                    if (['a', 'code', 'pre', 'script', 'style'].includes(tag)) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    if (parent.classList.contains('smart-cite')) {
                        return NodeFilter.FILTER_REJECT;
                    }
                    
                    return NodeFilter.FILTER_ACCEPT;
                }
            }
        );
        
        const nodesToProcess = [];
        while (walker.nextNode()) {
            nodesToProcess.push(walker.currentNode);
        }
        
        // Process each text node
        nodesToProcess.forEach(textNode => {
            this.processTextNode(textNode, availableData);
        });
    },

    /**
     * Process a single text node
     */
    processTextNode(textNode, availableData) {
        const text = textNode.textContent;
        if (!text || text.trim().length === 0) return;
        
        // Check for NCT IDs (highest priority - most specific)
        const nctMatches = [...text.matchAll(this.config.patterns.trial)];
        
        // Check for FDA application numbers
        const fdaMatches = [...text.matchAll(this.config.patterns.fda)];
        
        // Check for PMIDs (only if we have PubMed data to verify)
        let pubmedMatches = [];
        if (availableData.pubmed.size > 0) {
            // More careful PMID detection - only match numbers we actually have
            const numberMatches = [...text.matchAll(/\b(\d{7,8})\b/g)];
            pubmedMatches = numberMatches.filter(m => availableData.pubmed.has(m[1]));
        }
        
        // Combine and sort all matches by position
        const allMatches = [
            ...nctMatches.map(m => ({ match: m, type: 'trial', id: m[1] })),
            ...fdaMatches.map(m => ({ match: m, type: 'fda', id: m[1].replace(/\s+/g, '') })),
            ...pubmedMatches.map(m => ({ match: m, type: 'pubmed', id: m[1] }))
        ].filter(item => {
            // Only keep matches where we have data
            return this.findData(item.id, item.type, availableData);
        }).sort((a, b) => a.match.index - b.match.index);
        
        if (allMatches.length === 0) return;
        
        // Build new HTML
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        
        allMatches.forEach(({ match, type, id }) => {
            const data = this.findData(id, type, availableData);
            if (!data) return;
            
            // Add text before this match
            if (match.index > lastIndex) {
                fragment.appendChild(
                    document.createTextNode(text.slice(lastIndex, match.index))
                );
            }
            
            // Create citation element
            const citeEl = this.createCitationElement(id, type, data);
            fragment.appendChild(citeEl);
            
            lastIndex = match.index + match[0].length;
        });
        
        // Add remaining text
        if (lastIndex < text.length) {
            fragment.appendChild(
                document.createTextNode(text.slice(lastIndex))
            );
        }
        
        // Replace the text node
        textNode.parentNode.replaceChild(fragment, textNode);
    },

    // ========================================
    // CITATION ELEMENT CREATION
    // ========================================
    
    /**
     * Create a citation badge/card element
     */
    createCitationElement(id, type, data) {
        const wrapper = document.createElement('span');
        wrapper.className = `smart-cite smart-cite-${type}`;
        wrapper.setAttribute('data-cite-type', type);
        wrapper.setAttribute('data-cite-id', id);
        
        // Create the badge (always visible)
        const badge = document.createElement('span');
        badge.className = 'smart-cite-badge';
        badge.innerHTML = this.getBadgeContent(id, type);
        
        // Create the card (shown on hover/click)
        const card = document.createElement('div');
        card.className = 'smart-cite-card';
        card.innerHTML = this.getCardContent(id, type, data);
        
        wrapper.appendChild(badge);
        wrapper.appendChild(card);
        
        return wrapper;
    },

    /**
     * Get badge inner HTML
     */
    getBadgeContent(id, type) {
        const icons = {
            trial: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>`,
            fda: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>`,
            pubmed: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>`
        };
        
        return `${icons[type] || ''}<span class="cite-id">${id}</span>`;
    },

    /**
     * Get card inner HTML based on data type
     */
    getCardContent(id, type, data) {
        if (type === 'trial') {
            return this.getTrialCardContent(id, data);
        }
        if (type === 'fda') {
            return this.getFDACardContent(id, data);
        }
        if (type === 'pubmed') {
            return this.getPubMedCardContent(id, data);
        }
        return `<div class="cite-card-title">${id}</div>`;
    },

    getTrialCardContent(id, trial) {
        const proto = trial.protocolSection || {};
        const idMod = proto.identificationModule || {};
        const statusMod = proto.statusModule || {};
        const designMod = proto.designModule || {};
        const sponsorMod = proto.sponsorCollaboratorsModule || {};
        
        const title = idMod.briefTitle || idMod.officialTitle || 'Untitled Study';
        const status = statusMod.overallStatus || 'Unknown';
        const phase = designMod.phases?.[0] || 'N/A';
        const sponsor = sponsorMod.leadSponsor?.name || 'Unknown Sponsor';
        const nctId = idMod.nctId || id;
        
        const statusColor = this.getStatusColor(status);
        
        return `
            <div class="cite-card-header trial">
                <span class="cite-card-type">Clinical Trial</span>
                <span class="cite-card-status" style="background: ${statusColor}">${status}</span>
            </div>
            <div class="cite-card-title">${this.escapeHtml(title)}</div>
            <div class="cite-card-meta">
                <span>${nctId}</span>
                <span>Ã¢â‚¬Â¢</span>
                <span>${this.formatPhase(phase)}</span>
            </div>
            <div class="cite-card-sponsor">${this.escapeHtml(sponsor)}</div>
            <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="cite-card-link">
                View on ClinicalTrials.gov Ã¢â€ â€™
            </a>
        `;
    },

    getFDACardContent(id, drug) {
        const tradeName = drug.brand_name || drug.tradeName || drug.DrugName || '';
        const genericName = drug.generic_name || drug.activeIngredient || drug.ActiveIngredient || '';
        const sponsor = drug.sponsor_name || drug.sponsor || drug.SponsorName || '';
        const appNum = drug.application_number || drug.applicationNumber || drug.ApplNo || id;
        const approvalDate = drug.approval_date || drug.approvalDate || drug.ApprovalDate || '';
        
        return `
            <div class="cite-card-header fda">
                <span class="cite-card-type">FDA Approval</span>
                ${approvalDate ? `<span class="cite-card-date">${approvalDate}</span>` : ''}
            </div>
            <div class="cite-card-title">${this.escapeHtml(tradeName || genericName || 'Drug Product')}</div>
            <div class="cite-card-meta">
                <span>${appNum}</span>
                ${genericName && tradeName ? `<span>Ã¢â‚¬Â¢</span><span>${this.escapeHtml(genericName)}</span>` : ''}
            </div>
            ${sponsor ? `<div class="cite-card-sponsor">${this.escapeHtml(sponsor)}</div>` : ''}
            <a href="https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?event=overview.process&ApplNo=${appNum.replace(/\D/g, '')}" target="_blank" class="cite-card-link">
                View on Drugs@FDA Ã¢â€ â€™
            </a>
        `;
    },

    getPubMedCardContent(id, article) {
        const title = article.title || article.Title || 'Article';
        const authors = article.authors || article.Author || [];
        const journal = article.source || article.journal || article.Journal || '';
        const year = article.pubdate || article.year || article.PubDate || '';
        const pmid = article.pmid || article.uid || id;
        
        // Format authors
        let authorStr = '';
        if (Array.isArray(authors) && authors.length > 0) {
            const firstAuthor = typeof authors[0] === 'string' ? authors[0] : authors[0].name;
            authorStr = authors.length > 1 ? `${firstAuthor} et al.` : firstAuthor;
        }
        
        return `
            <div class="cite-card-header pubmed">
                <span class="cite-card-type">PubMed Article</span>
                ${year ? `<span class="cite-card-date">${year}</span>` : ''}
            </div>
            <div class="cite-card-title">${this.escapeHtml(title)}</div>
            <div class="cite-card-meta">
                <span>PMID: ${pmid}</span>
                ${journal ? `<span>Ã¢â‚¬Â¢</span><span>${this.escapeHtml(journal)}</span>` : ''}
            </div>
            ${authorStr ? `<div class="cite-card-authors">${this.escapeHtml(authorStr)}</div>` : ''}
            <a href="https://pubmed.ncbi.nlm.nih.gov/${pmid}/" target="_blank" class="cite-card-link">
                View on PubMed Ã¢â€ â€™
            </a>
        `;
    },

    // ========================================
    // EVENT LISTENERS
    // ========================================
    
    attachEventListeners(container) {
        // The CSS handles hover for desktop
        // Add click handler for mobile/touch
        container.querySelectorAll('.smart-cite').forEach(cite => {
            cite.addEventListener('click', (e) => {
                // Toggle active class for mobile
                const wasActive = cite.classList.contains('active');
                
                // Close all others
                container.querySelectorAll('.smart-cite.active').forEach(c => {
                    c.classList.remove('active');
                });
                
                // Toggle this one
                if (!wasActive) {
                    cite.classList.add('active');
                }
                
                e.stopPropagation();
            });
        });
        
        // Click outside to close
        document.addEventListener('click', () => {
            container.querySelectorAll('.smart-cite.active').forEach(c => {
                c.classList.remove('active');
            });
        });
    },

    // ========================================
    // HELPERS
    // ========================================
    
    escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    getStatusColor(status) {
        const colors = {
            'RECRUITING': '#10b981',
            'ACTIVE_NOT_RECRUITING': '#f59e0b',
            'COMPLETED': '#6b7280',
            'TERMINATED': '#ef4444',
            'WITHDRAWN': '#ef4444',
            'SUSPENDED': '#f59e0b',
            'NOT_YET_RECRUITING': '#3b82f6',
            'ENROLLING_BY_INVITATION': '#8b5cf6'
        };
        return colors[status?.toUpperCase()] || '#6b7280';
    },

    formatPhase(phase) {
        if (!phase || phase === 'NA') return 'N/A';
        return phase.replace(/_/g, '/').replace('PHASE', 'Phase ');
    }
};

// ============================================
// CSS STYLES (add to <style> section)
// ============================================

const smartCitationStyles = `
/* Smart Citation Wrapper */
.smart-cite {
    position: relative;
    display: inline;
}

/* Citation Badge */
.smart-cite-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    vertical-align: baseline;
}

.smart-cite-badge svg {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
}

/* Trial badge - green */
.smart-cite-trial .smart-cite-badge {
    background: #ecfdf5;
    color: #047857;
    border: 1px solid #a7f3d0;
}
.smart-cite-trial .smart-cite-badge:hover,
.smart-cite-trial.active .smart-cite-badge {
    background: #d1fae5;
    border-color: #6ee7b7;
}

/* FDA badge - red */
.smart-cite-fda .smart-cite-badge {
    background: #fef2f2;
    color: #b91c1c;
    border: 1px solid #fecaca;
}
.smart-cite-fda .smart-cite-badge:hover,
.smart-cite-fda.active .smart-cite-badge {
    background: #fee2e2;
    border-color: #fca5a5;
}

/* PubMed badge - blue */
.smart-cite-pubmed .smart-cite-badge {
    background: #eff6ff;
    color: #1d4ed8;
    border: 1px solid #bfdbfe;
}
.smart-cite-pubmed .smart-cite-badge:hover,
.smart-cite-pubmed.active .smart-cite-badge {
    background: #dbeafe;
    border-color: #93c5fd;
}

/* Citation Card */
.smart-cite-card {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    width: 320px;
    max-width: 90vw;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    padding: 14px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
    pointer-events: none;
}

/* Show card on hover or active */
.smart-cite:hover .smart-cite-card,
.smart-cite.active .smart-cite-card {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-4px);
    pointer-events: auto;
}

/* Card positioning - flip if near top of viewport */
.smart-cite-card.flip-down {
    bottom: auto;
    top: 100%;
    transform: translateX(-50%) translateY(8px);
}
.smart-cite:hover .smart-cite-card.flip-down,
.smart-cite.active .smart-cite-card.flip-down {
    transform: translateX(-50%) translateY(4px);
}

/* Card arrow */
.smart-cite-card::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: white;
}
.smart-cite-card.flip-down::after {
    top: auto;
    bottom: 100%;
    border-top-color: transparent;
    border-bottom-color: white;
}

/* Card Header */
.cite-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.cite-card-type {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 3px 8px;
    border-radius: 4px;
}

.cite-card-header.trial .cite-card-type {
    background: #ecfdf5;
    color: #047857;
}
.cite-card-header.fda .cite-card-type {
    background: #fef2f2;
    color: #b91c1c;
}
.cite-card-header.pubmed .cite-card-type {
    background: #eff6ff;
    color: #1d4ed8;
}

.cite-card-status {
    font-size: 0.65rem;
    font-weight: 500;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
}

.cite-card-date {
    font-size: 0.7rem;
    color: #6b7280;
}

/* Card Title */
.cite-card-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.4;
    margin-bottom: 6px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Card Meta */
.cite-card-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.7rem;
    color: #6b7280;
    margin-bottom: 4px;
}

.cite-card-sponsor,
.cite-card-authors {
    font-size: 0.7rem;
    color: #9ca3af;
    margin-bottom: 8px;
}

/* Card Link */
.cite-card-link {
    display: inline-flex;
    align-items: center;
    font-size: 0.75rem;
    font-weight: 500;
    color: #2563eb;
    text-decoration: none;
    padding-top: 8px;
    border-top: 1px solid #f3f4f6;
    margin-top: 4px;
}
.cite-card-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}
`;

// ============================================
// AUTO-INJECT STYLES
// ============================================

function injectSmartCitationStyles() {
    if (document.getElementById('smart-citation-styles')) return;
    
    const styleEl = document.createElement('style');
    styleEl.id = 'smart-citation-styles';
    styleEl.textContent = smartCitationStyles;
    document.head.appendChild(styleEl);
}

// Inject styles on load
if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectSmartCitationStyles);
    } else {
        injectSmartCitationStyles();
    }
}

// ============================================
// INTEGRATION HELPER
// ============================================

/**
 * Easy integration function - call after markdown renders
 * Example: processSmartCitations('content-stream-123')
 */
function processSmartCitations(streamId) {
    const contentEl = document.getElementById(`content-${streamId}`);
    if (contentEl) {
        // Small delay to ensure markdown is fully rendered
        setTimeout(() => {
            smartCitations.process(contentEl);
        }, 100);
    }
}

// Expose globally
if (typeof window !== 'undefined') {
    window.smartCitations = smartCitations;
    window.processSmartCitations = processSmartCitations;
}
/**
 * Render inline citation cards after markdown processing
 * Replaces <cite-card> placeholders with actual card HTML
 */
function renderInlineCitationCards(streamId, citations) {
    if (!citations) return;
    
    const contentDiv = document.getElementById(`content-${streamId}`);
    if (!contentDiv) return;
    
    // Find all citation card placeholders
    const citeCards = contentDiv.querySelectorAll('cite-card');
    
    citeCards.forEach(card => {
        const type = card.getAttribute('data-type');
        const id = card.getAttribute('data-id');
        
        // Get the data for this citation
        let data = null;
        if (type === 'trial') data = citations.trials?.[id];
        else if (type === 'pubmed') data = citations.pubmed?.[id];
        else if (type === 'fda') data = citations.fda?.[id];
        else if (type === 'orangebook') data = citations.orangeBook?.[id];
        
        if (!data) {
            card.remove();
            return;
        }
        
        // Generate card HTML
        const cardHTML = createInlineCitationCard(type, data);
        
        // Replace placeholder with actual card
        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHTML;
        card.replaceWith(wrapper.firstChild);
    });
}

/**
 * Create inline citation card HTML
 */
function createInlineCitationCard(type, data) {
    const configs = {
        trial: {
            color: '#059669',
            icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01',
            getTitle: (d) => d.briefTitle || d.officialTitle || d.title || d.nctId,
            getSubtitle: (d) => {
                const parts = [];
                if (d.nctId) parts.push(d.nctId);
                if (d.status) parts.push(d.status);
                if (d.phase) parts.push(`Phase ${d.phase}`);
                return parts.join('  ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢');
            }
        },
        pubmed: {
            color: '#2563eb',
            icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
            getTitle: (d) => d.title || 'PubMed Article',
            getSubtitle: (d) => {
                const parts = [];
                if (d.authors && d.authors.length > 0) {
                    const firstAuthor = d.authors[0];
                    parts.push(firstAuthor + (d.authors.length > 1 ? ' et al.' : ''));
                }
                if (d.journal) parts.push(d.journal);
                if (d.year) parts.push(`(${d.year})`);
                return parts.join(' ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ');
            }
        },
        fda: {
            color: '#dc2626',
            icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
            getTitle: (d) => d.tradeName || d.drugName || d.productName || 'FDA Approval',
            getSubtitle: (d) => {
                const parts = [];
                if (d.applicationNumber) parts.push(d.applicationNumber);
                if (d.approvalDate) parts.push(`Approved ${d.approvalDate}`);
                return parts.join(' ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ');
            }
        },
        orangebook: {
            color: '#ea580c',
            icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
            getTitle: (d) => d.tradeName || d.ingredient || 'Orange Book Entry',
            getSubtitle: (d) => {
                const parts = [];
                if (d.applNo) parts.push(d.applNo);
                if (d.patentExpireDate) parts.push(`Patent expires: ${d.patentExpireDate}`);
                return parts.join(' ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ');
            }
        }
    };
    
    const config = configs[type];
    const title = config.getTitle(data);
    const subtitle = config.getSubtitle(data);
    
    return `
        <div class="inline-cite-card">
            <div class="cite-icon" style="background: ${config.color};">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="${config.icon}"/>
                </svg>
            </div>
            <div class="cite-content">
                <div class="cite-title">${escapeHtml(title)}</div>
                <div class="cite-subtitle">${escapeHtml(subtitle)}</div>
            </div>
        </div>
    `;
}
// ============================================
// SOURCE FILES RENDERING & PDF VIEWER
// ============================================

/**
 * Render source files panel for a response
 */
function renderSourceFiles(streamId, sourceFiles) {
    const panel = document.getElementById(`sourceFiles-${streamId}`);
    const list = document.getElementById(`sourceFilesList-${streamId}`);
    const count = document.getElementById(`sourceFilesCount-${streamId}`);
    
    if (!sourceFiles || sourceFiles.length === 0) {
        if (panel) panel.style.display = 'none';
        return;
    }
    
    // Show panel
    panel.style.display = 'block';
    count.textContent = sourceFiles.length;
    
    // Clear and populate list
    list.innerHTML = '';
    
    sourceFiles.forEach(file => {
        const isPdf = file.filename?.toLowerCase().endsWith('.pdf');
        const isDoc = file.filename?.toLowerCase().match(/\.(doc|docx)$/);
        const fileSize = formatFileSize(file.bytes);
        
        const fileItem = document.createElement('div');
        fileItem.className = 'source-file-item';
        
        // Determine icon type
        let iconType = 'default';
        let iconPath = 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z';
        
        if (isPdf) {
            iconType = 'pdf';
            iconPath = 'M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z';
        } else if (isDoc) {
            iconType = 'doc';
        }
        
        // Build quote section if available
        let quoteHtml = '';
        if (file.quote) {
            const truncatedQuote = file.quote.length > 150 
                ? file.quote.substring(0, 150) + '...' 
                : file.quote;
            quoteHtml = `<div class="source-file-quote">"${escapeHtml(truncatedQuote)}"</div>`;
        }
        
        fileItem.innerHTML = `
            <div class="source-file-icon ${iconType}">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"/>
                </svg>
            </div>
            <div class="source-file-info">
                <div class="source-file-name" title="${escapeHtml(file.filename)}">${escapeHtml(file.filename)}</div>
                <div class="source-file-meta">
                    ${fileSize ? `<span>${fileSize}</span>` : ''}
                    ${file.score ? `<span>• Relevance: ${Math.round(file.score * 100)}%</span>` : ''}
                </div>
                ${quoteHtml}
            </div>
            <div class="source-file-actions">
                ${isPdf ? `
                    <button class="source-file-btn view" onclick="openPdfViewer('${file.id}', '${escapeHtml(file.filename)}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        View
                    </button>
                ` : ''}
                <a href="${file.downloadUrl}" download="${file.filename}" class="source-file-btn download">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download
                </a>
            </div>
        `;
        
        list.appendChild(fileItem);
    });
    
    // Auto-expand if few files
    if (sourceFiles.length <= 3) {
        toggleSourceFiles(streamId, true);
    }
}

/**
 * Toggle source files panel visibility
 */
function toggleSourceFiles(streamId, forceExpand = null) {
    const header = document.querySelector(`#sourceFiles-${streamId} .source-files-header`);
    const body = document.getElementById(`sourceFilesBody-${streamId}`);
    
    if (!header || !body) return;
    
    const shouldExpand = forceExpand !== null ? forceExpand : !body.classList.contains('expanded');
    
    if (shouldExpand) {
        header.classList.add('expanded');
        body.classList.add('expanded');
    } else {
        header.classList.remove('expanded');
        body.classList.remove('expanded');
    }
}

/**
 * Open PDF viewer modal
 */
function openPdfViewer(fileId, filename) {
    const modal = document.getElementById('pdfViewerModal');
    const frame = document.getElementById('pdfViewerFrame');
    const title = document.getElementById('pdfViewerTitle');
    const downloadBtn = document.getElementById('pdfDownloadBtn');
    const newTabBtn = document.getElementById('pdfNewTabBtn');
    
    const viewUrl = `/api/vector-files/${fileId}/view`;
    const downloadUrl = `/api/vector-files/${fileId}/content`;
    
    title.textContent = filename || 'Document';
    frame.src = viewUrl;
    downloadBtn.href = downloadUrl;
    downloadBtn.download = filename;
    newTabBtn.href = viewUrl;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

/**
 * Close PDF viewer modal
 */
function closePdfViewer() {
    const modal = document.getElementById('pdfViewerModal');
    const frame = document.getElementById('pdfViewerFrame');
    
    modal.style.display = 'none';
    frame.src = '';
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closePdfViewer();
    }
});
// ============================================
// CONDUCT RESEARCH - UPDATED FOR /query
// ============================================
// async function conductResearch(streamId, question, files = [], reasoningLevel = 'quick') {
//     try {
//         // Update thinking steps progressively
//         updateThinkingStep(streamId, 'understand', 'active');
//         updateResponseStatus(streamId, 'processing', 'Analyzing...');
        
//         await new Promise(resolve => setTimeout(resolve, 600));
//         updateThinkingStep(streamId, 'understand', 'completed');
//         updateThinkingStep(streamId, 'search', 'active');
//         updateResponseStatus(streamId, 'processing', 'Searching databases...');

//         // Call the API
//         const data = await queryRegulatoryAPI(question, files, reasoningLevel);
        
//         await new Promise(resolve => setTimeout(resolve, 400));
//         updateThinkingStep(streamId, 'search', 'completed');
//         updateThinkingStep(streamId, 'synthesize', 'active');
//         updateResponseStatus(streamId, 'processing', 'Synthesizing...');

    
//         // Get the LLM response and citations
//         const llmResponse = data.response?.llm || 'No response generated.';
//         const citations = data.response?.citations || null;
        
//         // Store citations globally for later use
//         currentCitations = citations;
        
//         // Process citation markers BEFORE rendering
// // Process citations: auto-inject + convert markers to cards
// const processedResponse = processCitationsComplete(llmResponse, citations);        
//         // Store in history
//         conversationHistory.push({
//             role: 'assistant',
//             content: llmResponse,
//             timestamp: new Date().toISOString()
//         });

//         // Render the response
//         const contentDiv = document.getElementById(`content-${streamId}`);
//         if (contentDiv) {
//             // Simulate streaming effect with processed content
//             await simulateStreaming(contentDiv, processedResponse, streamId);
            
//             // AFTER markdown rendering, replace cite-card placeholders with rich cards
//             // renderInlineCitationCards(streamId, citations);
//              processSmartCitations(streamId);
//         }

//         // Handle chart data and stats from followup queries - render in RIGHT PANEL
//         const chartData = data.response?.chartData;
//         const statsResults = data.response?.statsResults;
//         const isFollowup = data.isFollowup;
        
//         console.log('[conductResearch] Stats handling:', {
//             isFollowup,
//             hasChartData: !!chartData,
//             hasStatsResults: !!statsResults,
//             queryType: data.queryType
//         });
        
//         if (isFollowup && (chartData || statsResults)) {
//             // Show stats in the right panel
//             showStatsInPanel(chartData, statsResults);
            
//             // For stats followups, don't re-process results data (it would hide the stats tab)
//             // Just complete the response
//             completeThinkingSteps(streamId);
//             updateResponseStatus(streamId, '', 'Complete');
            
//             // Still show follow-up questions
//            // Show data view button for stats
// const followupsContainer = document.getElementById(`followups-${streamId}`);
// if (followupsContainer) {
//     followupsContainer.style.display = 'block';
//     addDataViewButtons(streamId, { stats: true });
// }
            
//             return; // Skip the normal results processing
//         }

//         // Complete all steps
//         completeThinkingSteps(streamId);
//         updateResponseStatus(streamId, '', 'Complete');

//         // Process and display raw results (only for non-followup or if new data)
//         const sources = processResultsData(data);
        
//         // Add source badges to the response
//         addSourceBadges(streamId, sources);

//         // Show references section
//         const referencesContainer = document.getElementById(`references-${streamId}`);
//         if (referencesContainer && (sources.trials || sources.fda || sources.ob || sources.pubmed)) {
//             referencesContainer.style.display = 'block';
//             const refCount = document.getElementById(`refCount-${streamId}`);
//             const totalSources = (sources.trialsCount || 0) + (sources.fdaCount || 0) + 
//                                 (sources.obCount || 0) + (sources.pubmedCount || 0);
//             if (refCount) {
//                 refCount.textContent = `${totalSources} sources found`;
//             }
//         }

//         // Show follow-ups
//         // const followupsContainer = document.getElementById(`followups-${streamId}`);
//         // if (followupsContainer) {
//         //     followupsContainer.style.display = 'block';
//         //     addFollowUpQuestions(streamId, question);
//         // }
//         // Show data view buttons
// const followupsContainer = document.getElementById(`followups-${streamId}`);
// if (followupsContainer) {
//     followupsContainer.style.display = 'block';
//     addDataViewButtons(streamId, sources);
// }

//         // Update source count
//         const sourceCount = document.getElementById(`sourceCount-${streamId}`);
//         if (sourceCount) {
//             // Add followup indicator if applicable
//             if (data.isFollowup) {
//                 sourceCount.innerHTML = `<span class="followup-indicator">ÃƒÂ°Ã…Â¸Ã¢â‚¬Å“Ã…Â  ${data.queryType === 'research' ? 'Research' : 'Stats'}</span> ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ` + getSourceCountHTML(sources);
//             } else {
//                 sourceCount.innerHTML = getSourceCountHTML(sources);
//             }
//         }

//         // Store response
//         responseMarkdown.set(streamId, llmResponse);
//         window.userPrompts.set(streamId, question);

//     } catch (error) {
//         console.error('Research error:', error);
//         const contentDiv = document.getElementById(`content-${streamId}`);
//         if (contentDiv) {
//             contentDiv.innerHTML = `
//                 <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
//                     <p class="text-red-700 font-medium">Error processing your request</p>
//                     <p class="text-red-600 text-sm mt-1">${escapeHtml(error.message)}</p>
//                 </div>
//             `;
//         }
//         updateResponseStatus(streamId, 'error', 'Error');
//     }
    
//     isProcessing = false;
// }
async function conductResearch(streamId, question, files = [], reasoningLevel = 'quick') {
    try {
        updateThinkingStep(streamId, 'understand', 'active');
        updateResponseStatus(streamId, 'processing', 'Analyzing...');

        await new Promise(r => setTimeout(r, 500));
        
        updateThinkingStep(streamId, 'understand', 'completed');
        updateThinkingStep(streamId, 'search', 'active');
        updateResponseStatus(streamId, 'processing', 'Searching databases...');

        // Call the API
        const data = await queryRegulatoryAPI(question, files, reasoningLevel);

        updateThinkingStep(streamId, 'search', 'completed');
        updateThinkingStep(streamId, 'synthesize', 'active');
        updateResponseStatus(streamId, 'processing', 'Synthesizing...');

        // Get the LLM response
        const llmResponse = data?.response?.llm || 'No response received.';
        
        // Process citations
        const citations = data?.response?.citations || {};
        // const processedResponse = processInlineCitations(llmResponse, citations);
        const processedResponse = processCitationsComplete(llmResponse, citations);
        
        // Render the response
        const contentDiv = document.getElementById(`content-${streamId}`);
        if (contentDiv) {
            await simulateStreaming(contentDiv, processedResponse, streamId);
        }
        
        // Process smart citations
        processSmartCitations(streamId);

        // ✅ NEW: Render source files if available
        if (data?.response?.sourceFiles && data.response.sourceFiles.length > 0) {
            console.log(`[Frontend] Rendering ${data.response.sourceFiles.length} source files`);
            renderSourceFiles(streamId, data.response.sourceFiles);
        }

        // Complete steps
        completeThinkingSteps(streamId);
        updateResponseStatus(streamId, '', 'Complete');

        // Handle data view buttons
        const sources = {
            trials: data?.raw?.clinicalTrials?.length > 0,
            fda: data?.raw?.fda?.length > 0,
            orangeBook: data?.raw?.orangeBook?.length > 0,
            pubmed: data?.raw?.pubmed?.length > 0,
            stats: data?.isFollowup
        };

        const followupsContainer = document.getElementById(`followups-${streamId}`);
        if (followupsContainer && Object.values(sources).some(v => v)) {
            addDataViewButtons(streamId, sources);
        }

        // Store markdown for export
        responseMarkdown.set(streamId, llmResponse);

    } catch (error) {
        console.error('[conductResearch] Error:', error);
        completeThinkingSteps(streamId);
        updateResponseStatus(streamId, '', 'Error');
        
        const contentDiv = document.getElementById(`content-${streamId}`);
        if (contentDiv) {
            contentDiv.innerHTML = `
                <div class="error-message">
                    <p>An error occurred while processing your request.</p>
                    <p class="error-details">${escapeHtml(error.message)}</p>
                </div>
            `;
        }
    }
}
// Simulate streaming effect for the response
async function simulateStreaming(contentDiv, text, streamId) {
    const words = text.split(' ');
    let displayedText = '';
    
    for (let i = 0; i < words.length; i++) {
        displayedText += (i === 0 ? '' : ' ') + words[i];
        contentDiv.innerHTML = renderMarkdownToHTML(displayedText) + 
            `<span id="typing-loader-${streamId}" class="stream-cursor"></span>`;
        
        // Scroll to keep visible
        contentDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
        
        // Variable delay for natural feel
        const delay = Math.random() * 20 + 10;
        await new Promise(resolve => setTimeout(resolve, delay));
    }
    
    // Final render without cursor
    contentDiv.innerHTML = renderMarkdownToHTML(displayedText);
}

// Get source count HTML
function getSourceCountHTML(sources) {
    const parts = [];
    if (sources.trialsCount) parts.push(`<span class="text-emerald-600">${sources.trialsCount} trials</span>`);
    if (sources.fdaCount) parts.push(`<span class="text-red-600">${sources.fdaCount} FDA</span>`);
    if (sources.obCount) parts.push(`<span class="text-orange-600">${sources.obCount} patents</span>`);
    if (sources.pubmedCount) parts.push(`<span class="text-blue-600">${sources.pubmedCount} articles</span>`);
    
    if (parts.length === 0) return 'Analysis complete';
    return parts.join(' ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ');
}

// Add source badges to response header
function addSourceBadges(streamId, sources) {
    const headerInfo = document.querySelector(`#${streamId} .ai-info`);
    if (!headerInfo) return;
    
    let badgesHTML = '<div class="source-badges" style="margin-top: 4px;">';
    
    if (sources.trials) badgesHTML += '<span class="source-badge trials"><span class="source-dot trials"></span>Trials</span>';
    if (sources.fda) badgesHTML += '<span class="source-badge fda"><span class="source-dot fda"></span>FDA</span>';
    if (sources.ob) badgesHTML += '<span class="source-badge ob"><span class="source-dot ob"></span>Patents</span>';
    if (sources.pubmed) badgesHTML += '<span class="source-badge pubmed"><span class="source-dot pubmed"></span>Literature</span>';
    
    badgesHTML += '</div>';
    
    // Only add if we have sources
    if (sources.trials || sources.fda || sources.ob || sources.pubmed) {
        const existing = headerInfo.querySelector('.source-badges');
        if (existing) existing.remove();
        headerInfo.insertAdjacentHTML('beforeend', badgesHTML);
    }
}

// ============================================
// RESULTS PANEL FUNCTIONS
// ============================================

function processResultsData(data) {
    const raw = data.raw || {};
    
    // Handle clinical trials - can be array directly or nested under 'studies'
    const trialsData = raw.clinicalTrials?.studies || raw.clinicalTrials || [];
    const trialsArray = Array.isArray(trialsData) ? trialsData : [];
    
    const hasTrials = trialsArray.length > 0;
    const hasFda = raw.fda?.length > 0;
    const hasOb = raw.orangeBook?.length > 0;
    const hasPubmed = raw.pubmed?.length > 0;
    const hasAny = hasTrials || hasFda || hasOb || hasPubmed;
    
    // For NEW searches (not followups), reset stats
    // For followups, preserve stats that were set by showStatsInPanel
    const isFollowup = data.isFollowup;
    const hasStats = isFollowup ? resultsState.stats.hasData : false;
    
    console.log('[processResultsData]', {
        isFollowup,
        hasTrials,
        hasPubmed,
        hasStats,
        statsHasData: resultsState.stats.hasData
    });
    
    // Reset stats for new searches
    if (!isFollowup) {
        resultsState.stats = { chartData: null, statsResults: null, hasData: false };
    }
    
    // Update state
    resultsState.trials.data = trialsArray;
    resultsState.trials.filteredData = []; // Reset filtered data
    resultsState.trials.page = 1;
    resultsState.fda.data = hasFda ? raw.fda : [];
    resultsState.fda.page = 1;
    resultsState.ob.data = hasOb ? raw.orangeBook : [];
    resultsState.ob.page = 1;
    resultsState.pubmed.data = hasPubmed ? raw.pubmed : [];
    resultsState.pubmed.page = 1;
    
    // Reset trials filters when new data comes in
    trialsFilters.hasResults = false;
    trialsFilters.isCompleted = false;
    Object.keys(trialsFilters.phaseFilters).forEach(phase => {
        trialsFilters.phaseFilters[phase] = true;
    });
    
    // Update tabs visibility and counts - PRESERVE stats tab for followups
    updateResultsTabs(hasTrials, hasFda, hasOb, hasPubmed, hasStats);
    
    // Open panel and select first available tab (only for non-followups with new data)
    // if (hasAny && !isFollowup) {
    //     openResultsPanel();
        
    //     if (hasTrials) switchResultsTab('trials');
    //     else if (hasFda) switchResultsTab('fda');
    //     else if (hasOb) switchResultsTab('ob');
    //     else if (hasPubmed) switchResultsTab('pubmed');
    // }
    
return {
    trials: hasTrials,
    fda: hasFda,
    ob: hasOb,
    pubmed: hasPubmed,
    stats: hasStats,  // ADD THIS LINE
    trialsCount: resultsState.trials.data.length,
    fdaCount: resultsState.fda.data.length,
    obCount: resultsState.ob.data.length,
    pubmedCount: resultsState.pubmed.data.length
};
}

function updateResultsTabs(hasTrials, hasFda, hasOb, hasPubmed, hasStats = false) {
    const tabStats = document.getElementById('tabStats');
    const tabTrials = document.getElementById('tabTrials');
    const tabFda = document.getElementById('tabFda');
    const tabOb = document.getElementById('tabOb');
    const tabPubmed = document.getElementById('tabPubmed');
    
    // Handle stats tab
    if (hasStats) {
        tabStats?.classList.remove('hidden');
    } else {
        tabStats?.classList.add('hidden');
    }
    
    if (hasTrials) {
        tabTrials.classList.remove('hidden');
        document.getElementById('trialsCount').textContent = resultsState.trials.data.length;
    } else {
        tabTrials.classList.add('hidden');
    }
    
    if (hasFda) {
        tabFda.classList.remove('hidden');
        document.getElementById('fdaCount').textContent = resultsState.fda.data.length;
    } else {
        tabFda.classList.add('hidden');
    }
    
    if (hasOb) {
        tabOb.classList.remove('hidden');
        document.getElementById('obCount').textContent = resultsState.ob.data.length;
    } else {
        tabOb.classList.add('hidden');
    }
    
    if (hasPubmed) {
        tabPubmed.classList.remove('hidden');
        document.getElementById('pubmedCount').textContent = resultsState.pubmed.data.length;
    } else {
        tabPubmed.classList.add('hidden');
    }
}

/**
 * Show stats in the results panel (called when followup stats response arrives)
 */
function showStatsInPanel(chartData, statsResults) {
    console.log('[Stats Panel] showStatsInPanel called', {
        hasChartData: !!chartData,
        hasStatsResults: !!statsResults,
        chartDataLength: Array.isArray(chartData) ? chartData.length : (chartData ? 1 : 0)
    });
    
    // Store in resultsState
    resultsState.stats = {
        chartData: Array.isArray(chartData) ? chartData : (chartData ? [chartData] : null),
        statsResults: statsResults,
        hasData: !!(chartData || statsResults)
    };
    
    console.log('[Stats Panel] State updated, hasData:', resultsState.stats.hasData);
    
    // Show the stats tab
    const tabStats = document.getElementById('tabStats');
    if (tabStats) {
        tabStats.classList.remove('hidden');
        console.log('[Stats Panel] Stats tab shown');
    } else {
        console.error('[Stats Panel] tabStats element not found!');
    }
    
    // Open panel and switch to stats tab
    openResultsPanel();
    switchResultsTab('stats');
}

function openResultsPanel() {
    if (!resultsState.panelOpen) {
        resultsState.panelOpen = true;
        const panel = document.getElementById('resultsPanel');
        const chatWrapper = document.getElementById('chatWrapper');
        
        if (panel) panel.classList.remove('hidden');
        if (chatWrapper) chatWrapper.classList.add('with-results');
    }
}

function closeResultsPanel() {
    resultsState.panelOpen = false;
    const panel = document.getElementById('resultsPanel');
    const chatWrapper = document.getElementById('chatWrapper');
    
    if (panel) panel.classList.add('hidden');
    if (chatWrapper) chatWrapper.classList.remove('with-results');
}

function switchResultsTab(tab) {
    console.log('[switchResultsTab] Switching to:', tab);
    resultsState.activeTab = tab;
    
    // Update tab buttons - include stats
    ['stats', 'trials', 'fda', 'ob', 'pubmed'].forEach(t => {
        const btnId = t === 'stats' ? 'tabStats' : `tab${t.charAt(0).toUpperCase() + t.slice(1)}`;
        const btn = document.getElementById(btnId);
        const content = document.getElementById(`${t}Results`);
        
        if (t === tab) {
            btn?.classList.add('active');
            content?.classList.add('active');
            if (t === 'stats') {
                console.log('[switchResultsTab] Stats tab activated, btn classes:', btn?.className);
            }
        } else {
            btn?.classList.remove('active');
            content?.classList.remove('active');
        }
    });
    
    // Add trials filters if switching to trials tab
    if (tab === 'trials') {
        addTrialsFilters();
    } else {
        removeTrialsFilters();
    }
    
    // Handle stats tab rendering
    if (tab === 'stats') {
        renderStatsPanel();
    } else {
        renderCurrentResultsTab();
        updateResultsPagination();
    }
}

/**
 * Render the stats panel with chart and summary
 */
function renderStatsPanel() {
    console.log('[renderStatsPanel] Called');
    
    const summaryPanel = document.getElementById('statsSummaryPanel');
    const chartPanel = document.getElementById('statsChartPanel');
    
    if (!summaryPanel || !chartPanel) {
        console.error('[renderStatsPanel] Missing panel elements:', { summaryPanel: !!summaryPanel, chartPanel: !!chartPanel });
        return;
    }
    
    const { chartData, statsResults, hasData } = resultsState.stats;
    
    console.log('[renderStatsPanel] Data:', {
        hasData,
        chartDataLength: chartData?.length || 0,
        hasStatsResults: !!statsResults
    });
    
    if (!hasData) {
        summaryPanel.innerHTML = '<p class="text-gray-500 text-center py-4">No statistical analysis available yet. Ask a followup question about your search results.</p>';
        chartPanel.innerHTML = '';
        return;
    }
    
    // Render stats summary
    if (statsResults && statsResults.result) {
        renderStatsSummaryInPanel(summaryPanel, statsResults);
    } else {
        summaryPanel.innerHTML = '';
    }
    
    // Render chart
    if (chartData && chartData.length > 0) {
        chartPanel.innerHTML = ''; // Clear previous
        chartData.forEach((chart, idx) => {
            console.log('[renderStatsPanel] Rendering chart:', idx, chart?.type, chart?.title);
            if (chart && chart.data) {
                const chartContainerId = `statsPanelChart-${idx}`;

// Create wrapper for proper vertical spacing
const chartWrapper = document.createElement('div');
chartWrapper.className = 'chart-item-wrapper';

// Create chart container
const chartDiv = document.createElement('div');
chartDiv.id = chartContainerId;
chartDiv.className = 'chart-item-container';

chartWrapper.appendChild(chartDiv);
chartPanel.appendChild(chartWrapper);
                
                // Use existing renderChart function
                renderChart(chartContainerId, chart);
            }
        });
    } else {
        chartPanel.innerHTML = '<p class="text-gray-400 text-center">No chart data available</p>';
    }
}

/**
 * Render stats summary in the panel
 */
function renderStatsSummaryInPanel(container, statsResults) {
    const result = statsResults.result;
    if (!result) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<div class="stats-summary-grid">';
    
    if (statsResults.operation === 'enrollment_stats' && result.average) {
        html += `
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.average?.toLocaleString() || 'N/A'}</div>
                <div class="stats-summary-label">Avg Enrollment</div>
            </div>
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.median?.toLocaleString() || 'N/A'}</div>
                <div class="stats-summary-label">Median</div>
            </div>
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.min?.toLocaleString() || 'N/A'} - ${result.max?.toLocaleString() || 'N/A'}</div>
                <div class="stats-summary-label">Range</div>
            </div>
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.trialsWithData || 0}/${statsResults.sampleSize || 0}</div>
                <div class="stats-summary-label">Trials w/ Data</div>
            </div>
        `;
    } else if (result.trialsWithPlacebo !== undefined) {
        html += `
            <div class="stats-summary-item highlight">
                <div class="stats-summary-value">${result.trialsWithPlacebo}</div>
                <div class="stats-summary-label">Placebo-Controlled</div>
            </div>
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.trialsWithoutPlacebo}</div>
                <div class="stats-summary-label">Non-Placebo</div>
            </div>
            <div class="stats-summary-item">
                <div class="stats-summary-value">${result.percentageWithPlacebo}</div>
                <div class="stats-summary-label">Percentage</div>
            </div>
        `;
    } else if (result.totalTrials !== undefined) {
        html += `
            <div class="stats-summary-item large">
                <div class="stats-summary-value">${result.totalTrials}</div>
                <div class="stats-summary-label">Total Trials</div>
            </div>
        `;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function renderCurrentResultsTab() {
    if (!resultsState.activeTab) return;
    
    const tabState = resultsState[resultsState.activeTab];
    const cardsContainer = document.getElementById(`${resultsState.activeTab}Cards`);
    
    if (!cardsContainer) return;
    
    // Use filtered data for trials, regular data for others
    let displayData;
    if (resultsState.activeTab === 'trials') {
        displayData = tabState.filteredData && tabState.filteredData.length > 0 
            ? tabState.filteredData 
            : tabState.data;
    } else {
        displayData = tabState.data;
    }
    
    const { page, perPage } = tabState;
    
    if (!displayData.length) {
        cardsContainer.innerHTML = `
            <div class="results-empty">
                <svg class="results-empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="results-empty-text">No results found</p>
            </div>
        `;
        return;
    }
    
    const start = (page - 1) * perPage;
    const pageData = displayData.slice(start, start + perPage);
    let html = '';
    if (resultsState.activeTab === 'trials') {
        html += '<div class="trials-cards-container">' + pageData.map(renderTrialCard).join('') + '</div>';
    } else if (resultsState.activeTab === 'fda') {
        html = pageData.map(renderFDACard).join('');
    } else if (resultsState.activeTab === 'ob') {
        html = pageData.map(renderOBCard).join('');
    } else if (resultsState.activeTab === 'pubmed') {
        html = pageData.map(renderPubMedCard).join('');
    }
    
    cardsContainer.innerHTML = html;
    
    // Update trials count display if on trials tab
    if (resultsState.activeTab === 'trials') {
        updateTrialsCount(displayData.length);
    }
    
    // Scroll to top of results
    const resultsContent = document.getElementById('resultsContent');
    if (resultsContent) resultsContent.scrollTop = 0;
}

// ============================================
// TRIALS TIMELINE GENERATOR
// ============================================


// ============================================
// TRIALS FILTERS
// ============================================

function addTrialsFilters() {
    // Check if filters already exist
    if (document.getElementById('trials-filter-section')) return;
    
    const resultsContent = document.getElementById('trialsResults');
    if (!resultsContent) return;
    
    const filterSection = document.createElement('div');
    filterSection.id = 'trials-filter-section';
    filterSection.className = 'trials-filter-section p-4 bg-white border-b border-gray-200 mb-4';
    filterSection.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <button onclick="toggleTrialsFilters()" class="flex items-center text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">
                <svg id="trials-filter-chevron" class="w-4 h-4 mr-1.5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <svg class="w-4 h-4 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                </svg>
                Filter Trials
            </button>
            <button onclick="resetTrialsFilters()" class="text-xs text-gray-500 hover:text-gray-700 flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Reset
            </button>
        </div>
        
        <!-- Collapsible Filter Content (closed by default) -->
        <div id="trials-filter-content" class="overflow-hidden transition-all duration-300" style="max-height: 0; opacity: 0;">
            <div class="pt-2">
                <!-- Toggle filters -->
                <div class="flex flex-wrap gap-4 mb-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <div class="toggle-switch-small">
                            <input type="checkbox" id="filter-has-results" onchange="applyTrialsFilters()" ${trialsFilters.hasResults ? 'checked' : ''}>
                            <span class="toggle-slider-small green"></span>
                        </div>
                        <span class="text-xs text-gray-600">Has Results</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <div class="toggle-switch-small">
                            <input type="checkbox" id="filter-completed" onchange="applyTrialsFilters()" ${trialsFilters.isCompleted ? 'checked' : ''}>
                            <span class="toggle-slider-small purple"></span>
                        </div>
                        <span class="text-xs text-gray-600">Completed Only</span>
                    </label>
                </div>
                
                <!-- Phase filter buttons -->
                <div class="mb-2">
                    <span class="text-xs text-gray-500 mb-2 block">Filter by Phase:</span>
                    <div class="flex flex-wrap gap-2">
                        ${Object.keys(trialsFilters.phaseFilters).map(phase => `
                            <button onclick="togglePhaseFilter('${phase}')" 
                                    id="phase-filter-${phase}" 
                                    class="phase-btn text-xs px-2.5 py-1.5 rounded-lg border transition-all ${trialsFilters.phaseFilters[phase] ? 'active' : ''}"
                                    style="background-color: ${trialsFilters.phaseFilters[phase] ? getPhaseColor(phase) + '20' : '#f9fafb'}; 
                                           border-color: ${trialsFilters.phaseFilters[phase] ? getPhaseColor(phase) : '#e5e7eb'}; 
                                           color: ${trialsFilters.phaseFilters[phase] ? getPhaseColor(phase) : '#6b7280'}">
                               
                                ${formatPhase(phase)}
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div id="trials-filter-status" class="text-xs text-gray-500 mt-2">
                    Showing all ${resultsState.trials.data.length} studies
                </div>
            </div>
        </div>
    `;
    
    resultsContent.insertBefore(filterSection, resultsContent.firstChild);
}
function removeTrialsFilters() {
    const filterSection = document.getElementById('trials-filter-section');
    if (filterSection) {
        filterSection.remove();
    }
}

function togglePhaseFilter(phase) {
    trialsFilters.phaseFilters[phase] = !trialsFilters.phaseFilters[phase];
    
    // Update button visual state
    const btn = document.getElementById(`phase-filter-${phase}`);
    if (btn) {
        const isActive = trialsFilters.phaseFilters[phase];
        btn.classList.toggle('active', isActive);
        btn.style.backgroundColor = isActive ? getPhaseColor(phase) + '20' : '#f9fafb';
        btn.style.borderColor = isActive ? getPhaseColor(phase) : '#e5e7eb';
        btn.style.color = isActive ? getPhaseColor(phase) : '#6b7280';
    }
    
    applyTrialsFilters();
}

function applyTrialsFilters() {
    // Get current filter values from UI
    const hasResultsCheck = document.getElementById('filter-has-results');
    const completedCheck = document.getElementById('filter-completed');
    
    if (hasResultsCheck) trialsFilters.hasResults = hasResultsCheck.checked;
    if (completedCheck) trialsFilters.isCompleted = completedCheck.checked;
    
    // Filter the trials data
    const allTrials = resultsState.trials.data;
    
    const filtered = allTrials.filter(study => {
        const proto = study?.protocolSection;
        const phase = proto?.designModule?.phases?.[0] || 'PRE_PHASE';
        const status = proto?.statusModule?.overallStatus || '';
        const hasResults = study.hasResults;
        
        // Phase filter
        if (!trialsFilters.phaseFilters[phase]) return false;
        
        // Has results filter
        if (trialsFilters.hasResults && !hasResults) return false;
        
        // Completed filter
        if (trialsFilters.isCompleted && status !== 'Completed') return false;
        
        return true;
    });
    
    // Update state and re-render
    resultsState.trials.filteredData = filtered;
    resultsState.trials.page = 1;
    
    // Update status text
    const statusEl = document.getElementById('trials-filter-status');
    if (statusEl) {
        statusEl.textContent = `Showing ${filtered.length} of ${allTrials.length} studies`;
    }
    
    // Update count in tab
    updateTrialsCount(filtered.length);
    
    renderCurrentResultsTab();
    updateResultsPagination();
}

function resetTrialsFilters() {
    // Reset filter state
    trialsFilters.hasResults = false;
    trialsFilters.isCompleted = false;
    Object.keys(trialsFilters.phaseFilters).forEach(phase => {
        trialsFilters.phaseFilters[phase] = true;
    });
    
    // Reset UI elements
    const hasResultsCheck = document.getElementById('filter-has-results');
    const completedCheck = document.getElementById('filter-completed');
    if (hasResultsCheck) hasResultsCheck.checked = false;
    if (completedCheck) completedCheck.checked = false;
    
    // Reset phase buttons
    Object.keys(trialsFilters.phaseFilters).forEach(phase => {
        const btn = document.getElementById(`phase-filter-${phase}`);
        if (btn) {
            btn.classList.add('active');
            btn.style.backgroundColor = getPhaseColor(phase) + '20';
            btn.style.borderColor = getPhaseColor(phase);
            btn.style.color = getPhaseColor(phase);
        }
    });
    
    // Clear filtered data
    resultsState.trials.filteredData = [];
    resultsState.trials.page = 1;
    
    // Update status text
    const statusEl = document.getElementById('trials-filter-status');
    if (statusEl) {
        statusEl.textContent = `Showing all ${resultsState.trials.data.length} studies`;
    }
    
    // Update count in tab
    updateTrialsCount(resultsState.trials.data.length);
    
    renderCurrentResultsTab();
    updateResultsPagination();
}

function updateTrialsCount(count) {
    const countEl = document.getElementById('trialsCount');
    if (countEl) {
        countEl.textContent = count;
    }
}

// Export filter functions
window.togglePhaseFilter = togglePhaseFilter;
window.applyTrialsFilters = applyTrialsFilters;
window.resetTrialsFilters = resetTrialsFilters;

// ============================================
// CARD RENDERERS
// ============================================

function getStatusClass(status) {
    const s = (status || '').toUpperCase();
    if (s.includes('RECRUITING') && !s.includes('NOT')) return 'status-recruiting';
    if (s.includes('COMPLETED')) return 'status-completed';
    if (s.includes('ACTIVE')) return 'status-active';
    if (s.includes('TERMINATED') || s.includes('WITHDRAWN')) return 'status-terminated';
    return 'status-default';
}

// ============================================
// ENHANCED TRIAL HELPERS
// ============================================

function getPhaseColor(phase) {
    const colors = {
        'PRE_PHASE': '#6366f1',      // indigo
        'EARLY_PHASE1': '#22c55e',   // green
        'PHASE1': '#22c55e',         // green
        'PHASE1_PHASE2': '#14b8a6',  // teal
        'PHASE2': '#06b6d4',         // cyan
        'PHASE2_PHASE3': '#8b5cf6',  // purple
        'PHASE3': '#8b5cf6',         // purple
        'PHASE4': '#6366f1',         // indigo
        'NA': '#9ca3af'              // gray
    };
    return colors[phase] || colors['NA'];
}

function formatPhase(phase) {
    const labels = {
        'PRE_PHASE': 'Pre-Clinical',
        'EARLY_PHASE1': 'Early Phase 1',
        'PHASE1': 'Phase 1',
        'PHASE1_PHASE2': 'Phase 1/2',
        'PHASE2': 'Phase 2',
        'PHASE2_PHASE3': 'Phase 2/3',
        'PHASE3': 'Phase 3',
        'PHASE4': 'Phase 4',
        'NA': 'N/A'
    };
    return labels[phase] || phase || 'N/A';
}

function getStatusBadge(status) {
    const statusConfig = {
        'Recruiting': { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-200' },
        'Active, not recruiting': { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-200' },
        'Completed': { bg: 'bg-indigo-100', text: 'text-indigo-800', border: 'border-indigo-200' },
        'Terminated': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-200' },
        'Withdrawn': { bg: 'bg-gray-100', text: 'text-gray-800', border: 'border-gray-200' },
        'Suspended': { bg: 'bg-yellow-100', text: 'text-yellow-800', border: 'border-yellow-200' },
        'Not yet recruiting': { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-200' },
        'Enrolling by invitation': { bg: 'bg-teal-100', text: 'text-teal-800', border: 'border-teal-200' }
    };
    
    const config = statusConfig[status] || { bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-200' };
    return `<span class="text-xs ${config.bg} ${config.text} ${config.border} border px-2 py-0.5 rounded-full">${status || 'Unknown'}</span>`;
}

// ============================================
// ENHANCED TRIAL CARD RENDERER
// ============================================

function renderTrialCard(study) {
    const proto = study?.protocolSection;
    const id = proto?.identificationModule;
    const st = proto?.statusModule;
    const design = proto?.designModule;
    const desc = proto?.descriptionModule;
    const sponsor = proto?.sponsorCollaboratorsModule;
    const conds = proto?.conditionsModule;
    const intv = proto?.armsInterventionsModule;
    
    const nctId = id?.nctId || 'N/A';
    const title = id?.briefTitle || 'Untitled';
    const status = st?.overallStatus || 'Unknown';
    const phase = design?.phases?.[0] || 'NA';
    const sponsorName = sponsor?.leadSponsor?.name || 'N/A';
    const conditions = conds?.conditions?.slice(0, 2) || [];
    const interventions = intv?.interventions?.slice(0, 2).map(i => i.name) || [];
    const summary = (desc?.briefSummary || '').slice(0, 150);
    const hasResults = study.hasResults;
    
    // Check for TRD-specific study
    const briefTitle = (id?.briefTitle || '').toLowerCase();
    const officialTitle = (id?.officialTitle || '').toLowerCase();
    const briefSummary = (desc?.briefSummary || '').toLowerCase();
    
    const trdTerms = ['treatment-resistant depression', 'treatment resistant depression', 'trd', 'refractory depression'];
    const isTRDSpecific = trdTerms.some(term => 
        briefTitle.includes(term) || officialTitle.includes(term) || briefSummary.includes(term)
    );

    return `
        <div class="study-card-enhanced bg-white p-4 rounded-lg border border-gray-200 hover:shadow-md transition duration-200 mb-3">
            <div class="flex flex-col md:flex-row gap-2 md:items-center md:justify-between mb-3">
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                    <span class="text-sm font-medium">${formatPhase(phase)}</span>
                    ${getStatusBadge(status)}
                    ${isTRDSpecific ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full">TRD-Specific</span>' : ''}
                </div>
                <div class="flex items-center gap-2">
                    <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="text-xs text-emerald-600 hover:text-emerald-800 font-mono">${nctId}</a>
                    ${hasResults ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                </div>
            </div>
            <h3 class="text-base font-medium mb-2 text-gray-900 line-clamp-2">${escapeHtml(title)}</h3>
            <p class="text-sm text-gray-600 mb-3">Sponsor: ${escapeHtml(sponsorName)}</p>
            ${conditions.length ? `
                <div class="flex flex-wrap gap-1 mb-2">
                    ${conditions.map(c => `<span class="result-tag condition text-xs">${escapeHtml(c)}</span>`).join('')}
                </div>
            ` : ''}
            ${interventions.length ? `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${interventions.map(i => `<span class="result-tag intervention text-xs">${escapeHtml(i)}</span>`).join('')}
                </div>
            ` : ''}
            ${summary ? `<p class="text-xs text-gray-500 mb-3 line-clamp-2">${escapeHtml(summary)}...</p>` : ''}
            <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-100">
                <button onclick="viewStudyDetails('${nctId}')" class="text-emerald-600 hover:text-emerald-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    View Details
                </button>
                <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" class="text-gray-600 hover:text-gray-800 text-sm font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    ClinicalTrials.gov
                </a>
            </div>
        </div>
    `;
}

// ============================================
// VIEW STUDY DETAILS MODAL
// ============================================

async function viewStudyDetails(nctId) {
    try {
        // Show loading modal
        const loadingModal = document.createElement('div');
        loadingModal.id = 'study-loading-modal';
        loadingModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4';
        loadingModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md shadow-xl">
                <div class="flex items-center justify-center mb-4">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-500"></div>
                </div>
                <p class="text-center text-gray-700">Loading study details...</p>
            </div>
        `;
        document.body.appendChild(loadingModal);
        
        // Fetch study details from ClinicalTrials.gov API
        const response = await fetch(`https://clinicaltrials.gov/api/v2/studies/${nctId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch study details: ${response.status}`);
        }
        
        const studyData = await response.json();
        
        // Remove loading modal
        document.body.removeChild(loadingModal);
        
        // Show detail modal
        showStudyDetailModal(studyData);
        
    } catch (error) {
        console.error('Error loading study details:', error);
        const loadingModal = document.getElementById('study-loading-modal');
        if (loadingModal) document.body.removeChild(loadingModal);
        showNotification('Failed to load study details. Please try again.', 'error');
    }
}

function showStudyDetailModal(studyData) {
    const proto = studyData?.protocolSection;
    const id = proto?.identificationModule;
    const st = proto?.statusModule;
    const design = proto?.designModule;
    const desc = proto?.descriptionModule;
    const sponsor = proto?.sponsorCollaboratorsModule;
    const conds = proto?.conditionsModule;
    const intv = proto?.armsInterventionsModule;
    const eligibility = proto?.eligibilityModule;
    const outcomes = proto?.outcomesModule;
    const contacts = proto?.contactsLocationsModule;
    
    const nctId = id?.nctId || 'N/A';
    const title = id?.briefTitle || 'Untitled';
    const officialTitle = id?.officialTitle || '';
    const status = st?.overallStatus || 'Unknown';
    const phase = design?.phases?.[0] || 'NA';
    const studyType = design?.studyType || 'N/A';
    const enrollment = design?.enrollmentInfo?.count || 'N/A';
    const sponsorName = sponsor?.leadSponsor?.name || 'N/A';
    const conditions = conds?.conditions || [];
    const interventions = intv?.interventions || [];
    const briefSummary = desc?.briefSummary || '';
    const detailedDesc = desc?.detailedDescription || '';
    const primaryOutcomes = outcomes?.primaryOutcomes || [];
    const secondaryOutcomes = outcomes?.secondaryOutcomes || [];
    const eligibilityCriteria = eligibility?.eligibilityCriteria || '';
    const hasResults = studyData.hasResults;
    
    // Start/completion dates
    const startDate = st?.startDateStruct?.date || 'N/A';
    const completionDate = st?.completionDateStruct?.date || 'N/A';
    
    const modal = document.createElement('div');
    modal.id = 'study-detail-modal';
    modal.className = 'study-detail-modal fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4';
    modal.onclick = (e) => { if (e.target === modal) closeStudyDetailModal(); };
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <div class="study-detail-header bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 flex-shrink-0">
                <div class="flex items-start justify-between">
                    <div class="flex-1 pr-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${getPhaseColor(phase)}"></span>
                            <span class="text-sm font-medium text-white/90">${formatPhase(phase)}</span>
                            <span class="text-xs bg-white/20 text-white px-2 py-0.5 rounded-full">${status}</span>
                            ${hasResults ? '<span class="text-xs bg-green-400/30 text-white px-2 py-0.5 rounded-full">Has Results</span>' : ''}
                        </div>
                        <h2 class="text-xl font-medium text-white mb-1">${escapeHtml(title)}</h2>
                        <p class="text-sm text-white/80 font-mono">${nctId}</p>
                    </div>
                    <button onclick="closeStudyDetailModal()" class="text-white/80 hover:text-white transition-colors p-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="study-detail-body flex-1 overflow-y-auto p-6">
                <!-- Quick Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">Study Type</p>
                        <p class="text-sm font-medium text-gray-900">${studyType}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">Enrollment</p>
                        <p class="text-sm font-medium text-gray-900">${enrollment} participants</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">Start Date</p>
                        <p class="text-sm font-medium text-gray-900">${startDate}</p>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <p class="text-xs text-gray-500 mb-1">Est. Completion</p>
                        <p class="text-sm font-medium text-gray-900">${completionDate}</p>
                    </div>
                </div>
                
                <!-- Sponsor -->
                <div class="study-detail-section mb-6">
                    <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        Sponsor
                    </h3>
                    <p class="text-gray-700">${escapeHtml(sponsorName)}</p>
                </div>
                
                <!-- Conditions -->
                ${conditions.length ? `
                    <div class="study-detail-section mb-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Conditions
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${conditions.map(c => `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${escapeHtml(c)}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Interventions -->
                ${interventions.length ? `
                    <div class="study-detail-section mb-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                            </svg>
                            Interventions
                        </h3>
                        <div class="space-y-2">
                            ${interventions.map(i => `
                                <div class="bg-purple-50 rounded-lg p-3">
                                    <p class="text-sm font-medium text-purple-900">${escapeHtml(i.name || 'N/A')}</p>
                                    <p class="text-xs text-purple-700">${escapeHtml(i.type || 'Unknown type')}</p>
                                    ${i.description ? `<p class="text-xs text-gray-600 mt-1">${escapeHtml(i.description.slice(0, 200))}...</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Brief Summary -->
                ${briefSummary ? `
                    <div class="study-detail-section mb-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                            </svg>
                            Brief Summary
                        </h3>
                        <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(briefSummary)}</p>
                    </div>
                ` : ''}
                
                <!-- Primary Outcomes -->
                ${primaryOutcomes.length ? `
                    <div class="study-detail-section mb-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Primary Outcomes
                        </h3>
                        <ul class="space-y-2">
                            ${primaryOutcomes.map(o => `
                                <li class="text-sm text-gray-700 bg-green-50 rounded-lg p-3">
                                    <p class="font-medium text-green-900">${escapeHtml(o.measure || 'N/A')}</p>
                                    ${o.timeFrame ? `<p class="text-xs text-green-700 mt-1">Time Frame: ${escapeHtml(o.timeFrame)}</p>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                ` : ''}
                
                <!-- Eligibility -->
                ${eligibilityCriteria ? `
                    <div class="study-detail-section mb-6">
                        <h3 class="text-sm font-medium text-gray-900 mb-2 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            Eligibility Criteria
                        </h3>
                        <div class="text-sm text-gray-700 bg-orange-50 rounded-lg p-4 max-h-48 overflow-y-auto">
                            <pre class="whitespace-pre-wrap font-sans text-xs">${escapeHtml(eligibilityCriteria)}</pre>
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <!-- Modal Footer -->
            <div class="study-detail-footer bg-gray-50 px-6 py-4 flex justify-between items-center flex-shrink-0 border-t">
                <a href="https://clinicaltrials.gov/study/${nctId}" target="_blank" 
                   class="text-emerald-600 hover:text-emerald-800 text-sm font-medium flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    View on ClinicalTrials.gov
                </a>
                <button onclick="closeStudyDetailModal()" 
                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    Close
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

function closeStudyDetailModal() {
    const modal = document.getElementById('study-detail-modal');
    if (modal) {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
    }
}

// Export modal functions
window.viewStudyDetails = viewStudyDetails;
window.showStudyDetailModal = showStudyDetailModal;
window.closeStudyDetailModal = closeStudyDetailModal;

function renderFDACard(drug) {
    const products = drug.products || [];
    const activeProducts = products.filter(p => 
        p.marketing_status?.toLowerCase().includes('prescription') ||
        p.marketing_status?.toLowerCase().includes('otc')
    );
    
    const brandName = drug.openfda?.brand_name?.[0] || products[0]?.brand_name || 'N/A';
    const genericName = drug.openfda?.generic_name?.[0] || 'N/A';
    const applNo = drug.application_number || 'N/A';
    const sponsorName = drug.sponsor_name || 'N/A';
    const ingredients = [...new Set(products.flatMap(p => 
        (p.active_ingredients || []).map(a => a.name)
    ))].slice(0, 3);
    
    return `
        <div class="result-card">
            <div class="result-card-header">
                <span class="result-card-id fda">${applNo}</span>
                <span class="result-card-status ${activeProducts.length ? 'status-recruiting' : 'status-default'}">
                    ${activeProducts.length ? 'Marketed' : 'Not Marketed'}
                </span>
            </div>
            <h3 class="result-card-title">${escapeHtml(brandName)}</h3>
            <p style="font-size: 0.75rem; color: #6b7280; margin-bottom: 8px;">${escapeHtml(genericName)}</p>
            <div class="result-card-meta">
                <span><strong>Sponsor:</strong> ${escapeHtml(sponsorName)}</span>
                <span><strong>Products:</strong> ${products.length} (${activeProducts.length} active)</span>
            </div>
            ${ingredients.length ? `
                <div class="result-card-tags">
                    ${ingredients.map(i => `<span class="result-tag ingredient">${escapeHtml(i)}</span>`).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

function renderOBCard(group) {
    const patents = group.patents || [];
    const exclusivities = group.exclusivities || [];
    
    return `
        <div class="result-card">
            <h3 class="result-card-title" style="margin-bottom: 4px;">${escapeHtml(group.ingredient)}</h3>
            <div class="result-card-meta" style="margin-bottom: 12px;">
                <span>${escapeHtml(group.dfRoute || '')}</span>
                ${group.strength ? `<span>ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¢ ${escapeHtml(group.strength)}</span>` : ''}
            </div>
            
            <div class="ob-stats">
                <div class="ob-stat branded">
                    <div class="ob-stat-value">${group.brandedCount || 0}</div>
                    <div class="ob-stat-label">Branded</div>
                </div>
                <div class="ob-stat generic">
                    <div class="ob-stat-value">${group.genericCount || 0}</div>
                    <div class="ob-stat-label">Generics</div>
                </div>
                <div class="ob-stat patents">
                    <div class="ob-stat-value">${patents.length}</div>
                    <div class="ob-stat-label">Patents</div>
                </div>
            </div>
            
            ${patents.length ? `
                <div style="margin-bottom: 8px;">
                    <div class="ob-section-title">Patents</div>
                    <div class="ob-patents-list">
                        ${patents.slice(0, 3).map(p => `
                            <div class="ob-patent-item">
                                <span class="ob-patent-no">${p.patentNo || 'N/A'}</span>
                                <span class="ob-patent-exp">Exp: ${p.expireDate || 'N/A'}</span>
                            </div>
                        `).join('')}
                        ${patents.length > 3 ? `<div style="font-size: 0.625rem; color: #9ca3af; text-align: center;">+${patents.length - 3} more</div>` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${exclusivities.length ? `
                <div>
                    <div class="ob-section-title">Exclusivity</div>
                    <div class="ob-exclusivities">
                        ${exclusivities.slice(0, 4).map(e => `
                            <span class="ob-exclusivity-tag">${e.code || 'N/A'} (${e.expireDate || 'N/A'})</span>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${group.brandedProducts?.length ? `
                <div class="ob-trade-names">
                    <strong>Trade names:</strong> ${group.brandedProducts.slice(0, 3).map(p => escapeHtml(p.tradeName)).join(', ')}
                </div>
            ` : ''}
        </div>
    `;
}

// ============================================
// PUBMED HELPER FUNCTIONS
// ============================================

function formatPubmedDate(dateStr) {
    if (!dateStr) return 'Date not available';
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch {
        return dateStr;
    }
}

function extractConditions(article) {
    const conditions = new Set();
    const text = `${article.title || ''} ${article.abstract || ''}`.toLowerCase();
    
    const conditionPatterns = [
        /\b(diabetes|diabetic)\b/gi,
        /\b(hypertension|hypertensive)\b/gi,
        /\b(cancer|carcinoma|tumor|tumour|oncolog|neoplasm)\b/gi,
        /\b(asthma|copd|pulmonary)\b/gi,
        /\b(heart failure|cardiac|cardiovascular)\b/gi,
        /\b(alzheimer|dementia|parkinson)\b/gi,
        /\b(arthritis|rheumatoid|osteoarthritis)\b/gi,
        /\b(depression|anxiety|psychiatric)\b/gi,
        /\b(obesity|obese)\b/gi,
        /\b(stroke|cerebrovascular)\b/gi,
        /\b(hepatitis|liver disease|cirrhosis)\b/gi,
        /\b(kidney disease|renal failure|nephropathy)\b/gi,
        /\b(infection|infectious|sepsis)\b/gi,
        /\b(covid-19|sars-cov-2|coronavirus)\b/gi,
        /\b(hiv|aids)\b/gi,
        /\b(epilepsy|seizure)\b/gi,
        /\b(multiple sclerosis)\b/gi,
        /\b(lupus|autoimmune)\b/gi
    ];
    
    conditionPatterns.forEach(pattern => {
        const matches = text.match(pattern);
        if (matches) {
            matches.forEach(m => conditions.add(m.charAt(0).toUpperCase() + m.slice(1).toLowerCase()));
        }
    });
    
    if (article.meshTerms) {
        article.meshTerms.forEach(term => {
            if (term.toLowerCase().includes('disease') || term.toLowerCase().includes('disorder') || term.toLowerCase().includes('syndrome')) {
                conditions.add(term);
            }
        });
    }
    
    return Array.from(conditions).slice(0, 10);
}

function extractDrugs(article) {
    const drugs = new Set();
    const text = `${article.title || ''} ${article.abstract || ''}`;
    
    const drugPatterns = [
        /\b(metformin|insulin|glipizide|sitagliptin)\b/gi,
        /\b(aspirin|ibuprofen|acetaminophen|naproxen)\b/gi,
        /\b(lisinopril|amlodipine|losartan|metoprolol|atenolol)\b/gi,
        /\b(simvastatin|atorvastatin|rosuvastatin)\b/gi,
        /\b(omeprazole|pantoprazole|lansoprazole)\b/gi,
        /\b(sertraline|fluoxetine|escitalopram|duloxetine)\b/gi,
        /\b(prednisone|dexamethasone|hydrocortisone)\b/gi,
        /\b(warfarin|rivaroxaban|apixaban|heparin)\b/gi,
        /\b(pembrolizumab|nivolumab|ipilimumab)\b/gi,
        /\b(remdesivir|paxlovid|molnupiravir)\b/gi,
        /\b(vaccine|vaccination|immunization)\b/gi,
        /\b(antibiotic|penicillin|amoxicillin|azithromycin|ciprofloxacin)\b/gi,
        /\b(chemotherapy|radiation therapy)\b/gi
    ];
    
    drugPatterns.forEach(pattern => {
        const matches = text.match(pattern);
        if (matches) {
            matches.forEach(m => drugs.add(m.charAt(0).toUpperCase() + m.slice(1).toLowerCase()));
        }
    });
    
    return Array.from(drugs).slice(0, 10);
}

function extractStudyTypes(article) {
    const studyTypes = new Set();
    const text = `${article.title || ''} ${article.abstract || ''}`.toLowerCase();
    const pubTypes = article.pubType || [];
    
    pubTypes.forEach(pt => {
        if (pt.toLowerCase().includes('trial') || pt.toLowerCase().includes('study') || pt.toLowerCase().includes('review') || pt.toLowerCase().includes('meta-analysis')) {
            studyTypes.add(pt);
        }
    });
    
    const patterns = [
        { pattern: /randomized controlled trial|rct/gi, label: 'RCT' },
        { pattern: /meta-analysis|meta analysis/gi, label: 'Meta-Analysis' },
        { pattern: /systematic review/gi, label: 'Systematic Review' },
        { pattern: /cohort study/gi, label: 'Cohort Study' },
        { pattern: /case-control|case control/gi, label: 'Case-Control' },
        { pattern: /cross-sectional/gi, label: 'Cross-Sectional' },
        { pattern: /retrospective/gi, label: 'Retrospective' },
        { pattern: /prospective/gi, label: 'Prospective' },
        { pattern: /double-blind|double blind/gi, label: 'Double-Blind' },
        { pattern: /placebo-controlled|placebo controlled/gi, label: 'Placebo-Controlled' },
        { pattern: /observational/gi, label: 'Observational' },
        { pattern: /clinical trial/gi, label: 'Clinical Trial' }
    ];
    
    patterns.forEach(({ pattern, label }) => {
        if (pattern.test(text)) studyTypes.add(label);
    });
    
    return Array.from(studyTypes).slice(0, 5);
}

function extractOutcomes(article) {
    const outcomes = new Set();
    const text = `${article.title || ''} ${article.abstract || ''}`.toLowerCase();
    
    const outcomePatterns = [
        { pattern: /mortality|survival|death rate/gi, label: 'Mortality' },
        { pattern: /efficacy|effectiveness/gi, label: 'Efficacy' },
        { pattern: /safety|adverse event|side effect/gi, label: 'Safety' },
        { pattern: /quality of life|qol/gi, label: 'Quality of Life' },
        { pattern: /hospitalization/gi, label: 'Hospitalization' },
        { pattern: /response rate/gi, label: 'Response Rate' },
        { pattern: /progression-free|progression free/gi, label: 'PFS' },
        { pattern: /remission/gi, label: 'Remission' },
        { pattern: /biomarker/gi, label: 'Biomarkers' }
    ];
    
    outcomePatterns.forEach(({ pattern, label }) => {
        if (pattern.test(text)) outcomes.add(label);
    });
    
    return Array.from(outcomes).slice(0, 6);
}

function generateAbstractSummary(article) {
    const abstract = article.abstract || '';
    if (!abstract) return '<em class="text-gray-400">No abstract available</em>';
    
    const sentences = abstract.split(/[.!?]+/).filter(s => s.trim().length > 20);
    const keyPhrases = ['conclude', 'result', 'found', 'demonstrate', 'significant', 'effective', 'outcome'];
    let summary = '';
    
    for (const sentence of sentences) {
        if (keyPhrases.some(phrase => sentence.toLowerCase().includes(phrase))) {
            summary = sentence.trim() + '.';
            break;
        }
    }
    
    if (!summary && sentences.length > 0) summary = sentences[0].trim() + '.';
    if (summary.length > 250) summary = summary.substring(0, 247) + '...';
    
    return summary || '<em class="text-gray-400">Summary not available</em>';
}

function annotateText(text) {
    if (!text || !pubmedState.annotationsEnabled) return text || '';
    
    const annotations = [
        { pattern: /\b(p\s*[<>=]\s*0\.\d+)\b/gi, cls: 'bg-yellow-100 text-yellow-800 px-1 rounded' },
        { pattern: /\b(95%\s*CI|confidence interval)\b/gi, cls: 'bg-blue-100 text-blue-800 px-1 rounded' },
        { pattern: /\b(odds ratio|OR|hazard ratio|HR|relative risk|RR)\b/gi, cls: 'bg-purple-100 text-purple-800 px-1 rounded' },
        { pattern: /\b(n\s*=\s*\d+)\b/gi, cls: 'bg-green-100 text-green-800 px-1 rounded' },
        { pattern: /\b(randomized|placebo|double-blind|controlled)\b/gi, cls: 'bg-indigo-100 text-indigo-800 px-1 rounded' }
    ];
    
    let annotatedText = text;
    annotations.forEach(({ pattern, cls }) => {
        annotatedText = annotatedText.replace(pattern, match => `<span class="${cls}">${match}</span>`);
    });
    
    return annotatedText;
}

function togglePubmedAbstract(pmid) {
    const container = document.querySelector(`[data-pmid="${pmid}"] .abstract-container`);
    const btn = document.querySelector(`[data-pmid="${pmid}"] .toggle-abstract-btn`);
    
    if (container && btn) {
        const isHidden = container.classList.contains('hidden');
        container.classList.toggle('hidden');
        
        if (isHidden) {
            pubmedState.abstractViews.add(pmid);
            btn.innerHTML = `<svg class="h-4 w-4 mr-1 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>Hide Abstract`;
        } else {
            pubmedState.abstractViews.delete(pmid);
            btn.innerHTML = `<svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>Show Abstract`;
        }
    }
}

function togglePubmedSelect(pmid) {
    if (pubmedState.selectedArticles.has(pmid)) {
        pubmedState.selectedArticles.delete(pmid);
    } else {
        pubmedState.selectedArticles.add(pmid);
    }
}

// ============================================
// PUBMED CARD RENDERER - ENHANCED
// ============================================

function renderPubMedCard(article) {
    const isSelected = pubmedState.selectedArticles.has(article.pmid);
    const isAbstractVisible = pubmedState.abstractViews.has(article.pmid);
    
    const authors = article.authors || [];
    const authorStr = authors.slice(0, 3).join(', ') + (authors.length > 3 ? ', et al.' : '');
    const pubTypes = article.pubType || [];
    
    const hasDOI = article.doi && article.doi.trim() !== '';
    const hasFullText = article.pmc || (article.fullTextUrl && article.fullTextUrl.trim() !== '');
    
    const conditions = extractConditions(article);
    const drugs = extractDrugs(article);
    const studyTypes = extractStudyTypes(article);
    const outcomes = extractOutcomes(article);
    
    const abstractSummary = generateAbstractSummary(article);
    const annotatedAbstract = pubmedState.annotationsEnabled ? annotateText(article.abstract || '') : (article.abstract || 'No abstract available');
    
    // Medical findings section
    let medicalFindings = '';
    if (conditions.length > 0 || drugs.length > 0 || outcomes.length > 0 || studyTypes.length > 0) {
        medicalFindings = `
            <div class="border-t border-gray-100 mt-3 pt-3">
                ${conditions.length > 0 ? `
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Conditions:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${conditions.slice(0, 4).map(c => `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-0.5 rounded-full">${escapeHtml(c)}</span>`).join('')}
                            ${conditions.length > 4 ? `<span class="text-xs text-gray-400">+${conditions.length - 4}</span>` : ''}
                        </div>
                    </div>` : ''}
                ${drugs.length > 0 ? `
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Treatments:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${drugs.slice(0, 4).map(d => `<span class="bg-green-50 text-green-700 text-xs px-2 py-0.5 rounded-full">${escapeHtml(d)}</span>`).join('')}
                            ${drugs.length > 4 ? `<span class="text-xs text-gray-400">+${drugs.length - 4}</span>` : ''}
                        </div>
                    </div>` : ''}
                ${outcomes.length > 0 ? `
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Outcomes:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${outcomes.slice(0, 4).map(o => `<span class="bg-purple-50 text-purple-800 text-xs px-2 py-0.5 rounded-full">${escapeHtml(o)}</span>`).join('')}
                        </div>
                    </div>` : ''}
                ${studyTypes.length > 0 ? `
                    <div class="mb-2">
                        <span class="text-xs font-medium text-gray-600">Study Type:</span>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${studyTypes.slice(0, 3).map(s => `<span class="bg-amber-50 text-amber-800 text-xs px-2 py-0.5 rounded-full">${escapeHtml(s)}</span>`).join('')}
                        </div>
                    </div>` : ''}
            </div>
        `;
    }

    return `
        <div class="result-card bg-white rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200 mb-3 border border-gray-100" data-pmid="${article.pmid}">
            <div class="flex items-start gap-3">
                <label class="flex items-center mt-1">
                    <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="togglePubmedSelect('${article.pmid}')">
                </label>
                <div class="flex-grow min-w-0">
                    <!-- Header -->
                    <div class="flex justify-between items-start gap-2 mb-2">
                        <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}/" target="_blank" 
                           class="text-xs font-mono text-blue-600 hover:underline">PMID: ${article.pmid}</a>
                        ${hasFullText ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded-full">Full Text</span>' : ''}
                    </div>
                    
                    <!-- Title -->
                    <h3 class="text-sm font-medium text-gray-800 mb-2 leading-snug">${escapeHtml(article.title)}</h3>
                    
                    <!-- Authors -->
                    <div class="text-xs text-gray-600 mb-2">${escapeHtml(authorStr)}</div>
                    
                    <!-- Journal & Date -->
                    <div class="text-xs text-gray-500 mb-3 flex flex-wrap items-center gap-1">
                        <span class="font-medium text-blue-600">${escapeHtml(article.journal || 'Journal not specified')}</span>
                        <span class="text-gray-300">ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¢</span>
                        <span>${formatPubmedDate(article.pubDate)}</span>
                        ${article.volume ? `<span class="text-gray-300">ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¢</span><span>Vol. ${article.volume}${article.issue ? `(${article.issue})` : ''}</span>` : ''}
                    </div>
                    
                    <!-- Abstract Summary -->
                    <div class="bg-gray-50 p-3 rounded-lg text-xs text-gray-700 mb-3 leading-relaxed">
                        ${abstractSummary}
                    </div>
                    
                    <!-- Abstract Toggle -->
                    <div class="flex justify-between items-center mb-2">
                        <button class="toggle-abstract-btn text-blue-600 hover:text-blue-800 text-xs flex items-center" 
                                onclick="togglePubmedAbstract('${article.pmid}')">
                            <svg class="h-4 w-4 mr-1 ${isAbstractVisible ? 'rotate-180' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                            ${isAbstractVisible ? 'Hide Abstract' : 'Show Abstract'}
                        </button>
                    </div>
                    
                    <!-- Full Abstract (hidden by default) -->
                    <div class="abstract-container ${isAbstractVisible ? '' : 'hidden'}">
                        <div class="bg-gray-50 p-3 rounded-lg text-xs text-gray-700 mb-3 leading-relaxed max-h-48 overflow-y-auto">
                            ${annotatedAbstract}
                        </div>
                    </div>
                    
                    <!-- Keywords -->
                    ${article.keywords && article.keywords.length > 0 ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${article.keywords.slice(0, 5).map(kw => `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded-full">${escapeHtml(kw)}</span>`).join('')}
                            ${article.keywords.length > 5 ? `<span class="text-xs text-gray-400">+${article.keywords.length - 5}</span>` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Publication Types -->
                    ${pubTypes.length ? `
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${pubTypes.slice(0, 3).map(t => `<span class="result-tag pubtype bg-blue-50 text-blue-700 text-xs px-2 py-0.5 rounded-full">${escapeHtml(t)}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Medical Findings -->
                    ${medicalFindings}
                    
                    <!-- Action Links -->
                    <div class="flex flex-wrap gap-3 mt-3 pt-3 border-t border-gray-100">
                        <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" 
                           class="text-blue-600 hover:text-blue-800 text-xs flex items-center">
                            <svg class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                            PubMed
                        </a>
                        ${hasDOI ? `
                            <a href="https://doi.org/${article.doi}" target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-xs flex items-center">
                                <svg class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101" />
                                </svg>
                                DOI
                            </a>
                        ` : ''}
                        ${article.pmc ? `
                            <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/${article.pmc}/" target="_blank" 
                               class="text-green-600 hover:text-green-800 text-xs flex items-center">
                                <svg class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Full Text
                            </a>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ============================================
// PAGINATION
// ============================================

function updateResultsPagination() {
    if (!resultsState.activeTab) return;
    
    const tabState = resultsState[resultsState.activeTab];
    const { page, perPage } = tabState;
    
    // Use filtered data for trials, regular data for others
    let displayData;
    if (resultsState.activeTab === 'trials') {
        displayData = tabState.filteredData && tabState.filteredData.length > 0 
            ? tabState.filteredData 
            : tabState.data;
    } else {
        displayData = tabState.data;
    }
    
    const totalPages = Math.ceil(displayData.length / perPage);
    
    const pagination = document.getElementById('resultsPagination');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    
    if (totalPages <= 1) {
        pagination?.classList.add('hidden');
        return;
    }
    
    pagination?.classList.remove('hidden');
    if (pageInfo) pageInfo.textContent = `Page ${page} of ${totalPages}`;
    if (prevBtn) prevBtn.disabled = page === 1;
    if (nextBtn) nextBtn.disabled = page === totalPages;
}

function prevResultsPage() {
    if (!resultsState.activeTab) return;
    
    if (resultsState[resultsState.activeTab].page > 1) {
        resultsState[resultsState.activeTab].page--;
        renderCurrentResultsTab();
        updateResultsPagination();
    }
}

function nextResultsPage() {
    if (!resultsState.activeTab) return;
    
    const tabState = resultsState[resultsState.activeTab];
    const { page, perPage } = tabState;
    
    // Use filtered data for trials
    let displayData;
    if (resultsState.activeTab === 'trials') {
        displayData = tabState.filteredData && tabState.filteredData.length > 0 
            ? tabState.filteredData 
            : tabState.data;
    } else {
        displayData = tabState.data;
    }
    
    const totalPages = Math.ceil(displayData.length / perPage);
    
    if (page < totalPages) {
        resultsState[resultsState.activeTab].page++;
        renderCurrentResultsTab();
        updateResultsPagination();
    }
}

// Add data view buttons instead of follow-up questions
// Add data view cards inline (styled like download cards)
// function addDataViewButtons(streamId, sources) {
//     const followupList = document.getElementById(`followupList-${streamId}`);
//     if (!followupList) return;
    
//     const cards = [];
    
//     // Add card for each available data type
//     if (sources.stats) {
//         cards.push({
//             title: 'View Statistical Analysis',
//             subtitle: 'View charts and insights',
//             icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
//             color: 'linear-gradient(135deg, #14807a, #247a64)',
//             tab: 'stats'
//         });
//     }
    
//     if (sources.trials) {
//         cards.push({
//             title: 'View all Referenced Clinical Trials',
//             subtitle: `${sources.trialsCount} trials found`,
//             icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01',
//             color: '#059669',
//             tab: 'trials'
//         });
//     }
    
//     if (sources.fda) {
//         cards.push({
//             title: 'View all Referenced FDA Approved Drugs',
//             subtitle: `${sources.fdaCount} entries found`,
//             icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
//             color: '#dc2626',
//             tab: 'fda'
//         });
//     }
    
//     if (sources.ob) {
//         cards.push({
//             title: 'View all Referenced  Orange Book Patents',
//             subtitle: `${sources.obCount} patents found`,
//             icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
//             color: '#ea580c',
//             tab: 'ob'
//         });
//     }
    
//     if (sources.pubmed) {
//         cards.push({
//             title: 'View all Referenced PubMed Literature',
//             subtitle: `${sources.pubmedCount} articles found`,
//             icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
//             color: '#2563eb',
//             tab: 'pubmed'
//         });
//     }
    
//     if (cards.length === 0) {
//         followupList.innerHTML = '<p style="text-align: center; color: #6b7280; font-size: 0.875rem; padding: 20px;">No data available</p>';
//         return;
//     }
    
//     // Render cards (like download cards)
//     followupList.innerHTML = cards.map(card => `
//         <div class="data-view-card" onclick="openDataTab('${card.tab}')">
//             <div class="data-view-card-icon" style="background: ${card.color};">
//                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
//                     <path stroke-linecap="round" stroke-linejoin="round" d="${card.icon}"/>
//                 </svg>
//             </div>
//             <div class="data-view-card-content">
//                 <div class="data-view-card-title">${card.title}</div>
//                 <div class="data-view-card-subtitle">${card.subtitle}</div>
//             </div>
//             <div class="data-view-card-action">
//                 View
//                 <svg class="data-view-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
//                     <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
//                 </svg>
//             </div>
//         </div>
//     `).join('');
// }
// Add data view cards inline (styled like download cards)
function addDataViewButtons(streamId, sources) {
    const followupList = document.getElementById(`followupList-${streamId}`);
    if (!followupList) return;
    
    const cards = [];
    
    // Add card for each available data type
    if (sources.stats) {
        cards.push({
            title: 'Statistical Analysis',
            subtitle: 'View charts and insights',
            icon: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z',
            color: 'linear-gradient(135deg, #14807a, #247a64)',
            tab: 'stats'
        });
    }
    
    if (sources.trials) {
        cards.push({
            title: 'Clinical Trials',
            subtitle: `${sources.trialsCount} trials found`,
            icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01',
            color: '#059669',
            tab: 'trials'
        });
    }
    
    if (sources.fda) {
        cards.push({
            title: 'FDA Data',
            subtitle: `${sources.fdaCount} entries found`,
            icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
            color: '#dc2626',
            tab: 'fda'
        });
    }
    
    if (sources.ob) {
        cards.push({
            title: 'Orange Book Patents',
            subtitle: `${sources.obCount} patents found`,
            icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
            color: '#ea580c',
            tab: 'ob'
        });
    }
    
    if (sources.pubmed) {
        cards.push({
            title: 'PubMed Literature',
            subtitle: `${sources.pubmedCount} articles found`,
            icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
            color: '#2563eb',
            tab: 'pubmed'
        });
    }
    
    if (cards.length === 0) {
        followupList.innerHTML = '';
        return;
    }
    
    // Render cards (like download cards)
    followupList.innerHTML = cards.map(card => `
        <div class="data-view-card" onclick="openDataTab('${card.tab}')">
            <div class="data-view-card-icon" style="background: ${card.color};">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="${card.icon}"/>
                </svg>
            </div>
            <div class="data-view-card-content">
                <div class="data-view-card-title">${card.title}</div>
                <div class="data-view-card-subtitle">${card.subtitle}</div>
            </div>
            <div class="data-view-card-action">
                View
                <svg class="data-view-card-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `).join('');
}


// Open data panel to specific tab
function openDataTab(tab) {
    openResultsPanel();
    switchResultsTab(tab);
}
        // Add follow-up questions dynamically
        function addFollowUpQuestions(streamId, originalQuestion) {
            const followupList = document.getElementById(`followupList-${streamId}`);
            if (!followupList) return;
            
            // Generate contextual follow-up suggestions
            const suggestions = [
                'What are the key regulatory requirements?',
                'How does this compare to EU regulations?',
                'What are the recent updates in this area?'
            ];
            
            followupList.innerHTML = suggestions.map((q, i) => `
                <div class="followup-card" onclick="submitFollowUp('${escapeHtml(q)}')">
                    <div class="followup-node"></div>
                    <span class="followup-text">${q}</span>
                    <svg class="followup-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </div>
            `).join('');
        }

        // Submit a follow-up question
        function submitFollowUp(question) {
            const input = document.getElementById('aiInputContinuous');
            if (input) {
                input.value = question;
                submitContinuousQuery();
            }
        }

        // ============================================
        // STREAM INTO ARTIFACT
        // ============================================
        async function streamIntoArtifact(streamId, initialText = '', files = [], reasoningLevel = 'quick') {
            const contentDiv = document.getElementById(`content-${streamId}`);
            let displayedText = initialText;
            
            if (initialText) {
                contentDiv.innerHTML = renderMarkdownToHTML(displayedText);
                return;
            }
            
            // Stream from API in real-time
            await streamAIResponseFromAPI(currentQuestion || question, files, {
                onTextDelta: (delta) => {
                    displayedText += delta;
                    
                    // Update content with typing loader
                    const existingLoader = document.getElementById(`typing-loader-${streamId}`);
                    contentDiv.innerHTML = renderMarkdownToHTML(displayedText);

                    if (!existingLoader) {
                        const loader = createTypingLoader(streamId);
                        contentDiv.appendChild(loader);
                    } else {
                        contentDiv.appendChild(existingLoader);
                    }
                },
                onComplete: () => {
                    // Remove typing loader
                    const loader = document.getElementById(`typing-loader-${streamId}`);
                    if (loader) loader.remove();
                    
                    // Final render without cursor
                    contentDiv.innerHTML = renderMarkdownToHTML(displayedText);
                      
                    // Store response
                    if (!window.userPrompts) window.userPrompts = new Map();
                    window.userPrompts.set(streamId, currentQuestion || question);
                    responseMarkdown.set(streamId, displayedText);
                },
                
                onError: (error) => {
                    contentDiv.innerHTML = `<div class="text-red-600">Error: ${error.message}</div>`;
                }
            }, reasoningLevel);
        }

        // // ============================================
        // // STREAM AI RESPONSE FROM API
        // // ============================================
        // async function streamAIResponseFromAPI(question, files = [], callbacks, reasoningLevel = 'quick') {
        //     try {
        //         const formData = new FormData();
                
        //         // Build conversation context from history
        //         let contextualQuestion = question;
                
        //         if (conversationHistory.length > 0) {
        //             const recentHistory = conversationHistory.slice(-10);
                    
        //             let contextPrompt = 'Previous conversation:\n\n';
                    
        //             recentHistory.forEach(msg => {
        //                 if (msg.role === 'user') {
        //                     contextPrompt += `User: ${msg.content}\n\n`;
        //                 } else if (msg.role === 'assistant') {
        //                     const truncated = msg.content.length > 800 
        //                         ? msg.content.substring(0, 800) + '...[truncated]' 
        //                         : msg.content;
        //                     contextPrompt += `Assistant: ${truncated}\n\n`;
        //                 }
        //             });
                    
        //             contextPrompt += `---\n\nCurrent question: ${question}`;
        //             contextualQuestion = contextPrompt;
        //         }
                
        //         formData.append('question', contextualQuestion);
        //         files.forEach(file => formData.append('files', file));
        //         formData.append('reasoningLevel', reasoningLevel);

        //         // START JOB
        //         const startResponse = await fetch('/api/chat/stream/start', {
        //             method: 'POST',
        //             body: formData
        //         });

        //         if (!startResponse.ok) {
        //             throw new Error(`HTTP error! status: ${startResponse.status}`);
        //         }

        //         const { jobId, sessionId } = await startResponse.json();
        //         console.log(`ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â°ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¡ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã‚Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¬ Job started: ${jobId}`);

        //         // Store session ID for future requests
        //         if (window.currentSessionId !== sessionId) {
        //             window.currentSessionId = sessionId;
        //         }

        //         // ADAPTIVE POLLING CONFIGURATION
        //         let lastProgressIndex = 0;
        //         let fullResponse = '';
        //         let pollAttempts = 0;
        //         let isStreaming = false;
        //         let lastTextTime = Date.now();
                
        //         const maxPollAttempts = 1200; // 20 minutes
                
        //         const SLOW_INTERVAL = 3000;
        //         const FAST_INTERVAL = 1000;
        //         const IDLE_INTERVAL = 2000;

        //         const getNextPollInterval = () => {
        //             if (!isStreaming) return SLOW_INTERVAL;
                    
        //             const timeSinceLastText = Date.now() - lastTextTime;
                    
        //             if (timeSinceLastText < 5000) {
        //                 return FAST_INTERVAL;
        //             } else {
        //                 return IDLE_INTERVAL;
        //             }
        //         };

        //         const poll = async () => {
        //             try {
        //                 const statusResponse = await fetch(`/api/chat/stream/status/${jobId}`);
                        
        //                 if (!statusResponse.ok) {
        //                     throw new Error(`Poll failed: ${statusResponse.status}`);
        //                 }

        //                 const job = await statusResponse.json();

        //                 // Process new progress items
        //                 const newProgress = job.progress.slice(lastProgressIndex);
                        
        //                 newProgress.forEach(event => {
        //                     if (event.type === 'text_delta') {
        //                         fullResponse += event.delta;
                                
        //                         if (!isStreaming) {
        //                             isStreaming = true;
        //                         }
                                
        //                         lastTextTime = Date.now();
        //                     }
                            
        //                     handleAPIStreamEvent(event, callbacks);
        //                 });
                        
        //                 lastProgressIndex = job.progress.length;

        //                 // Check if job is complete
        //                 if (job.status === 'complete') {
        //                     console.log(`ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œ Job ${jobId} completed`);
                            
        //                     // Store AI response in history
        //                     if (fullResponse) {
        //                         conversationHistory.push({
        //                             role: 'assistant',
        //                             content: fullResponse,
        //                             timestamp: new Date().toISOString()
        //                         });
        //                     }
                            
        //                     if (callbacks.onComplete) callbacks.onComplete();
        //                     return;
        //                 }
                        
        //                 if (job.status === 'error') {
        //                     console.error(`ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã†â€™ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â Job ${jobId} failed:`, job.error);
        //                     if (callbacks.onError) callbacks.onError(new Error(job.error));
        //                     return;
        //                 }

        //                 // Continue polling if still processing
        //                 pollAttempts++;
                        
        //                 if (pollAttempts >= maxPollAttempts) {
        //                     throw new Error('Job timeout - exceeded maximum wait time');
        //                 }

        //                 const nextInterval = getNextPollInterval();
        //                 setTimeout(poll, nextInterval);

        //             } catch (error) {
        //                 console.error('Poll error:', error);
        //                 if (callbacks.onError) callbacks.onError(error);
        //             }
        //         };

        //         // Start polling
        //         poll();

        //     } catch (error) {
        //         console.error('API Error:', error);
        //         if (callbacks.onError) callbacks.onError(error);
        //     }
        // }
// ============================================
// QUERY API - CALLS /query ENDPOINT
// ============================================
// async function queryRegulatoryAPI(question, files = [], reasoningLevel = 'quick') {
//     try {
//         // Build request body with conversationId for followup detection
//         const requestBody = {
//             query: question,
//               reasoningLevel: reasoningLevel || 'quick',
//         };
        
//         // Include conversationId if we have one (for followup detection)
//         if (currentConversationId) {
//             requestBody.conversationId = currentConversationId;
//             console.log(`[Frontend] Sending with existing conversationId: ${currentConversationId}`);
//         } else {
//             console.log(`[Frontend] No conversationId - this will create a new conversation`);
//         }

//         console.log(`[Frontend] Request body:`, JSON.stringify(requestBody).slice(0, 200));

//         const response = await fetch('/query', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify(requestBody)
//         });

//         if (!response.ok) {
//             const errorData = await response.json();
//             throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
//         }

//         const data = await response.json();
//         lastQueryResponse = data;
        
//         // Store the conversationId for future followups
//         if (data.conversationId) {
//             const wasNew = !currentConversationId;
//             currentConversationId = data.conversationId;
//             console.log(`[Frontend] ${wasNew ? 'NEW' : 'EXISTING'} conversationId: ${currentConversationId}`);
//         }
        
//         // Log followup detection results
//         console.log(`[API Response]`, {
//             conversationId: data.conversationId,
//             isFollowup: data.isFollowup,
//             queryType: data.queryType,
//             followupConfidence: data.followupConfidence,
//             hasChartData: !!data.response?.chartData,
//             hasStatsResults: !!data.response?.statsResults,
//             rawTrialsCount: data.raw?.clinicalTrials?.length || 0
//         });
        
//         return data;
        
//     } catch (error) {
//         console.error('Query API Error:', error);
//         throw error;
//     }
// }
       

async function queryRegulatoryAPI(question, files = [], reasoningLevel = 'quick') {
    try {
        // Use FormData to send files
        const formData = new FormData();
        formData.append('query', question);
        formData.append('reasoningLevel', reasoningLevel || 'quick');
        
        // Include conversationId if we have one (for followup detection)
        if (currentConversationId) {
            formData.append('conversationId', currentConversationId);
            console.log(`[Frontend] Sending with existing conversationId: ${currentConversationId}`);
        } else {
            console.log(`[Frontend] No conversationId - this will create a new conversation`);
        }
        
        // Append files to FormData
        if (files && files.length > 0) {
            files.forEach((file, index) => {
                formData.append('files', file);
            });
            console.log(`[Frontend] Sending ${files.length} file(s) to backend`);
        }

        const response = await fetch('/query', {
            method: 'POST',
            body: formData
            // Don't set Content-Type header - browser will set it with boundary for multipart/form-data
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        lastQueryResponse = data;
        
        // Store the conversationId for future followups
        if (data.conversationId) {
            const wasNew = !currentConversationId;
            currentConversationId = data.conversationId;
            console.log(`[Frontend] ${wasNew ? 'NEW' : 'EXISTING'} conversationId: ${currentConversationId}`);
        }
        
        // Log followup detection results
        console.log(`[API Response]`, {
            conversationId: data.conversationId,
            isFollowup: data.isFollowup,
            queryType: data.queryType,
            followupConfidence: data.followupConfidence,
            hasChartData: !!data.response?.chartData,
            hasStatsResults: !!data.response?.statsResults,
            rawTrialsCount: data.raw?.clinicalTrials?.length || 0
        });
        
        return data;
        
    } catch (error) {
        console.error('Query API Error:', error);
        throw error;
    }
}

// ============================================
        // HANDLE API STREAM EVENT
        // ============================================
        function handleAPIStreamEvent(event, callbacks) {
            switch (event.type) {
                case 'text_delta':
                    if (callbacks.onTextDelta) {
                        callbacks.onTextDelta(event.delta);
                    }
                    break;
                    
                case 'error':
                    if (callbacks.onError) {
                        callbacks.onError(new Error(event.message));
                    }
                    break;
            }
        }

        // ============================================
        // MARKDOWN RENDERING
        // ============================================
function renderMarkdownToHTML(markdown) {
            // Configure marked for GFM
            marked.setOptions({
                gfm: true,
                breaks: true,
                smartLists: true,
                headerIds: false,
                mangle: false
            });

            // Convert Markdown to raw HTML
            let rawHTML = marked.parse(markdown);

            // Sanitize to protect from XSS
            const cleanHTML = DOMPurify.sanitize(rawHTML, {
                ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'b', 'i', 'u', 'a', 'ul', 'ol', 'li', 
                               'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'code', 'pre',
                               'table', 'thead', 'tbody', 'tr', 'th', 'td', 'hr', 'sup', 'sub', 'span', 'div'],
                ALLOWED_ATTR: ['href', 'class', 'id', 'target', 'rel']
            });

            // Return the clean HTML directly (no wrapping div)
            return cleanHTML;
        }
        // ============================================
        // TYPING LOADER
        // ============================================
        function createTypingLoader(streamId) {
            const loader = document.createElement('span');
            loader.id = `typing-loader-${streamId}`;
            loader.className = 'stream-cursor';
            return loader;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function updateEmptyState() {
            const emptyState = document.getElementById('emptyChatState');
            const chatContainer = document.getElementById('chatContainer');
            
            if (emptyState && chatContainer) {
                if (chatContainer.children.length > 0) {
                    emptyState.classList.add('hidden');
                } else {
                    emptyState.classList.remove('hidden');
                }
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-300' : 
                type === 'error' ? 'bg-red-100 text-red-800 border border-red-300' :
                'bg-blue-100 text-blue-800 border border-blue-300'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-20px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============================================
        // ACTION BUTTONS
        // ============================================
        function copyArtifact(streamId) {
            const content = responseMarkdown.get(streamId);
            if (!content) {
                showNotification('No content to copy', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Copied to clipboard!', 'info');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        // Toggle thinking state section
        function toggleThinking(streamId) {
            const header = document.querySelector(`#thinking-${streamId} .thinking-header`);
            const body = document.getElementById(`thinkingBody-${streamId}`);
            
            if (header && body) {
                header.classList.toggle('expanded');
                body.classList.toggle('expanded');
            }
        }

        // Toggle references section
        function toggleReferences(streamId) {
            const header = document.querySelector(`#references-${streamId} .references-header`);
            const body = document.getElementById(`referencesBody-${streamId}`);
            
            if (header && body) {
                header.classList.toggle('expanded');
                body.classList.toggle('expanded');
            }
        }

        // Vote on response (thumbs up/down)
        function voteResponse(streamId, vote) {
            const upBtn = document.querySelector(`#${streamId} .action-btn[onclick*="'up'"]`);
            const downBtn = document.querySelector(`#${streamId} .action-btn[onclick*="'down'"]`);
            
            if (vote === 'up') {
                upBtn.classList.toggle('voted');
                upBtn.style.background = upBtn.classList.contains('voted') ? 'var(--forest-50)' : '';
                downBtn.classList.remove('voted');
                downBtn.style.background = '';
            } else {
                downBtn.classList.toggle('voted');
                downBtn.style.background = downBtn.classList.contains('voted') ? 'var(--red-100)' : '';
                upBtn.classList.remove('voted');
                upBtn.style.background = '';
            }
            
            showNotification(vote === 'up' ? 'Thanks for your feedback!' : 'We\'ll work to improve', 'info');
        }

        // Update thinking step status
        function updateThinkingStep(streamId, stepId, status) {
            const step = document.getElementById(`step-${stepId}-${streamId}`);
            if (step) {
                step.classList.remove('active', 'completed');
                step.classList.add(status);
            }
        }

        // Complete all thinking steps
        function completeThinkingSteps(streamId) {
            const steps = ['understand', 'search', 'synthesize'];
            steps.forEach(step => {
                updateThinkingStep(streamId, step, 'completed');
            });
            
            const header = document.querySelector(`#thinking-${streamId} .thinking-header`);
            const label = header?.querySelector('.thinking-label');
            if (header && label) {
                header.classList.add('completed');
            }
            
            // Collapse thinking section after completion
            setTimeout(() => {
                const body = document.getElementById(`thinkingBody-${streamId}`);
                const headerEl = document.querySelector(`#thinking-${streamId} .thinking-header`);
                if (body && headerEl) {
                    body.classList.remove('expanded');
                    headerEl.classList.remove('expanded');
                }
            }, 2000);
        }

        // Update response status
        function updateResponseStatus(streamId, status, text) {
            const statusEl = document.getElementById(`status-${streamId}`);
            if (statusEl) {
                statusEl.className = `response-status ${status}`;
                statusEl.innerHTML = `<span class="status-dot ${status === 'processing' ? 'pulsing' : ''}"></span>${text}`;
            }
        }

        function clearChatHistory() {
            const container = document.getElementById('chatContainer');
            if (container) {
                container.innerHTML = '';
            }
            
            conversationHistory = [];
            conversationStarted = false;
            
            // Reset conversation tracking for followup detection
            // FIXED: Clear BOTH conversation ID variables
            currentConversationId = null;
            if (typeof LeafAuth !== 'undefined') {
                LeafAuth.currentConversationId = null;
            }
            window.currentConversationData = null;
            
            // Reset breadcrumb
            const breadcrumbCurrent = document.getElementById('currentChatName');
            if (breadcrumbCurrent) {
                breadcrumbCurrent.textContent = 'New conversation';
            }
            
            // Cleanup any chart instances
            chartInstances.forEach(chart => chart.destroy());
            chartInstances.clear();
            
            // Reset reasoning level selection
            selectedReasoningLevel.initial = null;
            const initialButton = document.getElementById('reasoningDropdownInitial');
            if (initialButton) {
                initialButton.classList.add('animate-pulse', 'border-orange-300', 'bg-orange-50');
                initialButton.classList.remove('border-gray-200', 'bg-white');
            }
            const initialLabel = document.getElementById('reasoningLabelInitial');
            if (initialLabel) initialLabel.textContent = 'Level of Detail';
            const initialSubtext = document.getElementById('reasoningSubtextInitial');
            if (initialSubtext) initialSubtext.classList.add('hidden');
            
            document.getElementById('initialInputBar').classList.remove('hidden');
            document.getElementById('examplepils').classList.remove('hidden');
            document.getElementById('continuousChatInput').style.display = 'none';
            
            updateEmptyState();
               // Close results panel
    closeResultsPanel();
    
    // Reset results state
    resultsState.stats = { chartData: null, statsResults: null, hasData: false };
    resultsState.trials.data = [];
    resultsState.fda.data = [];
    resultsState.ob.data = [];
    resultsState.pubmed.data = [];
    resultsState.activeTab = null;
    
    // Hide all tabs including stats
    ['tabStats', 'tabTrials', 'tabFda', 'tabOb', 'tabPubmed'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
    });
    
    showNotification('Chat cleared', 'info');

        }

        function toggleChatMinimize() {
            const chatContent = document.getElementById('chatContent');
            const chevron = document.getElementById('chevronIcon');
            
            if (chatContent && chevron) {
                const isMinimized = chatContent.style.display === 'none';
                
                if (isMinimized) {
                    chatContent.style.display = 'block';
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    chatContent.style.display = 'none';
                    chevron.style.transform = 'rotate(180deg)';
                }
            }
        }

        // Export functions to window for onclick handlers
        window.submitInitialQuery = submitInitialQuery;
        window.submitContinuousQuery = submitContinuousQuery;
        window.toggleReasoningDropdown = toggleReasoningDropdown;
        window.selectReasoningLevel = selectReasoningLevel;
        window.clearChatHistory = clearChatHistory;
        window.toggleChatMinimize = toggleChatMinimize;
        window.copyArtifact = copyArtifact;
        window.autoResize = autoResize;
        window.toggleSidebar = toggleSidebar;
        window.toggleSection = toggleSection;
        window.toggleNavMenu = toggleNavMenu;
        window.toggleUserMenu = toggleUserMenu;
        window.toggleThinking = toggleThinking;
        window.toggleReferences = toggleReferences;
        window.voteResponse = voteResponse;
        window.submitFollowUp = submitFollowUp;

        // ============================================
        // PROMPT GUIDE HANDBOOK FUNCTIONS
        // ============================================
        let currentHandbookPage = 0;
        const totalHandbookPages = 8; // Cover + 7 pages

        function showPromptGuide() {
            const overlay = document.getElementById('promptGuideOverlay');
            console.log("running")
            if (overlay) {
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                initHandbookDots();
                goToHandbookPage(0);
            }
        }

        function closePromptGuide() {
            const overlay = document.getElementById('promptGuideOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function closePromptGuideOnOverlay(event) {
            if (event.target.id === 'promptGuideOverlay') {
                closePromptGuide();
            }
        }

        function initHandbookDots() {
            const dotsContainer = document.getElementById('handbookDots');
            if (!dotsContainer) return;
            
            dotsContainer.innerHTML = '';
            for (let i = 0; i < totalHandbookPages; i++) {
                const dot = document.createElement('div');
                dot.className = 'handbook-dot' + (i === 0 ? ' active' : '');
                dot.onclick = () => goToHandbookPage(i);
                dotsContainer.appendChild(dot);
            }
        }

        function goToHandbookPage(pageNum) {
            const pages = document.querySelectorAll('.handbook-page');
            const dots = document.querySelectorAll('.handbook-dot');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            // Update pages
            pages.forEach((page, index) => {
                page.classList.remove('active', 'prev');
                if (index === pageNum) {
                    page.classList.add('active');
                } else if (index < pageNum) {
                    page.classList.add('prev');
                }
            });
            
            // Update dots
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === pageNum);
            });
            
            // Update buttons
            if (prevBtn) prevBtn.disabled = pageNum === 0;
            if (nextBtn) nextBtn.disabled = pageNum === totalHandbookPages - 1;
            
            currentHandbookPage = pageNum;
        }

        function nextHandbookPage() {
            if (currentHandbookPage < totalHandbookPages - 1) {
                goToHandbookPage(currentHandbookPage + 1);
            }
        }

        function prevHandbookPage() {
            if (currentHandbookPage > 0) {
                goToHandbookPage(currentHandbookPage - 1);
            }
        }

        // Keyboard navigation for handbook
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('promptGuideOverlay');
            if (!overlay || !overlay.classList.contains('active')) return;
            
            if (e.key === 'Escape') {
                closePromptGuide();
            } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                nextHandbookPage();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                prevHandbookPage();
            }
        });

        // Export handbook functions
        window.showPromptGuide = showPromptGuide;
        window.closePromptGuide = closePromptGuide;
        window.closePromptGuideOnOverlay = closePromptGuideOnOverlay;
        window.nextHandbookPage = nextHandbookPage;
        window.prevHandbookPage = prevHandbookPage;
        window.goToHandbookPage = goToHandbookPage;

// ============================================
// PRIVACY POLICY HANDBOOK FUNCTIONS
// Add these after the Prompt Guide functions (around line 7945)
// ============================================

let currentPrivacyPage = 0;
const totalPrivacyPages = 7; // 0 (cover) + 7 content pages

function showPrivacyGuide() {
    const overlay = document.getElementById('privacyGuideOverlay');
    if (overlay) {
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        initPrivacyHandbookDots();
        goToPrivacyPage(0);
    }
}

function closePrivacyGuide() {
    const overlay = document.getElementById('privacyGuideOverlay');
    if (overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function closePrivacyGuideOnOverlay(event) {
    if (event.target.id === 'privacyGuideOverlay') {
        closePrivacyGuide();
    }
}

function initPrivacyHandbookDots() {
    const dotsContainer = document.getElementById('privacyHandbookDots');
    if (!dotsContainer) return;
    
    dotsContainer.innerHTML = '';
    for (let i = 0; i <= totalPrivacyPages; i++) {
        const dot = document.createElement('button');
        dot.className = 'handbook-dot';
        if (i === 0) dot.classList.add('active');
        dot.onclick = () => goToPrivacyPage(i);
        dotsContainer.appendChild(dot);
    }
}

function goToPrivacyPage(pageNum) {
    const pages = document.querySelectorAll('#privacyGuideOverlay .handbook-page');
    const dots = document.querySelectorAll('#privacyHandbookDots .handbook-dot');
    const prevBtn = document.getElementById('privacyPrevPageBtn');
    const nextBtn = document.getElementById('privacyNextPageBtn');
    
    if (!pages.length) return;
    
    // Update current page
    currentPrivacyPage = pageNum;
    
    // Update pages
    pages.forEach((page, idx) => {
        page.classList.remove('active', 'prev');
        if (idx === pageNum) {
            page.classList.add('active');
        } else if (idx < pageNum) {
            page.classList.add('prev');
        }
    });
    
    // Update dots
    dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === pageNum);
    });
    
    // Update navigation buttons
    if (prevBtn) prevBtn.disabled = pageNum === 0;
    if (nextBtn) nextBtn.disabled = pageNum === totalPrivacyPages;
}

function nextPrivacyPage() {
    if (currentPrivacyPage < totalPrivacyPages) {
        goToPrivacyPage(currentPrivacyPage + 1);
    }
}

function prevPrivacyPage() {
    if (currentPrivacyPage > 0) {
        goToPrivacyPage(currentPrivacyPage - 1);
    }
}

// Make functions globally available
window.showPrivacyGuide = showPrivacyGuide;
window.closePrivacyGuide = closePrivacyGuide;
window.closePrivacyGuideOnOverlay = closePrivacyGuideOnOverlay;
window.initPrivacyHandbookDots = initPrivacyHandbookDots;
window.goToPrivacyPage = goToPrivacyPage;
window.nextPrivacyPage = nextPrivacyPage;
window.prevPrivacyPage = prevPrivacyPage;
        // ============================================
        // EXAMPLE QUERY SUBMISSION
        // ============================================
        function submitExampleQuery(query) {
            // Auto-select quick reasoning level if not selected
            if (!selectedReasoningLevel.initial) {
                selectReasoningLevel('initial', 'quick');
            }
            
            // Set the input value
            const input = document.getElementById('aiInputInitial');
            if (input) {
                input.value = query;
            }
            
            // Submit the query
            submitInitialQuery();
        }
        window.submitExampleQuery = submitExampleQuery;

        // ============================================
        // SHARE MODAL FUNCTIONS
        // ============================================
        function showShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeShareModal(event) {
            if (event && event.target.id !== 'shareModal') return;
            const modal = document.getElementById('shareModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        }

        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            if (linkInput) {
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    showNotification('Link copied to clipboard!', 'info');
                }).catch(() => {
                    showNotification('Failed to copy link', 'error');
                });
            }
        }

        function shareVia(platform) {
            const link = document.getElementById('shareLink')?.value || 'https://leaf.ai/chat/abc123';
            const title = 'Check out this Leaf AI conversation';
            
            switch(platform) {
                case 'email':
                    window.open(`mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(link)}`);
                    break;
                case 'slack':
                    showNotification('Opening Slack share...', 'info');
                    // In a real app, this would integrate with Slack API
                    break;
                case 'teams':
                    showNotification('Opening Teams share...', 'info');
                    // In a real app, this would integrate with Teams API
                    break;
                case 'download':
                    showNotification('Preparing export...', 'info');
                    // In a real app, this would generate a PDF/DOCX
                    break;
            }
            closeShareModal({ target: { id: 'shareModal' } });
        }

        window.showShareModal = showShareModal;
        window.closeShareModal = closeShareModal;
        window.copyShareLink = copyShareLink;
        window.shareVia = shareVia;


        /**
 * ============================================
 * PROMPT ENHANCER - JavaScript Component
 * ============================================
 * 
 * A floating pill component that enhances user prompts
 * using AI for regulatory intelligence queries.
 * 
 * Usage:
 *   const enhancer = new PromptEnhancer({
 *       textareaSelector: '#chat-input',
 *       containerSelector: '#chat-input-container',
 *       apiEndpoint: '/api/enhance-prompt',
 *       minChars: 10,
 *       onEnhance: (original, enhanced) => console.log('Enhanced!'),
 *       onAccept: (enhanced) => console.log('Accepted!'),
 *       onRevert: (original) => console.log('Reverted!')
 *   });
 */

class PromptEnhancer {
    constructor(options = {}) {
        // Configuration
        this.config = {
            textareaSelector: options.textareaSelector || '#chat-input',
            containerSelector: options.containerSelector || '#chat-input-container',
            apiEndpoint: options.apiEndpoint || '/api/enhance-prompt',
            minChars: options.minChars || 10,
            debounceMs: options.debounceMs || 300,
            onEnhance: options.onEnhance || null,
            onAccept: options.onAccept || null,
            onRevert: options.onRevert || null
        };

        // State
        this.state = {
            originalPrompt: '',
            enhancedPrompt: '',
            isLoading: false,
            isEnhanced: false,
            isPillVisible: false,
            isActionsVisible: false,
            isPillDismissed: false,
            isPreviewVisible: false
        };

        // DOM Elements
        this.textarea = null;
        this.container = null;
        this.pillElement = null;
        this.actionsElement = null;
        this.previewElement = null;

        // Debounce timer
        this.debounceTimer = null;

        // Initialize
        this.init();
    }

    init() {
        // Get DOM elements
        this.textarea = document.querySelector(this.config.textareaSelector);
        this.container = document.querySelector(this.config.containerSelector);

        if (!this.textarea || !this.container) {
            console.warn('PromptEnhancer: Required elements not found');
            return;
        }

        // Ensure container has relative positioning
        const containerStyle = window.getComputedStyle(this.container);
        if (containerStyle.position === 'static') {
            this.container.style.position = 'relative';
        }

        // Create elements
        this.createPillElement();
        this.createActionsElement();
        this.createPreviewElement();

        // Attach event listeners
        this.attachEventListeners();
    }

    // ============================================
    // ELEMENT CREATION
    // ============================================

    createPillElement() {
        this.pillElement = document.createElement('div');
        this.pillElement.className = 'prompt-enhancer-pill hidden';
        this.pillElement.innerHTML = `
            <svg class="enhancer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3l1.912 5.813a2 2 0 001.272 1.272L21 12l-5.813 1.912a2 2 0 00-1.272 1.272L12 21l-1.912-5.813a2 2 0 00-1.272-1.272L3 12l5.813-1.912a2 2 0 001.272-1.272L12 3z"/>
            </svg>
            <span class="enhancer-text">Enhance Prompt</span>
            <span class="enhancer-close" title="Dismiss">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </span>
        `;
        this.container.appendChild(this.pillElement);
    }

    createActionsElement() {
        this.actionsElement = document.createElement('div');
        this.actionsElement.className = 'prompt-enhancer-actions hidden';
        this.actionsElement.innerHTML = `
            <button class="enhancer-accept-btn" title="Accept enhanced prompt">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Accept
            </button>
            <div class="enhancer-divider"></div>
            <button class="enhancer-view-btn" title="View original prompt">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Original
            </button>
            <button class="enhancer-revert-btn" title="Revert to original prompt">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                </svg>
                Revert
            </button>
        `;
        this.container.appendChild(this.actionsElement);
    }

    createPreviewElement() {
        this.previewElement = document.createElement('div');
        this.previewElement.className = 'original-prompt-preview hidden';
        this.previewElement.innerHTML = `
            <div class="original-prompt-preview-header">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Original Prompt
            </div>
            <div class="original-prompt-preview-text"></div>
        `;
        this.container.appendChild(this.previewElement);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    attachEventListeners() {
        // Textarea input - show/hide pill
        this.textarea.addEventListener('input', () => {
            this.handleTextareaInput();
        });

        // Textarea focus - check if should show pill
        this.textarea.addEventListener('focus', () => {
            this.handleTextareaFocus();
        });

        // Pill click - enhance prompt
        this.pillElement.addEventListener('click', (e) => {
            // Don't trigger if clicking close button
            if (e.target.closest('.enhancer-close')) {
                return;
            }
            this.enhancePrompt();
        });

        // Close button click
        this.pillElement.querySelector('.enhancer-close').addEventListener('click', (e) => {
            e.stopPropagation();
            this.dismissPill();
        });

        // Accept button
        this.actionsElement.querySelector('.enhancer-accept-btn').addEventListener('click', () => {
            this.acceptEnhancement();
        });

        // View original button (hover/click to show preview)
        const viewBtn = this.actionsElement.querySelector('.enhancer-view-btn');
        viewBtn.addEventListener('mouseenter', () => {
            this.showPreview();
        });
        viewBtn.addEventListener('mouseleave', () => {
            this.hidePreview();
        });
        viewBtn.addEventListener('click', () => {
            // Toggle preview on click for mobile
            if (this.state.isPreviewVisible) {
                this.hidePreview();
            } else {
                this.showPreview();
            }
        });

        // Revert button
        this.actionsElement.querySelector('.enhancer-revert-btn').addEventListener('click', () => {
            this.revertToOriginal();
        });

        // Click outside to hide preview
        document.addEventListener('click', (e) => {
            if (this.state.isPreviewVisible && 
                !this.previewElement.contains(e.target) && 
                !e.target.closest('.enhancer-view-btn')) {
                this.hidePreview();
            }
        });
    }

    // ============================================
    // INPUT HANDLING
    // ============================================

    handleTextareaInput() {
        // Clear existing debounce
        clearTimeout(this.debounceTimer);

        const text = this.textarea.value.trim();

        // If enhanced and text changes, reset state
        if (this.state.isEnhanced && text !== this.state.enhancedPrompt) {
            this.resetState();
        }

        // Debounce the pill visibility check
        this.debounceTimer = setTimeout(() => {
            this.checkPillVisibility();
        }, this.config.debounceMs);
    }

    handleTextareaFocus() {
        // Check if should show pill on focus
        setTimeout(() => {
            this.checkPillVisibility();
        }, 100);
    }

    checkPillVisibility() {
        const text = this.textarea.value.trim();
        const shouldShow = text.length >= this.config.minChars && 
                          !this.state.isEnhanced && 
                          !this.state.isLoading &&
                          !this.state.isPillDismissed;

        if (shouldShow && !this.state.isPillVisible) {
            this.showPill();
        } else if (!shouldShow && this.state.isPillVisible) {
            this.hidePill();
        }

        // Reset dismissed state if text is cleared
        if (text.length < this.config.minChars) {
            this.state.isPillDismissed = false;
        }
    }

    // ============================================
    // PILL VISIBILITY
    // ============================================

    showPill() {
        this.state.isPillVisible = true;
        this.pillElement.classList.remove('hidden');
        this.pillElement.classList.remove('loading');
        
        // Reset to default state
        this.pillElement.innerHTML = `
            <svg class="enhancer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3l1.912 5.813a2 2 0 001.272 1.272L21 12l-5.813 1.912a2 2 0 00-1.272 1.272L12 21l-1.912-5.813a2 2 0 00-1.272-1.272L3 12l5.813-1.912a2 2 0 001.272-1.272L12 3z"/>
            </svg>
            <span class="enhancer-text">Enhance Prompt</span>
            <span class="enhancer-close" title="Dismiss">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </span>
        `;

        // Re-attach close button listener
        this.pillElement.querySelector('.enhancer-close').addEventListener('click', (e) => {
            e.stopPropagation();
            this.dismissPill();
        });
    }

    hidePill() {
        this.state.isPillVisible = false;
        this.pillElement.classList.add('hidden');
    }

    dismissPill() {
        this.state.isPillDismissed = true;
        this.hidePill();
    }

    // ============================================
    // ENHANCEMENT PROCESS
    // ============================================

    async enhancePrompt() {
        if (this.state.isLoading) return;

        // Store original
        this.state.originalPrompt = this.textarea.value.trim();

        // Set loading state
        this.state.isLoading = true;
        this.showLoadingState();
        this.disableSendButton();

        try {
            // Call API
            const response = await fetch(this.config.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: this.state.originalPrompt
                })
            });

            if (!response.ok) {
                throw new Error('Enhancement failed');
            }

            const data = await response.json();
            this.state.enhancedPrompt = data.enhancedPrompt;

            // Update textarea with animation
            this.textarea.classList.add('textarea-enhancing');
            await this.sleep(150);
            this.textarea.value = this.state.enhancedPrompt;
            this.textarea.classList.remove('textarea-enhancing');
            this.textarea.classList.add('textarea-enhanced');
            
            // Auto-resize textarea if needed
            this.autoResizeTextarea();

            // Trigger callback
            if (this.config.onEnhance) {
                this.config.onEnhance(this.state.originalPrompt, this.state.enhancedPrompt);
            }

            // Show actions
            this.state.isEnhanced = true;
            this.showActions();

        } catch (error) {
            console.error('PromptEnhancer: Enhancement failed', error);
            this.showError();
        } finally {
            this.state.isLoading = false;
            this.enableSendButton();
        }
    }

    showLoadingState() {
        this.pillElement.classList.add('loading');
        this.pillElement.innerHTML = `
            <div class="enhancer-skeleton">
                <div class="skeleton-spinner"></div>
                <span class="skeleton-text">Enhancing<span class="skeleton-dots"><span></span><span></span><span></span></span></span>
            </div>
        `;
        this.textarea.classList.add('textarea-enhancing');
    }

    showError() {
        this.hidePill();
        this.textarea.classList.remove('textarea-enhancing');
        
        // Could show a toast notification here
        console.error('Failed to enhance prompt');
    }

    // ============================================
    // ACTIONS (Accept/Revert)
    // ============================================

    showActions() {
        this.hidePill();
        this.state.isActionsVisible = true;
        this.actionsElement.classList.remove('hidden');
    }

    hideActions() {
        this.state.isActionsVisible = false;
        this.actionsElement.classList.add('hidden');
    }

    acceptEnhancement() {
        // Keep enhanced text
        this.hideActions();
        this.hidePreview();
        
        // Flash effect
        this.textarea.classList.add('textarea-enhanced');
        setTimeout(() => {
            this.textarea.classList.remove('textarea-enhanced');
        }, 400);

        // Trigger callback
        if (this.config.onAccept) {
            this.config.onAccept(this.state.enhancedPrompt);
        }

        // Reset state but keep the enhanced text
        this.resetState(false);
    }

    revertToOriginal() {
        // Restore original text
        this.textarea.value = this.state.originalPrompt;
        this.autoResizeTextarea();
        
        this.hideActions();
        this.hidePreview();

        // Trigger callback
        if (this.config.onRevert) {
            this.config.onRevert(this.state.originalPrompt);
        }

        // Reset state and show pill again
        this.resetState();
        this.checkPillVisibility();
    }

    // ============================================
    // PREVIEW
    // ============================================

    showPreview() {
        this.state.isPreviewVisible = true;
        const previewText = this.previewElement.querySelector('.original-prompt-preview-text');
        previewText.textContent = this.state.originalPrompt;
        this.previewElement.classList.remove('hidden');
    }

    hidePreview() {
        this.state.isPreviewVisible = false;
        this.previewElement.classList.add('hidden');
    }

    // ============================================
    // UTILITY METHODS
    // ============================================

    disableSendButton() {
        // Find and disable send button - customize selector as needed
        const sendBtn = document.querySelector('#send-btn, .send-button, [data-send-button]');
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.classList.add('disabled');
        }
    }

    enableSendButton() {
        const sendBtn = document.querySelector('#send-btn, .send-button, [data-send-button]');
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.classList.remove('disabled');
        }
    }

    autoResizeTextarea() {
        // Auto-resize textarea to fit content
        this.textarea.style.height = 'auto';
        this.textarea.style.height = this.textarea.scrollHeight + 'px';
        
        // Trigger input event for any listeners
        this.textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    resetState(resetText = true) {
        this.state.isEnhanced = false;
        this.state.isLoading = false;
        this.state.isPillDismissed = false;
        this.state.isPreviewVisible = false;
        
        if (resetText) {
            this.state.originalPrompt = '';
            this.state.enhancedPrompt = '';
        }

        this.hideActions();
        this.hidePreview();
        this.textarea.classList.remove('textarea-enhancing', 'textarea-enhanced');
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // ============================================
    // PUBLIC API
    // ============================================

    /**
     * Programmatically trigger enhancement
     */
    trigger() {
        if (this.textarea.value.trim().length >= this.config.minChars) {
            this.enhancePrompt();
        }
    }

    /**
     * Reset the enhancer to initial state
     */
    reset() {
        this.resetState();
        this.hidePill();
        this.hideActions();
    }

    /**
     * Destroy the enhancer and clean up
     */
    destroy() {
        this.pillElement?.remove();
        this.actionsElement?.remove();
        this.previewElement?.remove();
    }
}

// Export for module usage
if (typeof module !== 'undefined' && module.exports) {
    module.exports = PromptEnhancer;
}


        // ============================================
        // PROFILE MODAL FUNCTIONS
        // ============================================
        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeProfileModal(event) {
            if (event && event.target.id !== 'profileModal') return;
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }
        }

        function showProfileSection(section) {
            closeProfileModal({ target: { id: 'profileModal' } });
            
            const sectionNames = {
                'account': 'Account Settings',
                'preferences': 'Preferences',
                'usage': 'Usage & Billing',
                'help': 'Help & Support'
            };
            
            showNotification(`Opening ${sectionNames[section]}...`, 'info');
            // In a real app, this would navigate to the respective settings page
        }

        function handleLogout() {
            closeProfileModal({ target: { id: 'profileModal' } });
            showNotification('Signing out...', 'info');
            // In a real app, this would handle the logout process
            setTimeout(() => {
                showNotification('You have been signed out', 'info');
            }, 1000);
        }

        window.showProfileModal = showProfileModal;
        window.closeProfileModal = closeProfileModal;
        window.showProfileSection = showProfileSection;
        window.handleLogout = handleLogout;

        // ============================================
        // CONVERSATION SIDEBAR FUNCTIONS
        // ============================================
        let savedConversations = [];

        function loadConversation(index) {
            if (savedConversations[index]) {
                showNotification('Loading conversation...', 'info');
                // In a real app, this would load the conversation from storage
            }
        }

        function deleteConversation(index, event) {
            event.stopPropagation();
            savedConversations.splice(index, 1);
            renderConversationList();
            showNotification('Conversation deleted', 'info');
        }

        function renderConversationList() {
            const container = document.getElementById('conversationsContent');
            if (!container) return;
            
            if (savedConversations.length === 0) {
                container.innerHTML = '<p class="sidebar-empty">No conversations yet. Start a new chat!</p>';
                return;
            }
            
            container.innerHTML = savedConversations.map((conv, index) => `
                <div class="conversation-item" onclick="loadConversation(${index})">
                    <svg class="sidebar-item-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    <span class="flex-1 truncate">${escapeHtml(conv.title)}</span>
                    <button onclick="deleteConversation(${index}, event)" class="opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-200 rounded transition-all">
                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        
        window.togglePubmedAbstract = togglePubmedAbstract;
window.togglePubmedSelect = togglePubmedSelect;
// window.togglePubmedAnnotations = togglePubmedAnnotations;
// Results panel functions
window.openResultsPanel = openResultsPanel;
window.closeResultsPanel = closeResultsPanel;
window.switchResultsTab = switchResultsTab;
window.prevResultsPage = prevResultsPage;
window.nextResultsPage = nextResultsPage;
        window.loadConversation = loadConversation;
        window.deleteConversation = deleteConversation;
        window.renderConversationList = renderConversationList;

        function loadSampleConversation(title) {
            showNotification(`Loading "${title}"...`, 'info');
            // In a real app, this would load the conversation from storage
        }

        // ============================================
        // TRIALS FILTER TOGGLE
        // ============================================
        function toggleTrialsFilters() {
            const content = document.getElementById('trials-filter-content');
            const chevron = document.getElementById('trials-filter-chevron');
            
            if (!content || !chevron) return;
            
            const isOpen = content.style.maxHeight !== '0px' && content.style.maxHeight !== '';
            
            if (isOpen) {
                // Close
                content.style.maxHeight = '0';
                content.style.opacity = '0';
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // Open
                content.style.maxHeight = content.scrollHeight + 'px';
                content.style.opacity = '1';
                chevron.style.transform = 'rotate(90deg)';
            }
        }
        window.toggleTrialsFilters = toggleTrialsFilters;

        window.loadSampleConversation = loadSampleConversation;


/**
 * ================================================================================
 * LEAF INTELLIGENCE - UNIFIED AUTH & CONVERSATION SYSTEM
 * ================================================================================
 * 
 * Complete frontend authentication and conversation management
 * 
 * Features:
 * - User authentication & session management
 * - Login notification toast
 * - Conversation loading, rendering & management
 * - Account modal with profile, security, sessions, usage
 * - Activity tracking
 * 
 * @version 2.0.0
 */

// ============================================
// AUTH STATE MANAGEMENT
// ============================================

const LeafAuth = {
    user: null,
    isAuthenticated: false,
    conversations: [],
    currentConversationId: null,

    /**
     * Initialize auth - check if user is logged in
     */
    async init() {
        try {
            const response = await fetch('/auth/me', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.user) {
                this.user = data.user;
                this.isAuthenticated = true;
                this.onAuthStateChanged(true);
                return true;
            }

            this.handleNotAuthenticated();
            return false;

        } catch (error) {
            console.error('[Auth] Init error:', error);
            this.handleNotAuthenticated();
            return false;
        }
    },

    /**
     * Handle not authenticated state
     */
    handleNotAuthenticated() {
        this.user = null;
        this.isAuthenticated = false;
        this.onAuthStateChanged(false);

        // Redirect to login if not on login page
        if (!window.location.pathname.includes('login')) {
            window.location.href = '/login.html';
        }
    },

    /**
     * Callback when auth state changes
     */
    onAuthStateChanged(isAuthenticated) {
        console.log('[Auth] State changed:', isAuthenticated);

        if (isAuthenticated) {
            // Update UI with user info
            this.updateUserUI();
            
            // Show welcome notification
            this.showLoginNotification();
            
            // Load user's conversations
            LeafConversations.loadConversations();
        }
    },

//     /**
//      * Update all UI elements with user info
//      */
//     updateUserUI() {
//         if (!this.user) return;

//         const initials = `${this.user.firstName?.[0] || ''}${this.user.lastName?.[0] || ''}`.toUpperCase() || 'U';
//         const fullName = this.user.fullName || `${this.user.firstName} ${this.user.lastName}`;

//         // Enhanced sidebar user profile (new IDs)
//         const sidebarAvatar = document.getElementById('sidebarUserAvatar');
//         const sidebarName = document.getElementById('sidebarUserName');
//         const sidebarEmail = document.getElementById('sidebarUserEmail');

//         if (sidebarAvatar) sidebarAvatar.textContent = initials;
//         if (sidebarName) sidebarName.textContent = fullName;
//         if (sidebarEmail) sidebarEmail.textContent = this.user.email;

//         // Legacy element support (old IDs/classes)
//         const userNameEl = document.getElementById('user-name') || document.querySelector('.user-name');
//         const userEmailEl = document.getElementById('user-email') || document.querySelector('.user-email');
//         const userAvatarEl = document.getElementById('user-avatar') || document.querySelector('.user-avatar');
//         const companyEl = document.getElementById('user-company');
//         const queriesEl = document.getElementById('user-queries');

//         if (userNameEl) userNameEl.textContent = fullName;
//         if (userEmailEl) userEmailEl.textContent = this.user.email;
//         if (userAvatarEl) userAvatarEl.textContent = initials;
//         if (companyEl && this.user.company) companyEl.textContent = this.user.company;
//         if (queriesEl && this.user.usage) queriesEl.textContent = this.user.usage.totalQueries || 0;
//     },
// /**
//  * Get time-appropriate greeting
//  */
// getTimeBasedGreeting() {
//     const hour = new Date().getHours();
//     if (hour >= 5 && hour < 12) return 'Good morning';
//     if (hour >= 12 && hour < 17) return 'Good afternoon';
//     if (hour >= 17 && hour < 22) return 'Good evening';
//     return 'Good night';
// },

/**
 * Get time-appropriate greeting
 */
getTimeBasedGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'Good morning';
    if (hour >= 12 && hour < 17) return 'Good afternoon';
    if (hour >= 17 && hour < 22) return 'Good evening';
    return 'Good night';
},

/**
 * Update all UI elements with user info
 */
updateUserUI() {
    if (!this.user) return;

    const initials = `${this.user.firstName?.[0] || ''}${this.user.lastName?.[0] || ''}`.toUpperCase() || 'U';
    const fullName = this.user.fullName || `${this.user.firstName} ${this.user.lastName}`;
    const firstName = this.user.firstName || 'User';
    const greeting = this.getTimeBasedGreeting();

    // Enhanced sidebar user profile (new IDs)
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    const sidebarName = document.getElementById('sidebarUserName');
    const sidebarEmail = document.getElementById('sidebarUserEmail');

    if (sidebarAvatar) sidebarAvatar.textContent = initials;
    if (sidebarName) sidebarName.textContent = fullName;
    if (sidebarEmail) sidebarEmail.textContent = this.user.email;

    // Update welcome message greeting and name
    const greetingEl = document.querySelector('.chat-welcome-greeting');
    const greetingNameEl = document.getElementById('chatGreetingName');
    
    if (greetingEl) {
        greetingEl.innerHTML = `${greeting}, <span id="chatGreetingName">${firstName}</span>`;
    } else if (greetingNameEl) {
        greetingNameEl.textContent = firstName;
    }

    // Legacy element support (old IDs/classes)
    const userNameEl = document.getElementById('user-name') || document.querySelector('.user-name');
    const userEmailEl = document.getElementById('user-email') || document.querySelector('.user-email');
    const userAvatarEl = document.getElementById('user-avatar') || document.querySelector('.user-avatar');
    const companyEl = document.getElementById('user-company');
    const queriesEl = document.getElementById('user-queries');

    if (userNameEl) userNameEl.textContent = fullName;
    if (userEmailEl) userEmailEl.textContent = this.user.email;
    if (userAvatarEl) userAvatarEl.textContent = initials;
    if (companyEl && this.user.company) companyEl.textContent = this.user.company;
    if (queriesEl && this.user.usage) queriesEl.textContent = this.user.usage.totalQueries || 0;
},
    /**
     * Show login success notification
     */
    showLoginNotification() {
        if (!this.user) return;

        const initials = `${this.user.firstName?.[0] || ''}${this.user.lastName?.[0] || ''}`.toUpperCase();

        const toast = document.createElement('div');
        toast.className = 'login-toast';
        toast.innerHTML = `
            <div class="login-toast-avatar">${initials}</div>
            <div class="login-toast-content">
                <div class="login-toast-title">Welcome back, ${this.user.firstName}!</div>
                <div class="login-toast-subtitle">Signed in as ${this.user.email}</div>
            </div>
            <div class="login-toast-close" onclick="this.parentElement.remove()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
        `;

        document.body.appendChild(toast);

        // Auto-remove after animation
        setTimeout(() => {
            if (toast.parentElement) toast.remove();
        }, 4000);
    },

    /**
     * Logout user
     */
    async logout() {
        try {
            await fetch('/auth/logout', {
                method: 'POST',
                credentials: 'include'
            });
        } catch (error) {
            console.error('[Auth] Logout error:', error);
        }

        this.user = null;
        this.isAuthenticated = false;
        window.location.href = '/login.html';
    },

    /**
     * Get auth headers for API calls
     */
    getAuthHeaders() {
        return {
            'Content-Type': 'application/json'
            // Cookie is sent automatically with credentials: 'include'
        };
    }
};
// Placeholder functions for action buttons
function saveReport(event) {
    event.preventDefault();
    console.log('Save Report clicked');
    // Functionality to be implemented
}

function savePrompt(event) {
    event.preventDefault();
    console.log('Save Prompt clicked');
    // Functionality to be implemented
}

// ============================================================
// LEAF INTELLIGENCE - PROFESSIONAL DOCX EXPORT
// ============================================================
// Dependencies: 
//   - docx.js: https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js
//   - FileSaver.js: https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js
// ============================================================

// Extract title from markdown content
function extractSmartTitle(markdown) {
    const lines = markdown.split('\n');
    
    for (let line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('## ')) {
            return trimmed.replace(/^##\s+/, '').substring(0, 80);
        }
        if (trimmed.startsWith('# ')) {
            return trimmed.replace(/^#\s+/, '').substring(0, 80);
        }
    }
    
    for (let line of lines) {
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('-')) {
            return trimmed.substring(0, 80);
        }
    }
    
    return "Research Analysis Report";
}

// Process inline formatting for DOCX
function processInlineFormatting(text) {
    const children = [];
    const elements = [];
    let match;
    
    const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
    while ((match = linkRegex.exec(text)) !== null) {
        elements.push({
            start: match.index,
            end: match.index + match[0].length,
            type: 'link',
            text: match[1],
            url: match[2],
            priority: 1
        });
    }
    
    const boldRegex = /\*\*([^*]+)\*\*/g;
    while ((match = boldRegex.exec(text)) !== null) {
        elements.push({
            start: match.index,
            end: match.index + match[0].length,
            type: 'bold',
            text: match[1],
            priority: 2
        });
    }
    
    const italicRegex = /(?<!\*)\*(?!\*)([^*]+)\*(?!\*)/g;
    while ((match = italicRegex.exec(text)) !== null) {
        elements.push({
            start: match.index,
            end: match.index + match[0].length,
            type: 'italic',
            text: match[1],
            priority: 3
        });
    }
    
    const codeRegex = /`([^`]+)`/g;
    while ((match = codeRegex.exec(text)) !== null) {
        elements.push({
            start: match.index,
            end: match.index + match[0].length,
            type: 'code',
            text: match[1],
            priority: 2
        });
    }
    
    elements.sort((a, b) => {
        if (a.start !== b.start) return a.start - b.start;
        return a.priority - b.priority;
    });
    
    const filtered = [];
    elements.forEach(elem => {
        const overlaps = filtered.some(e => 
            (elem.start >= e.start && elem.start < e.end) ||
            (elem.end > e.start && elem.end <= e.end) ||
            (elem.start <= e.start && elem.end >= e.end)
        );
        if (!overlaps) filtered.push(elem);
    });
    
    let pos = 0;
    filtered.forEach(elem => {
        if (elem.start > pos) {
            const plain = text.substring(pos, elem.start);
            if (plain) children.push(new docx.TextRun({ text: plain }));
        }
        
        switch (elem.type) {
            case 'link':
                children.push(new docx.ExternalHyperlink({
                    children: [new docx.TextRun({
                        text: elem.text,
                        color: "0563C1",
                        underline: {
                            type: docx.UnderlineType.SINGLE,
                            color: "0563C1"
                        }
                    })],
                    link: elem.url
                }));
                break;
            case 'bold':
                children.push(new docx.TextRun({ text: elem.text, bold: true }));
                break;
            case 'italic':
                children.push(new docx.TextRun({ text: elem.text, italics: true }));
                break;
            case 'code':
                children.push(new docx.TextRun({
                    text: elem.text,
                    font: "Courier New",
                    size: 20,
                    color: "DC2626",
                    shading: { fill: "F3F4F6", type: docx.ShadingType.SOLID }
                }));
                break;
        }
        pos = elem.end;
    });
    
    if (pos < text.length) {
        const remaining = text.substring(pos);
        if (remaining) children.push(new docx.TextRun({ text: remaining }));
    }
    
    return children.length ? children : [new docx.TextRun({ text: text })];
}

// Parse markdown table to Word table
function parseMarkdownTable(tableLines) {
    if (tableLines.length < 2) return null;
    
    let separatorIndex = -1;
    for (let i = 0; i < tableLines.length; i++) {
        if (tableLines[i].match(/\|[\s\-:]+\|/)) {
            separatorIndex = i;
            break;
        }
    }
    
    if (separatorIndex === -1) return null;
    
    const headerLines = tableLines.slice(0, separatorIndex);
    const bodyLines = tableLines.slice(separatorIndex + 1);
    
    const parseCells = (line) => {
        return line.split('|').map(cell => cell.trim()).filter(cell => cell.length > 0);
    };
    
    const headerCells = headerLines.length > 0 ? parseCells(headerLines[0]) : [];
    const rows = bodyLines.map(line => parseCells(line)).filter(row => row.length > 0);
    
    if (headerCells.length === 0 && rows.length === 0) return null;
    
    const USABLE_WIDTH = 9360;
    const numColumns = headerCells.length || (rows[0] ? rows[0].length : 0);
    
    if (numColumns === 0) return null;
    
    const columnWidth = Math.floor(USABLE_WIDTH / numColumns);
    const columnWidths = Array(numColumns).fill(columnWidth);
    
    const totalWidth = columnWidths.reduce((a, b) => a + b, 0);
    if (totalWidth < USABLE_WIDTH) {
        columnWidths[columnWidths.length - 1] += (USABLE_WIDTH - totalWidth);
    }
    
    const tableRows = [];
    
    if (headerCells.length > 0) {
        tableRows.push(
            new docx.TableRow({
                children: headerCells.map((cell, idx) => 
                    new docx.TableCell({
                        width: { size: columnWidths[idx], type: docx.WidthType.DXA },
                        children: [new docx.Paragraph({
                            children: processInlineFormatting(cell),
                            run: { bold: true, color: "FFFFFF", size: 22 },
                            spacing: { line: 276, before: 0, after: 0 }
                        })],
                        shading: { fill: "047857", type: docx.ShadingType.SOLID },
                        margins: { top: 150, bottom: 150, left: 150, right: 150 }
                    })
                ),
                tableHeader: true
            })
        );
    }
    
    rows.forEach((row, idx) => {
        tableRows.push(
            new docx.TableRow({
                children: row.map((cell, colIdx) => 
                    new docx.TableCell({
                        width: { size: columnWidths[colIdx], type: docx.WidthType.DXA },
                        children: [new docx.Paragraph({
                            children: processInlineFormatting(cell),
                            spacing: { line: 276, before: 0, after: 0 }
                        })],
                        shading: { fill: idx % 2 === 0 ? "FFFFFF" : "F9FAFB", type: docx.ShadingType.SOLID },
                        margins: { top: 100, bottom: 100, left: 150, right: 150 }
                    })
                )
            })
        );
    });
    
    return new docx.Table({
        width: { size: USABLE_WIDTH, type: docx.WidthType.DXA },
        layout: docx.TableLayoutType.FIXED,
        columnWidths: columnWidths,
        rows: tableRows,
        borders: {
            top: { style: docx.BorderStyle.SINGLE, size: 1, color: "10B981" },
            bottom: { style: docx.BorderStyle.SINGLE, size: 1, color: "10B981" },
            left: { style: docx.BorderStyle.SINGLE, size: 1, color: "D1D5DB" },
            right: { style: docx.BorderStyle.SINGLE, size: 1, color: "D1D5DB" },
            insideHorizontal: { style: docx.BorderStyle.SINGLE, size: 1, color: "E5E7EB" },
            insideVertical: { style: docx.BorderStyle.SINGLE, size: 1, color: "E5E7EB" }
        }
    });
}

// Main download function - replaces the placeholder downloadWord
async function downloadWord(event) {
    event.preventDefault();
    
    // Find the streamId from the closest response container
    const button = event.target.closest('.response-action-btn') || event.target;
    const responseContainer = button.closest('[id^="stream-"]');
    const streamId = responseContainer ? responseContainer.id : currentStreamId;
    
    if (!streamId) {
        showNotification('No response content found', 'error');
        return;
    }
    
    try {
        showNotification('Generating Word document...', 'info');
        
        const markdown = responseMarkdown.get(streamId);
        if (!markdown) {
            showNotification('No content to export', 'error');
            return;
        }
        
        const docSections = [];
        const lines = markdown.split('\n');
        const now = new Date();
        
        const smartTitle = extractSmartTitle(markdown);
        const userPrompt = window.userPrompts ? window.userPrompts.get(streamId) : null;

        // ============================================================
        // COVER PAGE
        // ============================================================
        
        docSections.push(new docx.Paragraph({
            text: ` ${now.toLocaleDateString('en-US', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`,
            alignment: docx.AlignmentType.CENTER,
            spacing: { before: 800, after: 300 },
            run: { size: 80 }
        }));
        
        docSections.push(new docx.Paragraph({
            text: 'Leaf Intelligence Report',
            alignment: docx.AlignmentType.CENTER,
            spacing: { after: 150 },
            style: "TitleStyle"
        }));

        if (userPrompt) {
            docSections.push(new docx.Paragraph({
                children: [
                    new docx.TextRun({ text: "Research Query: ", bold: true, color: "374151", size: 22 }),
                    new docx.TextRun({ text: userPrompt, italics: true, color: "6B7280", size: 22 })
                ],
                alignment: docx.AlignmentType.CENTER,
                spacing: { after: 200 },
            }));
        }
        
        docSections.push(new docx.Paragraph({
            children: [new docx.TextRun({ text: "━━━━━━━━━━━━━━━━━━━━━━━━━", color: "10B981", size: 24 })],
            alignment: docx.AlignmentType.CENTER,
            spacing: { after: 300 }
        }));
        
        docSections.push(new docx.Paragraph({
            text: `🕐 ${now.toLocaleTimeString('en-US')}`,
            alignment: docx.AlignmentType.CENTER,
            spacing: { after: 800 },
            run: { size: 20, color: "9CA3AF" }
        }));
        
        docSections.push(new docx.Paragraph({ text: "", pageBreakBefore: true }));
        
        // ============================================================
        // PROCESS MARKDOWN CONTENT
        // ============================================================
        
        let inCodeBlock = false;
        let codeBlockContent = [];
        let inTable = false;
        let tableLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const trimmed = line.trim();
            
            if (!trimmed && !inCodeBlock && !inTable) {
                docSections.push(new docx.Paragraph({ text: "", spacing: { after: 140 } }));
                continue;
            }
            
            // Horizontal rules
            if (trimmed.match(/^[-_*]{3,}$/) && !inCodeBlock) {
                docSections.push(new docx.Paragraph({
                    children: [new docx.TextRun({ text: "───────────────────────────────", color: "D1D5DB" })],
                    alignment: docx.AlignmentType.CENTER,
                    spacing: { before: 200, after: 200 }
                }));
                continue;
            }
            
            // Code blocks
            if (trimmed.startsWith('```')) {
                if (!inCodeBlock) {
                    inCodeBlock = true;
                    codeBlockContent = [];
                } else {
                    if (codeBlockContent.length > 0) {
                        docSections.push(new docx.Paragraph({
                            text: codeBlockContent.join('\n'),
                            style: "CodeBlock",
                            spacing: { before: 240, after: 240 }
                        }));
                    }
                    inCodeBlock = false;
                    codeBlockContent = [];
                }
                continue;
            }
            
            if (inCodeBlock) {
                codeBlockContent.push(line);
                continue;
            }
            
            // Tables
            if (trimmed.includes('|') && trimmed.split('|').length >= 3) {
                if (!inTable) {
                    inTable = true;
                    tableLines = [];
                }
                tableLines.push(trimmed);
                continue;
            } else if (inTable) {
                const table = parseMarkdownTable(tableLines);
                if (table) {
                    docSections.push(table);
                    docSections.push(new docx.Paragraph({ text: "", spacing: { after: 240 } }));
                }
                inTable = false;
                tableLines = [];
            }
            
            // Headers
            if (trimmed.startsWith('# ')) {
                docSections.push(new docx.Paragraph({
                    text: trimmed.replace(/^#\s+/, ''),
                    style: "Heading1",
                    spacing: { before: 480, after: 240 }
                }));
            }
            else if (trimmed.startsWith('## ')) {
                docSections.push(new docx.Paragraph({
                    text: trimmed.replace(/^##\s+/, ''),
                    style: "Heading2",
                    spacing: { before: 360, after: 180 }
                }));
            }
            else if (trimmed.startsWith('### ')) {
                docSections.push(new docx.Paragraph({
                    text: trimmed.replace(/^###\s+/, ''),
                    style: "Heading3",
                    spacing: { before: 280, after: 140 }
                }));
            }
            else if (trimmed.startsWith('#### ')) {
                docSections.push(new docx.Paragraph({
                    text: trimmed.replace(/^####\s+/, ''),
                    style: "Heading4",
                    spacing: { before: 240, after: 120 }
                }));
            }
            // Blockquotes
            else if (trimmed.startsWith('> ')) {
                const children = processInlineFormatting(trimmed.replace(/^>\s+/, ''));
                docSections.push(new docx.Paragraph({
                    children: children,
                    style: "BlockQuote",
                    spacing: { before: 240, after: 240 }
                }));
            }
            // Bullet lists
            else if (trimmed.match(/^[-*•]\s/)) {
                const text = trimmed.replace(/^[-*•]\s/, '');
                const children = processInlineFormatting(text);
                docSections.push(new docx.Paragraph({
                    children: children,
                    bullet: { level: 0 },
                    spacing: { before: 100, after: 100 },
                    indent: { left: 720, hanging: 360 }
                }));
            }
            // Numbered lists
            else if (trimmed.match(/^\d+\.\s/)) {
                const text = trimmed.replace(/^\d+\.\s/, '');
                const children = processInlineFormatting(text);
                docSections.push(new docx.Paragraph({
                    children: children,
                    numbering: { reference: "default-numbering", level: 0 },
                    spacing: { before: 100, after: 100 },
                    indent: { left: 720, hanging: 360 }
                }));
            }
            // Regular text
            else if (trimmed) {
                const children = processInlineFormatting(trimmed);
                docSections.push(new docx.Paragraph({
                    children: children,
                    spacing: { before: 120, after: 120, line: 360 }
                }));
            }
        }
        
        // Handle remaining table
        if (inTable && tableLines.length > 0) {
            const table = parseMarkdownTable(tableLines);
            if (table) docSections.push(table);
        }
        
        // ============================================================
        // FOOTER
        // ============================================================
        
        docSections.push(new docx.Paragraph({ text: "", spacing: { before: 1000 } }));
        
        docSections.push(new docx.Paragraph({
            children: [new docx.TextRun({ text: "━━━━━━━━━━━━━━━━━━━━━━━━━", color: "10B981", size: 24 })],
            alignment: docx.AlignmentType.CENTER,
            spacing: { after: 300 }
        }));
        
        docSections.push(new docx.Paragraph({
            text: "Powered by Leaf Intelligence",
            alignment: docx.AlignmentType.CENTER,
            run: { size: 22, bold: true, color: "047857" },
            spacing: { after: 100 }
        }));
        
        docSections.push(new docx.Paragraph({
            text: "AI-Driven Research & Strategic Analysis",
            alignment: docx.AlignmentType.CENTER,
            run: { size: 20, italics: true, color: "6B7280" },
            spacing: { after: 150 }
        }));
        
        docSections.push(new docx.Paragraph({
            text: "Confidential • For Professional Use Only",
            alignment: docx.AlignmentType.CENTER,
            run: { size: 18, color: "9CA3AF", italics: true }
        }));
        
        // ============================================================
        // CREATE DOCUMENT
        // ============================================================
        
        const doc = new docx.Document({
            creator: "Leaf Intelligence",
            title: smartTitle,
            description: "Professional intelligence report",
            
            sections: [{
                properties: {
                    page: {
                        margin: { top: 800, right: 800, bottom: 800, left: 800 }
                    }
                },
                children: docSections
            }],
            
            styles: {
                default: {
                    document: {
                        run: { font: "Calibri", size: 22, color: "1F2937" },
                        paragraph: { spacing: { line: 360, before: 80, after: 80 } }
                    }
                },
                paragraphStyles: [
                    {
                        id: "TitleStyle",
                        name: "Title Style",
                        run: { size: 52, bold: true, color: "047857", font: "Calibri Light" },
                        paragraph: { spacing: { before: 0, after: 90 }, alignment: docx.AlignmentType.CENTER }
                    },
                    {
                        id: "Heading1",
                        name: "Heading 1",
                        run: { size: 32, bold: true, color: "047857", font: "Calibri" },
                        paragraph: {
                            spacing: { before: 280, after: 140 },
                            border: { bottom: { color: "10B981", space: 1, style: docx.BorderStyle.SINGLE, size: 8 } }
                        }
                    },
                    {
                        id: "Heading2",
                        name: "Heading 2",
                        run: { size: 28, bold: true, color: "059669", font: "Calibri" },
                        paragraph: { spacing: { before: 160, after: 120 } }
                    },
                    {
                        id: "Heading3",
                        name: "Heading 3",
                        run: { size: 24, bold: true, color: "10B981", font: "Calibri" },
                        paragraph: { spacing: { before: 120, after: 80 } }
                    },
                    {
                        id: "Heading4",
                        name: "Heading 4",
                        run: { size: 22, bold: true, color: "34D399", font: "Calibri" },
                        paragraph: { spacing: { before: 140, after: 100 } }
                    },
                    {
                        id: "BlockQuote",
                        name: "Block Quote",
                        run: { size: 22, italics: true, color: "374151" },
                        paragraph: {
                            indent: { left: 720, right: 720 },
                            spacing: { before: 140, after: 140 },
                            shading: { fill: "ECFDF5", type: docx.ShadingType.SOLID },
                            border: { left: { color: "10B981", space: 1, style: docx.BorderStyle.SINGLE, size: 24 } }
                        }
                    },
                    {
                        id: "CodeBlock",
                        name: "Code Block",
                        run: { font: "Courier New", size: 20, color: "1F2937" },
                        paragraph: {
                            shading: { fill: "F9FAFB", type: docx.ShadingType.SOLID },
                            border: {
                                top: { color: "E5E7EB", space: 1, style: docx.BorderStyle.SINGLE, size: 2 },
                                bottom: { color: "E5E7EB", space: 1, style: docx.BorderStyle.SINGLE, size: 2 },
                                left: { color: "10B981", space: 1, style: docx.BorderStyle.SINGLE, size: 12 },
                                right: { color: "E5E7EB", space: 1, style: docx.BorderStyle.SINGLE, size: 2 }
                            },
                            spacing: { before: 240, after: 240 },
                            indent: { left: 400, right: 400 }
                        }
                    },
                    {
                        id: "TableHeader",
                        name: "Table Header",
                        run: { bold: true, color: "FFFFFF", size: 22 }
                    }
                ]
            },
            
            numbering: {
                config: [{
                    reference: "default-numbering",
                    levels: [{
                        level: 0,
                        format: docx.LevelFormat.DECIMAL,
                        text: "%1.",
                        alignment: docx.AlignmentType.START,
                        style: {
                            paragraph: { indent: { left: 720, hanging: 360 } },
                            run: { color: "059669", bold: true }
                        }
                    }]
                }]
            }
        });
        
        // Generate and download
        const sanitizedTitle = smartTitle
            .replace(/[^a-zA-Z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .substring(0, 50);
        
        const blob = await docx.Packer.toBlob(doc);
        saveAs(blob, `Leaf-Intelligence-Report-${sanitizedTitle}-${now.toISOString().split('T')[0]}.docx`);
        
        showNotification('Word document exported successfully!', 'success');
        
    } catch (error) {
        console.error('DOCX Export Error:', error);
        showNotification('Failed to export Word document', 'error');
    }
}

async function downloadPowerPoint(event) {
    event.preventDefault();
    
    // Find the streamId from the closest response container
    const button = event.target.closest('.response-action-btn') || event.target;
    const responseContainer = button.closest('[id^="stream-"]');
    const streamId = responseContainer ? responseContainer.id : currentStreamId;
    
    if (!streamId) {
        showNotification('No response content found', 'error');
        return;
    }
    
    try {
        showNotification('Generating PowerPoint...', 'info');
        await exportToPPTX(streamId);
    } catch (error) {
        console.error('PowerPoint export error:', error);
        showNotification('Failed to export PowerPoint', 'error');
    }
}

function shareResponse(event) {
    event.preventDefault();
    console.log('Share clicked');
    // Functionality to be implemented
}
// ============================================
// CONVERSATION MANAGEMENT
// ============================================

const LeafConversations = {
    /**
     * Load user's conversations
     */
    async loadConversations(options = {}) {
        const container = document.getElementById('conversationsListContainer');

        try {
            const params = new URLSearchParams({
                limit: options.limit || 30,
                skip: options.skip || 0,
                status: options.status || 'active'
            });

            const response = await fetch(`/api/user/conversations?${params}`, {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                LeafAuth.conversations = data.conversations;
                this.renderConversationsList(data.conversations);
                return data;
            }

            this.renderEmptyState();
            return { conversations: [], pagination: {} };

        } catch (error) {
            console.error('[Conversations] Load error:', error);
            this.renderEmptyState();
            return { conversations: [], pagination: {} };
        }
    },

    /**
     * Render conversations list in sidebar
     */
    renderConversateionsList(conversations) {
        const container = document.getElementById('conversationsListContainer');
        
        // Fallback to old ID if new one doesn't exist
        const listEl = container || document.getElementById('conversations-list') || document.getElementById('conversationsContent');
        if (!listEl) return;

        if (!conversations || conversations.length === 0) {
            this.renderEmptyState();
            return;
        }

        listEl.innerHTML = conversations.map(conv => {
            const isActive = LeafAuth.currentConversationId === conv.conversationId;
            const badges = [];

            if (conv.cachedData?.clinicalTrialsCount) {
                badges.push(`<span class="conv-badge trials">${conv.cachedData.clinicalTrialsCount} trials</span>`);
            }
            if (conv.cachedData?.fdaResultsCount) {
                badges.push(`<span class="conv-badge fda">${conv.cachedData.fdaResultsCount} FDA</span>`);
            }
            if (conv.cachedData?.pubmedCount) {
                badges.push(`<span class="conv-badge pubmed">${conv.cachedData.pubmedCount} papers</span>`);
            }

            return `
                <div class="conv-item ${isActive ? 'active' : ''}" onclick="LeafConversations.loadConversation('${conv.conversationId}')">
                    <div class="conv-item-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                    </div>
                    <div class="conv-item-content">
                        <div class="conv-item-title">${this.escapeHtml(conv.title || 'Untitled')}</div>
                        <div class="conv-item-meta">
                            <span>${this.formatDate(conv.updatedAt)}</span>
                            ${conv.messageCount ? `<span>${conv.messageCount} msgs</span>` : ''}
                        </div>
                        ${badges.length ? `<div class="conv-item-badges">${badges.join('')}</div>` : ''}
                    </div>
                    <div class="conv-item-actions">
                        <button class="conv-action-btn" onclick="event.stopPropagation(); LeafConversations.renameConversation('${conv.conversationId}')" title="Rename">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button class="conv-action-btn delete" onclick="event.stopPropagation(); LeafConversations.deleteConversation('${conv.conversationId}')" title="Delete">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    },


renderConversationsList(conversations, showAll = false) {
    const container = document.getElementById('conversationsListContainer');
    const viewAllBtn = document.getElementById('viewAllConversations');
    
    const listEl = container || document.getElementById('conversations-list') || document.getElementById('conversationsContent');
    if (!listEl) return;

    if (!conversations || conversations.length === 0) {
        this.renderEmptyState();
        if (viewAllBtn) viewAllBtn.style.display = 'none';
        return;
    }

    // Check if we're in expanded mode
    const isExpanded = container && container.classList.contains('conversations-expanded');
    const displayAll = showAll || isExpanded;
    
    // Limit to 8 items unless showing all
    const maxItems = 10;
    const displayConversations = displayAll ? conversations : conversations.slice(0, maxItems);
    const hasMore = conversations.length > maxItems;

    // Show/hide "View all" button
    if (viewAllBtn) {
        if (hasMore && !isExpanded) {
            viewAllBtn.style.display = 'inline';
            viewAllBtn.textContent = 'View all';
        } else if (isExpanded) {
            viewAllBtn.style.display = 'inline';
            viewAllBtn.textContent = 'Show less';
        } else {
            viewAllBtn.style.display = 'none';
        }
    }

    listEl.innerHTML = displayConversations.map(conv => {
        const isActive = LeafAuth.currentConversationId === conv.conversationId;
        const badges = [];

        if (conv.cachedData?.clinicalTrialsCount) {
            badges.push(`<span class="conv-badge trials">${conv.cachedData.clinicalTrialsCount} trials</span>`);
        }
        if (conv.cachedData?.fdaResultsCount) {
            badges.push(`<span class="conv-badge fda">${conv.cachedData.fdaResultsCount} FDA</span>`);
        }
        if (conv.cachedData?.pubmedCount) {
            badges.push(`<span class="conv-badge pubmed">${conv.cachedData.pubmedCount} papers</span>`);
        }

        const title = conv.title || 'Untitled';
        const truncated = title.length > 40 
            ? title.substring(0, 40).trim() + '...' 
            : title;

        return `
            <div class="starter-item-wrapper ${isActive ? 'active' : ''}">
                <button class="starter-item" onclick="LeafConversations.loadConversation('${conv.conversationId}')">
                    <span class="starter-item-text">${this.escapeHtml(truncated)}</span>
                </button>
                <div class="conv-item-actions">
                    <button class="conv-action-btn" onclick="event.stopPropagation(); LeafConversations.renameConversation('${conv.conversationId}')" title="Rename">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                    <button class="conv-action-btn delete" onclick="event.stopPropagation(); LeafConversations.deleteConversation('${conv.conversationId}')" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
    }).join('');
},

toggleViewAll() {
    const container = document.getElementById('conversationsListContainer');
    const starterSection = container?.closest('.starter-section');
    
    if (!container) return;
    
    const isExpanded = container.classList.contains('conversations-expanded');
    
    if (isExpanded) {
        // Collapse
        container.classList.remove('conversations-expanded');
        container.classList.add('conversations-limited');
        starterSection?.classList.remove('expanded');
    } else {
        // Expand
        container.classList.remove('conversations-limited');
        container.classList.add('conversations-expanded');
        starterSection?.classList.add('expanded');
    }
    
    // Re-render with appropriate items
    this.renderConversationsList(LeafAuth.conversations);
},
escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
},

/**
     * Render empty state
     */
    renderEmptyState() {
        const container = document.getElementById('conversationsListContainer') || 
                          document.getElementById('conversations-list') || 
                          document.getElementById('conversationsContent');
        if (!container) return;

        container.innerHTML = `
            <div style="padding: 24px 16px; text-align: center;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="1.5" style="margin: 0 auto 12px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                </svg>
                <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 4px;">No conversations yet</p>
                <p style="font-size: 0.75rem; color: #9ca3af;">Start a new research query above</p>
            </div>
        `;
    },

    /**
     * Load a specific conversation with messages
     */
    async loadConversation(conversationId) {
        try {
            const response = await fetch(`/api/user/conversations/${conversationId}`, {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.conversation) {
                // FIXED: Sync BOTH conversation ID variables
                LeafAuth.currentConversationId = conversationId;
                // Also set the global currentConversationId used by query submission
                if (typeof currentConversationId !== 'undefined') {
                    currentConversationId = conversationId;
                }
                window.currentConversationId = conversationId; // Ensure global access

                // Render messages
                if (data.conversation.messages) {
                    this.renderMessages(data.conversation.messages);
                }

                // Update active state in sidebar
                this.renderConversationsList(LeafAuth.conversations);

                // Store raw data for context
                if (data.conversation.rawData) {
                    window.currentConversationData = data.conversation.rawData;
                }

                // Update breadcrumb with conversation title
                const breadcrumbCurrent = document.getElementById('currentChatName');
                if (breadcrumbCurrent && data.conversation.title) {
                    breadcrumbCurrent.textContent = data.conversation.title;
                }

                // Show the continuous input, hide welcome state (FIXED: use correct element IDs)
                const emptyState = document.getElementById('emptyChatState');
                const initialInput = document.getElementById('initialInputBar');
                const examplePills = document.getElementById('examplepils');
                const continuousInput = document.getElementById('continuousChatInput');
                
                if (emptyState) emptyState.classList.add('hidden');
                if (initialInput) initialInput.classList.add('hidden');
                if (examplePills) examplePills.classList.add('hidden');
                if (continuousInput) continuousInput.style.display = 'flex';

                // Mark conversation as started
                if (typeof conversationStarted !== 'undefined') {
                    conversationStarted = true;
                }

                console.log(`[Conversations] Loaded conversation: ${conversationId}`);
                return data.conversation;
            }

            return null;

        } catch (error) {
            console.error('[Conversations] Load conversation error:', error);
            LeafAccount.showToast('Failed to load conversation', 'error');
            return null;
        }
    },

    /**
     * Render messages in chat area
     */
    renderMessages(messages) {
        // FIXED: Use correct container ID (was chatHistory/chat-container, now chatContainer)
        const chatArea = document.getElementById('chatContainer');
        if (!chatArea) {
            console.error('[Conversations] Chat container not found');
            return;
        }

        if (!messages || messages.length === 0) {
            chatArea.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">No messages in this conversation.</p>';
            return;
        }

        chatArea.innerHTML = messages.map(msg => {
            if (msg.role === 'user') {
                return `
                    <div class="user-message-container fade-in-up">
                        <div class="user-message-wrapper">
                            <div class="user-message-bubble">
                                <span class="message-text">${this.escapeHtml(msg.content)}</span>
                            </div>
                            <div class="user-message-meta">
                                <span class="message-time">${this.formatTime(msg.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Assistant message - use the same structure as live responses
                const renderedContent = msg.structuredResponse?.markdown || this.renderMarkdown(msg.content);
                return `
                    <div class="fade-in-up ai-response-wrapper">
                        <div class="ai-response">
                            <div class="response-header">
                                <div class="ai-avatar">
                                    <svg viewBox="0 0 40 52" fill="none">
                                        <path d="M20 4 L30 10 L34 20 L32 32 L24 42 L20 46 L16 42 L8 32 L6 20 L10 10 Z" fill="#247a64"/>
                                        <path d="M20 8 L20 42" stroke="#4db897" stroke-width="1.5" opacity="0.5"/>
                                        <path d="M20 14 L14 20 M20 14 L26 20" stroke="#4db897" stroke-width="1" opacity="0.4"/>
                                        <path d="M20 24 L12 30 M20 24 L28 30" stroke="#4db897" stroke-width="1" opacity="0.3"/>
                                    </svg>
                                </div>
                                <div class="ai-info">
                                    <div class="ai-name">Leaf Intelligence</div>
                                    <div class="ai-subtitle">Evidence-Based Analysis</div>
                                </div>
                            </div>
                            <div class="response-content">
                                ${renderedContent}
                            </div>
                        </div>
                    </div>
                `;
            }
        }).join('');

        // Scroll to bottom
        const chatContent = document.getElementById('chatContent');
        if (chatContent) {
            chatContent.scrollTop = chatContent.scrollHeight;
        }
    },

    /**
     * Render a single message (for live updates)
     */
    renderMessage(role, content, structuredResponse = null) {
        // FIXED: Use correct container ID
        const chatContainer = document.getElementById('chatContainer');
        if (!chatContainer) {
            console.error('[Conversations] Chat container not found');
            return;
        }

        const messageEl = document.createElement('div');

        if (role === 'user') {
            messageEl.className = 'user-message-container fade-in-up';
            messageEl.innerHTML = `
                <div class="user-message-wrapper">
                    <div class="user-message-bubble">
                        <span class="message-text">${this.escapeHtml(content)}</span>
                    </div>
                    <div class="user-message-meta">
                        <span class="message-time">${this.formatTime(new Date())}</span>
                    </div>
                </div>
            `;
 } else {
    // Use the same structure as live AI responses
    messageEl.className = 'fade-in-up ai-response-wrapper';
    const renderedContent = structuredResponse?.markdown || this.renderMarkdown(content);
    messageEl.innerHTML = `
        <div class="ai-response">
            <div class="response-header">
                <div class="ai-avatar">
                    <svg viewBox="0 0 40 52" fill="none">
                        <path d="M20 4 L30 10 L34 20 L32 32 L24 42 L20 46 L16 42 L8 32 L6 20 L10 10 Z" fill="#247a64"/>
                        <path d="M20 8 L20 42" stroke="#4db897" stroke-width="1.5" opacity="0.5"/>
                        <path d="M20 14 L14 20 M20 14 L26 20" stroke="#4db897" stroke-width="1" opacity="0.4"/>
                        <path d="M20 24 L12 30 M20 24 L28 30" stroke="#4db897" stroke-width="1" opacity="0.3"/>
                    </svg>
                </div>
                <div class="ai-info">
                    <div class="ai-name">Leaf Intelligence</div>
                    <div class="ai-subtitle">Evidence-Based Analysis</div>
                </div>
            </div>
            <div class="response-content">
                ${renderedContent}
            </div>
            
            <!-- Action Buttons -->
            <div class="response-actions">
                <button class="response-action-btn" onclick="saveReport(event)" title="Save Report">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    <span>Save Report</span>
                </button>
                
                <button class="response-action-btn" onclick="savePrompt(event)" title="Save Prompt">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                    </svg>
                    <span>Save Prompt</span>
                </button>
                
                <button class="response-action-btn" onclick="downloadWord(event)" title="Download as Word">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Word</span>
                </button>
                
                <button class="response-action-btn" onclick="downloadPowerPoint(event)" title="Download as PowerPoint">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h4"/>
                    </svg>
                    <span>PowerPoint</span>
                </button>
                
                <button class="response-action-btn" onclick="shareResponse(event)" title="Share">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    <span>Share</span>
                </button>
            </div>
        </div>
    `;
}
        chatContainer.appendChild(messageEl);
        
        // Scroll to bottom
        const chatContent = document.getElementById('chatContent');
        if (chatContent) {
            chatContent.scrollTop = chatContent.scrollHeight;
        }
    },

    /**
     * Start new conversation
     */
    startNewConversation() {
        // FIXED: Clear BOTH conversation ID variables
        LeafAuth.currentConversationId = null;
        if (typeof currentConversationId !== 'undefined') {
            currentConversationId = null;
        }
        window.currentConversationId = null;
        
        window.currentConversationData = null;
        this.clearChat();

        // Update sidebar
        this.renderConversationsList(LeafAuth.conversations);

        // FIXED: Show welcome state, hide continuous input
        const emptyState = document.getElementById('emptyChatState');
        const initialInput = document.getElementById('initialInputBar');
        const examplePills = document.getElementById('examplepils');
        const continuousInput = document.getElementById('continuousChatInput');
        
        if (emptyState) emptyState.classList.remove('hidden');
        if (initialInput) initialInput.classList.remove('hidden');
        if (examplePills) examplePills.classList.remove('hidden');
        if (continuousInput) continuousInput.style.display = 'none';

        // Reset conversation state
        if (typeof conversationStarted !== 'undefined') {
            conversationStarted = false;
        }

        // Focus the initial input
        const input = document.getElementById('aiInputInitial');
        if (input) input.focus();
        
        console.log('[Conversations] Started new conversation');
    },

    /**
     * Clear chat area
     */
    clearChat() {
        // FIXED: Use correct container ID
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.innerHTML = '';
        }
    },

/**
 * Rename conversation
 */
async renameConversation(conversationId) {
    const conv = LeafAuth.conversations.find(c => c.conversationId === conversationId);
    
    // Store conversation ID for confirmation
    this.pendingRenameId = conversationId;
    
    // Show modal and populate with current title
    const modal = document.getElementById('renameConversationModal');
    const input = document.getElementById('conversationTitleInput');
    
    if (modal && input) {
        input.value = conv?.title || 'Untitled';
        modal.style.display = 'flex';
        
        // Focus input and select text
        setTimeout(() => {
            input.focus();
            input.select();
        }, 100);
        
        // Add Enter key handler
        input.onkeydown = (e) => {
            if (e.key === 'Enter') {
                this.confirmRename();
            } else if (e.key === 'Escape') {
                this.closeRenameModal();
            }
        };
    }
},

/**
 * Close rename modal
 */
closeRenameModal() {
    const modal = document.getElementById('renameConversationModal');
    if (modal) {
        modal.style.display = 'none';
        this.pendingRenameId = null;
    }
},

/**
 * Confirm rename
 */
async confirmRename() {
    const input = document.getElementById('conversationTitleInput');
    const newTitle = input?.value.trim();
    
    if (!newTitle) {
        LeafAccount.showToast('Please enter a title', 'error');
        return;
    }
    
    const conversationId = this.pendingRenameId;
    const conv = LeafAuth.conversations.find(c => c.conversationId === conversationId);
    
    if (newTitle === conv?.title) {
        this.closeRenameModal();
        return;
    }
    
    try {
        const response = await fetch(`/api/user/conversations/${conversationId}`, {
            method: 'PUT',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });

        const data = await response.json();

        if (data.success) {
            if (conv) conv.title = newTitle;
            this.renderConversationsList(LeafAuth.conversations);
            LeafAccount.showToast('Conversation renamed', 'success');
            this.closeRenameModal();
        } else {
            LeafAccount.showToast('Failed to rename', 'error');
        }

    } catch (error) {
        console.error('[Conversations] Rename error:', error);
        LeafAccount.showToast('Failed to rename', 'error');
    }
},

/**
 * Delete conversation
 */
async deleteConversation(conversationId) {
    const conv = LeafAuth.conversations.find(c => c.conversationId === conversationId);
    
    // Store conversation ID for confirmation
    this.pendingDeleteId = conversationId;
    
    // Show modal and display conversation title
    const modal = document.getElementById('deleteConversationModal');
    const titleEl = document.getElementById('deleteConversationTitle');
    
    if (modal && titleEl) {
        titleEl.textContent = conv?.title || 'Untitled';
        modal.style.display = 'flex';
        
        // Close modal on overlay click
        modal.onclick = () => this.closeDeleteModal();
    }
},

/**
 * Close delete modal
 */
closeDeleteModal() {
    const modal = document.getElementById('deleteConversationModal');
    if (modal) {
        modal.style.display = 'none';
        this.pendingDeleteId = null;
    }
},

/**
 * Confirm delete
 */
async confirmDelete() {
    const conversationId = this.pendingDeleteId;
    
    if (!conversationId) return;
    
    try {
        const response = await fetch(`/api/user/conversations/${conversationId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
            LeafAuth.conversations = LeafAuth.conversations.filter(c => c.conversationId !== conversationId);

            if (LeafAuth.currentConversationId === conversationId) {
                this.startNewConversation();
            }

            this.renderConversationsList(LeafAuth.conversations);
            LeafAccount.showToast('Conversation deleted', 'success');
            this.closeDeleteModal();
        } else {
            LeafAccount.showToast('Failed to delete', 'error');
        }

    } catch (error) {
        console.error('[Conversations] Delete error:', error);
        LeafAccount.showToast('Failed to delete', 'error');
    }
},
    /**
     * Render markdown content
     */
    renderMarkdown(text) {
        if (!text) return '';

        // Use marked.js if available
        if (typeof marked !== 'undefined') {
            try {
                const parsed = marked.parse(text);
                return typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(parsed) : parsed;
            } catch (e) {
                console.warn('[Markdown] Parse error:', e);
            }
        }

        // Fallback basic markdown
        return text
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>')
            .replace(/\n/g, '<br>');
    },

    /**
     * Format date for display
     */
    formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = now - date;

        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

        return date.toLocaleDateString();
    },

    /**
     * Format time for messages
     */
    formatTime(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    },

    /**
     * Escape HTML
     */
    escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// ============================================
// ACCOUNT MANAGEMENT MODAL
// ============================================

const LeafAccount = {
    /**
     * Open account modal
     */
    openModal() {
        const overlay = document.getElementById('accountModalOverlay');
        if (overlay) {
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            this.populateProfile();
            this.loadSessions();
            this.loadUsageStats();
        }
    },

    /**
     * Close account modal
     */
    closeModal() {
        const overlay = document.getElementById('accountModalOverlay');
        if (overlay) {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    },

    /**
     * Switch between tabs
     */
    switchTab(tabName) {
        // Update nav tabs
        document.querySelectorAll('.account-nav-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Update sections
        document.querySelectorAll('.account-section').forEach(section => {
            section.classList.remove('active');
        });

        const section = document.getElementById(`accountSection${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
        if (section) section.classList.add('active');
    },

    /**
     * Populate profile form with current user data
     */
    populateProfile() {
        const user = LeafAuth.user;
        if (!user) return;

        const initials = `${user.firstName?.[0] || ''}${user.lastName?.[0] || ''}`.toUpperCase();
        const fullName = user.fullName || `${user.firstName} ${user.lastName}`;

        // Update display elements
        const avatarEl = document.getElementById('accountAvatarLarge');
        const fullNameEl = document.getElementById('accountFullName');
        const emailEl = document.getElementById('accountEmail');

        if (avatarEl) avatarEl.textContent = initials;
        if (fullNameEl) fullNameEl.textContent = fullName;
        if (emailEl) emailEl.textContent = user.email;

        // Update form fields
        const firstNameEl = document.getElementById('accountFirstName');
        const lastNameEl = document.getElementById('accountLastName');
        const emailInputEl = document.getElementById('accountEmailInput');
        const companyEl = document.getElementById('accountCompany');

        if (firstNameEl) firstNameEl.value = user.firstName || '';
        if (lastNameEl) lastNameEl.value = user.lastName || '';
        if (emailInputEl) emailInputEl.value = user.email || '';
        if (companyEl) companyEl.value = user.company || '';
    },

    /**
     * Save profile changes
     */
    async saveProfile(event) {
        if (event) event.preventDefault();

        const data = {
            firstName: document.getElementById('accountFirstName')?.value,
            lastName: document.getElementById('accountLastName')?.value,
            company: document.getElementById('accountCompany')?.value
        };

        try {
            const response = await fetch('/auth/profile', {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                LeafAuth.user = result.user;
                LeafAuth.updateUserUI();
                this.populateProfile();
                this.showToast('Profile updated successfully', 'success');
            } else {
                this.showToast(result.error || 'Failed to update profile', 'error');
            }

        } catch (error) {
            console.error('[Profile] Save error:', error);
            this.showToast('Failed to update profile', 'error');
        }
    },

    /**
     * Change password
     */
    async changePassword(event) {
        if (event) event.preventDefault();

        const currentPassword = document.getElementById('currentPassword')?.value;
        const newPassword = document.getElementById('newPassword')?.value;
        const confirmPassword = document.getElementById('confirmNewPassword')?.value;

        if (!currentPassword || !newPassword) {
            this.showToast('Please fill in all password fields', 'error');
            return;
        }

        if (newPassword !== confirmPassword) {
            this.showToast('New passwords do not match', 'error');
            return;
        }

        if (newPassword.length < 8) {
            this.showToast('Password must be at least 8 characters', 'error');
            return;
        }

        try {
            const response = await fetch('/auth/password', {
                method: 'PUT',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const result = await response.json();

            if (result.success) {
                this.showToast('Password changed successfully', 'success');
                // Clear password fields
                ['currentPassword', 'newPassword', 'confirmNewPassword'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
            } else {
                this.showToast(result.error || 'Failed to change password', 'error');
            }

        } catch (error) {
            console.error('[Profile] Password change error:', error);
            this.showToast('Failed to change password', 'error');
        }
    },

    /**
     * Load active sessions
     */
    async loadSessions() {
        const container = document.getElementById('sessionsList');
        if (!container) return;

        try {
            const response = await fetch('/auth/sessions', { credentials: 'include' });
            const data = await response.json();

            if (data.success && data.sessions) {
                container.innerHTML = data.sessions.map(session => {
                    const deviceIcon = session.deviceInfo?.device === 'Mobile'
                        ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>'
                        : '<path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>';

                    return `
                        <div class="session-item ${session.isCurrent ? 'current' : ''}">
                            <div class="session-info">
                                <div class="session-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        ${deviceIcon}
                                    </svg>
                                </div>
                                <div class="session-details">
                                    <h4>${session.deviceInfo?.browser || 'Unknown'} on ${session.deviceInfo?.os || 'Unknown'}</h4>
                                    <p>${session.isCurrent ? 'Current session' : `Last active ${LeafConversations.formatDate(session.createdAt)}`}</p>
                                </div>
                            </div>
                            ${!session.isCurrent ? `
                                <button class="btn-danger" style="padding: 6px 12px; font-size: 0.75rem;" onclick="LeafAccount.revokeSession('${session.id}')">
                                    Revoke
                                </button>
                            ` : `
                                <span style="font-size: 0.75rem; color: #059669; font-weight: 500;">Active</span>
                            `}
                        </div>
                    `;
                }).join('');
            }

        } catch (error) {
            console.error('[Sessions] Load error:', error);
            container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Failed to load sessions</p>';
        }
    },

    /**
     * Revoke a session
     */
    async revokeSession(sessionId) {
        if (!confirm('Are you sure you want to revoke this session?')) return;

        try {
            const response = await fetch(`/auth/sessions/${sessionId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                this.loadSessions();
                this.showToast('Session revoked', 'success');
            } else {
                this.showToast(data.error || 'Failed to revoke session', 'error');
            }

        } catch (error) {
            console.error('[Sessions] Revoke error:', error);
            this.showToast('Failed to revoke session', 'error');
        }
    },

    /**
     * Load usage statistics
     */
    loadUsageStats() {
        const user = LeafAuth.user;
        if (!user) return;

        const totalQueries = document.getElementById('statTotalQueries');
        const monthlyQueries = document.getElementById('statMonthlyQueries');
        const totalConversations = document.getElementById('statTotalConversations');
        const memberSince = document.getElementById('statMemberSince');

        if (totalQueries) totalQueries.textContent = user.usage?.totalQueries || 0;
        if (monthlyQueries) monthlyQueries.textContent = user.usage?.monthlyQueries || 0;
        if (totalConversations) totalConversations.textContent = user.usage?.totalConversations || 0;
        if (memberSince) {
            memberSince.textContent = user.createdAt
                ? new Date(user.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })
                : '-';
        }
    },

    /**
     * Delete account
     */
    async deleteAccount() {
        if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
        if (!confirm('This will permanently delete all your data. Are you absolutely sure?')) return;

        // TODO: Implement account deletion endpoint
        this.showToast('Please contact support to delete your account', 'info');
    },

    /**
     * Logout
     */
    async logout() {
        this.closeModal();
        await LeafAuth.logout();
    },

    /**
     * Show toast notification
     */
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg text-white z-[10000] transition-all transform translate-y-0 opacity-100 flex items-center gap-2 ${
            type === 'success' ? 'bg-emerald-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;

        const icon = type === 'success'
            ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
            : type === 'error'
            ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
            : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';

        toast.innerHTML = `${icon}<span>${message}</span>`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('translate-y-2', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
};

// ============================================
// QUERY WRAPPER (with auth)
// ============================================

/**
 * Send query with authentication and conversation tracking
 */
async function sendAuthenticatedQuery(query, options = {}) {
    // Generate conversation ID if not exists
    if (!LeafAuth.currentConversationId) {
        LeafAuth.currentConversationId = `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    try {
        const response = await fetch('/query', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query,
                conversationId: LeafAuth.currentConversationId,
                ...options
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update conversation ID if server assigned one
            if (data.conversationId) {
                LeafAuth.currentConversationId = data.conversationId;
            }

            // Refresh conversations list
            LeafConversations.loadConversations();
        }

        return data;

    } catch (error) {
        console.error('[Query] Error:', error);
        throw error;
    }
}

// ============================================
// INITIALIZATION
// ============================================

/**
 * Initialize auth when DOM is ready
 */
document.addEventListener('DOMContentLoaded', () => {
    // Don't init on login page
    if (window.location.pathname.includes('login')) {
        return;
    }

    // Initialize auth
    LeafAuth.init();

    // Initialize prompt enhancer
// Initialize prompt enhancer for INITIAL input (welcome screen)
const promptEnhancerInitial = new PromptEnhancer({
    textareaSelector: '#aiInputInitial',
    containerSelector: '#initialUploadZone',
    apiEndpoint: '/api/enhance-prompt',
    minChars: 10
});

// Initialize prompt enhancer for CONTINUOUS input (followup)
const promptEnhancerContinuous = new PromptEnhancer({
    textareaSelector: '#aiInputContinuous',
    containerSelector: '#continuousUploadZone',
    apiEndpoint: '/api/enhance-prompt',
    minChars: 10
});
});

// ============================================
// GLOBAL EXPORTS & BACKWARDS COMPATIBILITY
// ============================================

// Make objects globally available
window.LeafAuth = LeafAuth;
window.LeafConversations = LeafConversations;
window.LeafAccount = LeafAccount;
window.sendAuthenticatedQuery = sendAuthenticatedQuery;

// Backwards compatibility aliases
window.LeafAuthEnhanced = LeafAuth;
window.LeafConversationsEnhanced = LeafConversations;
window.LeafProfile = LeafAccount;

// Override legacy modal functions
window.showProfileModal = function() {
    LeafAccount.openModal();
};

window.closeProfileModal = function() {
    LeafAccount.closeModal();
};

window.handleLogout = function() {
    LeafAccount.logout();
};

// Legacy conversation functions
window.loadConversation = function(index) {
    if (LeafAuth.conversations[index]) {
        LeafConversations.loadConversation(LeafAuth.conversations[index].conversationId);
    }
};

window.deleteConversation = function(index, event) {
    if (event) event.stopPropagation();
    if (LeafAuth.conversations[index]) {
        LeafConversations.deleteConversation(LeafAuth.conversations[index].conversationId);
    }
};

window.renderConversationList = function() {
    LeafConversations.renderConversationsList(LeafAuth.conversations);
};

window.loadSampleConversation = function(title) {
    LeafAccount.showToast(`Loading "${title}"...`, 'info');
};

console.log('[Leaf] Unified auth system loaded v2.0.0');

// // Initialize conversation list on load
        // document.addEventListener('DOMContentLoaded', () => {
        //     renderConversationList();
        // });
// ============================================
// SKELETON LOADER - Simple & Reliable
// Add at the END of your <script> block
// ============================================

(function() {
    const overlay = document.getElementById('appSkeletonOverlay');
    const statusText = document.getElementById('skeletonStatusText');
    
    if (!overlay) return;
    
    // Simple status rotation
    const messages = ['Loading...', 'Preparing...', 'Almost ready...'];
    let i = 0;
    
    const statusInterval = setInterval(function() {
        i = (i + 1) % messages.length;
        if (statusText) statusText.textContent = messages[i];
    }, 600);
    
    // Hide function
    function hide() {
        clearInterval(statusInterval);
        if (statusText) statusText.textContent = 'Ready!';
        
        setTimeout(function() {
            overlay.classList.add('loaded');
            setTimeout(function() {
                overlay.remove();
            }, 400);
        }, 200);
    }
    
    // Wait for window load + 800ms minimum
    let loaded = false;
    let minTimePassed = false;
    
    function tryHide() {
        if (loaded && minTimePassed) hide();
    }
    
    window.addEventListener('load', function() {
        loaded = true;
        tryHide();
    });
    
    setTimeout(function() {
        minTimePassed = true;
        tryHide();
    }, 800);
    
    // Failsafe
    setTimeout(hide, 4000);
})();

// ============================================
// REPLACE EVERYTHING FROM LINE 9652 to ~9783
// (The entire "MY PROMPTS CENTER" section)
// ============================================

// ============================================
// MY PROMPTS CENTER
// ============================================

// Store loaded prompts from API
let userSavedPrompts = [];

/**
 * Load user's saved prompts from the API
 */
async function loadUserPrompts(options = {}) {
    try {
        const params = new URLSearchParams({
            limit: options.limit || 50,
            skip: options.skip || 0,
            sortBy: options.sortBy || 'createdAt',
            sortOrder: options.sortOrder || 'desc'
        });
        
        if (options.search) {
            params.append('search', options.search);
        }
        
        const response = await fetch(`/api/user/prompts?${params}`, {
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            userSavedPrompts = data.prompts;
            return data.prompts;
        }
        
        return [];
        
    } catch (error) {
        console.error('[Prompts] Load error:', error);
        return [];
    }
}

/**
 * Open the prompts center modal and load prompts
 */
async function openPromptsCenter() {
    const overlay = document.getElementById('promptsOverlay');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Show loading state
    const grid = document.getElementById('promptsGrid');
    grid.innerHTML = `
        <div class="prompts-loading">
            <div class="prompts-loading-spinner"></div>
            <p>Loading your prompts...</p>
        </div>
    `;
    grid.style.display = 'block';
    document.getElementById('promptsEmpty').style.display = 'none';
    
    // Load prompts from API
    const prompts = await loadUserPrompts();
    
    // Render the prompts
    renderPrompts(prompts);
}

/**
 * Close the prompts center modal
 */
function closePromptsCenter(event) {
    if (event && event.target !== event.currentTarget) return;
    const overlay = document.getElementById('promptsOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    
    // Clear search
    const searchInput = document.getElementById('promptsSearchInput');
    if (searchInput) searchInput.value = '';
}

/**
 * Render prompts in the grid
 */
function renderPrompts(prompts) {
    const grid = document.getElementById('promptsGrid');
    const empty = document.getElementById('promptsEmpty');
    
    if (!prompts || prompts.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        return;
    }
    
    grid.style.display = 'grid';
    empty.style.display = 'none';
    
    grid.innerHTML = prompts.map(prompt => {
        const category = prompt.category || 'custom';
        const tagStyle = getCategoryTagStyle(category);
        const tags = prompt.tags || [];
        
        return `
            <div class="prompt-card" data-prompt-id="${prompt._id}">
                <div class="prompt-card-actions">
                    <button class="prompt-action-btn" onclick="event.stopPropagation(); showPromptMenu('${prompt._id}', event)" title="More options">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
                <div class="prompt-card-tags">
                    <span class="prompt-tag ${tagStyle}">${formatCategory(category)}</span>
                    ${tags.slice(0, 2).map(tag => `<span class="prompt-tag custom">${escapeHtml(tag)}</span>`).join('')}
                </div>
                <h3 class="prompt-card-title">${escapeHtml(prompt.title)}</h3>
                <p class="prompt-card-author">By You${prompt.usageCount > 0 ? ` · Used ${prompt.usageCount}x` : ''}</p>
                <p class="prompt-card-desc">${escapeHtml(prompt.description || prompt.content?.substring(0, 150) || '')}${(prompt.content?.length || 0) > 150 ? '...' : ''}</p>
                <div class="prompt-card-footer">
                    <button class="prompt-use-btn" onclick="event.stopPropagation(); usePrompt('${prompt._id}')">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                        Use
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

/**
 * Get tag style class based on category
 */
function getCategoryTagStyle(category) {
    const styles = {
        'research': 'openai',
        'regulatory': 'gpt4',
        'clinical': 'claude',
        'analysis': 'cohere',
        'general': 'custom',
        'custom': 'custom'
    };
    return styles[category] || 'custom';
}

/**
 * Format category for display
 */
function formatCategory(category) {
    const labels = {
        'research': 'Research',
        'regulatory': 'Regulatory',
        'clinical': 'Clinical',
        'analysis': 'Analysis',
        'general': 'General',
        'custom': 'Custom'
    };
    return labels[category] || 'Custom';
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Filter prompts based on search query
 */
async function filterPrompts(query) {
    if (!query || query.trim() === '') {
        renderPrompts(userSavedPrompts);
        return;
    }
    
    const queryLower = query.toLowerCase();
    const filtered = userSavedPrompts.filter(p => 
        p.title?.toLowerCase().includes(queryLower) ||
        p.description?.toLowerCase().includes(queryLower) ||
        p.content?.toLowerCase().includes(queryLower) ||
        (p.tags || []).some(t => t.toLowerCase().includes(queryLower))
    );
    renderPrompts(filtered);
}

/**
 * Use a prompt - insert into the correct input field
 * Uses the 'hidden' class on initialInputBar to determine state
 */
async function usePrompt(promptId) {
    const prompt = userSavedPrompts.find(p => p._id === promptId);
    if (!prompt) {
        showNotification('Prompt not found', 'error');
        return;
    }
    
    // Close the prompts modal
    closePromptsCenter();
    
    // Get the prompt content
    const promptContent = prompt.content || prompt.description || '';
    
    // Get elements
    const initialInput = document.getElementById('aiInputInitial');
    const continuousInput = document.getElementById('aiInputContinuous');
    const initialInputBar = document.getElementById('initialInputBar');
    
    let targetInput = null;
    
    // Check if initialInputBar has 'hidden' class - if so, we're in conversation mode
    // When conversation starts: initialInputBar.classList.add('hidden')
    const isInitialHidden = initialInputBar && initialInputBar.classList.contains('hidden');
    
    if (isInitialHidden) {
        // We're in conversation mode - use continuous input
        targetInput = continuousInput;
    } else {
        // We're on welcome screen - use initial input
        targetInput = initialInput;
    }
    
    // Fallback if target not found
    if (!targetInput) {
        // Try to find which one is actually visible
        if (continuousInput && getComputedStyle(continuousInput).display !== 'none') {
            targetInput = continuousInput;
        } else if (initialInput) {
            targetInput = initialInput;
        }
    }
    
    if (targetInput) {
        // Set the value
        targetInput.value = promptContent;
        
        // Focus the input
        targetInput.focus();
        
        // Trigger input event for any listeners (auto-resize, etc.)
        targetInput.dispatchEvent(new Event('input', { bubbles: true }));
        
        // Auto-resize textarea
        if (targetInput.tagName === 'TEXTAREA') {
            targetInput.style.height = 'auto';
            targetInput.style.height = Math.min(targetInput.scrollHeight, 200) + 'px';
        }
        
        showNotification(`Loaded: ${prompt.title}`, 'success');
    } else {
        showNotification('Could not find input field', 'error');
        return;
    }
    
    // Record usage in background
    try {
        await fetch(`/api/user/prompts/${promptId}/use`, {
            method: 'POST',
            credentials: 'include'
        });
        
        // Update local count
        const localPrompt = userSavedPrompts.find(p => p._id === promptId);
        if (localPrompt) localPrompt.usageCount = (localPrompt.usageCount || 0) + 1;
    } catch (error) {
        console.error('[Prompts] Failed to record usage:', error);
    }
}

/**
 * Show prompt context menu with Edit and Delete options only
 */
function showPromptMenu(promptId, event) {
    event.stopPropagation();
    
    // Remove existing menu
    const existingMenu = document.querySelector('.prompt-context-menu');
    if (existingMenu) existingMenu.remove();
    
    const menu = document.createElement('div');
    menu.className = 'prompt-context-menu';
    menu.innerHTML = `
        <button onclick="editPrompt('${promptId}')" class="prompt-menu-item">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Edit
        </button>
        <button onclick="deletePrompt('${promptId}')" class="prompt-menu-item danger">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete
        </button>
    `;
    
    // Position menu
    const btn = event.target.closest('.prompt-action-btn');
    const rect = btn.getBoundingClientRect();
    menu.style.position = 'fixed';
    menu.style.top = `${rect.bottom + 4}px`;
    menu.style.left = `${Math.min(rect.left, window.innerWidth - 180)}px`;
    menu.style.zIndex = '1100';
    
    document.body.appendChild(menu);
    
    // Close menu when clicking outside
    const closeMenu = (e) => {
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        }
    };
    setTimeout(() => document.addEventListener('click', closeMenu), 10);
}

/**
 * Create a new prompt - opens the save modal
 */
function createNewPrompt() {
    openSavePromptModal('', null, null);
}

/**
 * Edit an existing prompt
 */
function editPrompt(promptId) {
    // Close context menu
    const menu = document.querySelector('.prompt-context-menu');
    if (menu) menu.remove();
    
    const prompt = userSavedPrompts.find(p => p._id === promptId);
    if (!prompt) {
        showNotification('Prompt not found', 'error');
        return;
    }
    
    // Open modal with existing data
    openSavePromptModal(prompt.content || '', null, prompt);
}

/**
 * Delete a prompt
 */
async function deletePrompt(promptId) {
    // Close context menu
    const menu = document.querySelector('.prompt-context-menu');
    if (menu) menu.remove();
    
    const prompt = userSavedPrompts.find(p => p._id === promptId);
    if (!prompt) {
        showNotification('Prompt not found', 'error');
        return;
    }
    
    if (!confirm(`Delete "${prompt.title}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/user/prompts/${promptId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Prompt deleted', 'success');
            // Remove from local cache
            userSavedPrompts = userSavedPrompts.filter(p => p._id !== promptId);
            // Re-render
            renderPrompts(userSavedPrompts);
        } else {
            showNotification(data.error || 'Failed to delete prompt', 'error');
        }
    } catch (error) {
        console.error('[Prompts] Delete error:', error);
        showNotification('Failed to delete prompt', 'error');
    }
}

/**
 * Open the save/edit prompt modal
 */
function openSavePromptModal(promptText, sourceConversationId = null, existingPrompt = null) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('savePromptModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'savePromptModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-container save-prompt-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title" id="savePromptModalTitle">Save Prompt</h3>
                    <button onclick="closeSavePromptModal()" class="modal-close-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="promptTitleInput" class="modal-label">Title *</label>
                        <input type="text" id="promptTitleInput" class="modal-input" placeholder="Enter a title for your prompt" maxlength="200">
                    </div>
                    <div class="form-group">
                        <label for="promptContentInput" class="modal-label">Prompt Content *</label>
                        <textarea id="promptContentInput" class="modal-textarea" placeholder="The prompt text..." rows="5" maxlength="10000"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="promptDescriptionInput" class="modal-label">Description (optional)</label>
                        <input type="text" id="promptDescriptionInput" class="modal-input" placeholder="Brief description of what this prompt does" maxlength="500">
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="promptCategorySelect" class="modal-label">Category</label>
                            <select id="promptCategorySelect" class="modal-select">
                                <option value="custom">Custom</option>
                                <option value="research">Research</option>
                                <option value="regulatory">Regulatory</option>
                                <option value="clinical">Clinical</option>
                                <option value="analysis">Analysis</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="promptTagsInput" class="modal-label">Tags (comma separated)</label>
                            <input type="text" id="promptTagsInput" class="modal-input" placeholder="e.g., FDA, clinical trials" maxlength="200">
                        </div>
                    </div>
                    <input type="hidden" id="promptSourceConversationId" value="">
                    <input type="hidden" id="promptEditId" value="">
                </div>
                <div class="modal-footer">
                    <button onclick="closeSavePromptModal()" class="modal-btn modal-btn-secondary">Cancel</button>
                    <button onclick="confirmSavePrompt()" class="modal-btn modal-btn-primary-green" id="savePromptConfirmBtn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span id="savePromptBtnText">Save Prompt</span>
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Close on overlay click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeSavePromptModal();
        });
    }
    
    // Populate fields
    const isEditing = !!existingPrompt;
    document.getElementById('savePromptModalTitle').textContent = isEditing ? 'Edit Prompt' : 'Save Prompt';
    document.getElementById('savePromptBtnText').textContent = isEditing ? 'Update Prompt' : 'Save Prompt';
    document.getElementById('promptEditId').value = isEditing ? existingPrompt._id : '';
    
    document.getElementById('promptContentInput').value = isEditing ? (existingPrompt.content || '') : promptText;
    document.getElementById('promptTitleInput').value = isEditing ? existingPrompt.title : generatePromptTitle(promptText);
    document.getElementById('promptDescriptionInput').value = isEditing ? (existingPrompt.description || '') : '';
    document.getElementById('promptCategorySelect').value = isEditing ? (existingPrompt.category || 'custom') : 'custom';
    document.getElementById('promptTagsInput').value = isEditing ? (existingPrompt.tags || []).join(', ') : '';
    document.getElementById('promptSourceConversationId').value = sourceConversationId || '';
    
    // Show modal
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('active'));
    
    // Focus on title input
    setTimeout(() => document.getElementById('promptTitleInput').focus(), 100);
}

/**
 * Generate a title from prompt text
 */
function generatePromptTitle(text) {
    if (!text) return '';
    
    let title = text.substring(0, 60);
    
    const breakPoints = ['. ', '? ', '! ', '\n'];
    for (const bp of breakPoints) {
        const idx = title.indexOf(bp);
        if (idx > 10 && idx < 50) {
            title = title.substring(0, idx);
            break;
        }
    }
    
    title = title.trim();
    if (text.length > 60 && !title.endsWith('...')) title += '...';
    
    return title;
}

/**
 * Close the save prompt modal
 */
function closeSavePromptModal() {
    const modal = document.getElementById('savePromptModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 200);
    }
}

/**
 * Confirm and save/update the prompt
 */
async function confirmSavePrompt() {
    const editId = document.getElementById('promptEditId').value;
    const isEditing = !!editId;
    
    const title = document.getElementById('promptTitleInput').value.trim();
    const content = document.getElementById('promptContentInput').value.trim();
    const description = document.getElementById('promptDescriptionInput').value.trim();
    const category = document.getElementById('promptCategorySelect').value;
    const tagsInput = document.getElementById('promptTagsInput').value.trim();
    const sourceConversationId = document.getElementById('promptSourceConversationId').value;
    
    if (!title) {
        showNotification('Please enter a title', 'error');
        document.getElementById('promptTitleInput').focus();
        return;
    }
    
    if (!content) {
        showNotification('Prompt content cannot be empty', 'error');
        document.getElementById('promptContentInput').focus();
        return;
    }
    
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
    
    const saveBtn = document.getElementById('savePromptConfirmBtn');
    const btnText = document.getElementById('savePromptBtnText');
    saveBtn.disabled = true;
    btnText.textContent = isEditing ? 'Updating...' : 'Saving...';
    
    try {
        const url = isEditing ? `/api/user/prompts/${editId}` : '/api/user/prompts';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                title,
                content,
                description,
                category,
                tags,
                sourceConversationId: sourceConversationId || undefined
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeSavePromptModal();
            showNotification(isEditing ? 'Prompt updated!' : 'Prompt saved!', 'success');
            
            if (isEditing) {
                const idx = userSavedPrompts.findIndex(p => p._id === editId);
                if (idx !== -1) {
                    userSavedPrompts[idx] = { ...userSavedPrompts[idx], title, content, description, category, tags };
                }
            } else {
                const newPrompt = data.prompt || { _id: Date.now().toString(), title, content, description, category, tags, usageCount: 0 };
                userSavedPrompts.unshift(newPrompt);
            }
            
            const promptsOverlay = document.getElementById('promptsOverlay');
            if (promptsOverlay?.classList.contains('active')) {
                renderPrompts(userSavedPrompts);
            }
        } else {
            showNotification(data.error || 'Failed to save prompt', 'error');
        }
    } catch (error) {
        console.error('[Prompts] Save error:', error);
        showNotification('Failed to save prompt', 'error');
    } finally {
        saveBtn.disabled = false;
        btnText.textContent = isEditing ? 'Update Prompt' : 'Save Prompt';
    }
}

/**
 * Save the current prompt from a message action button
 * Gets the USER MESSAGE text (what they typed), not the AI response
 */
function savePrompt(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const actionBar = event.target.closest('.action-bar');
    const aiResponseWrapper = actionBar?.closest('.ai-response-wrapper') || actionBar?.closest('.fade-in-up');
    
    let promptText = '';
    
    if (aiResponseWrapper) {
        // Find the user message that came before this AI response
        let prevElement = aiResponseWrapper.previousElementSibling;
        
        while (prevElement) {
            const userMessageBubble = prevElement.querySelector('.user-message-bubble .message-text');
            if (userMessageBubble) {
                promptText = userMessageBubble.textContent?.trim() || '';
                break;
            }
            
            if (prevElement.classList.contains('user-message')) {
                const messageText = prevElement.querySelector('.message-text');
                promptText = messageText?.textContent?.trim() || prevElement.textContent?.trim() || '';
                break;
            }
            
            prevElement = prevElement.previousElementSibling;
        }
    }
    
    // Fallback: try userPrompts map
    if (!promptText && aiResponseWrapper) {
        const streamId = aiResponseWrapper.id;
        if (streamId && window.userPrompts && window.userPrompts.has(streamId)) {
            promptText = window.userPrompts.get(streamId);
        }
    }
    
    // Last fallback: get the last user message
    if (!promptText) {
        const allUserMessages = document.querySelectorAll('.user-message-bubble .message-text');
        if (allUserMessages.length > 0) {
            promptText = allUserMessages[allUserMessages.length - 1].textContent?.trim() || '';
        }
    }
    
    if (!promptText) {
        showNotification('Could not find the prompt to save', 'error');
        return;
    }
    
    openSavePromptModal(promptText, null, null);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        const saveModal = document.getElementById('savePromptModal');
        if (saveModal?.classList.contains('active')) {
            closeSavePromptModal();
            return;
        }
        
        const promptsOverlay = document.getElementById('promptsOverlay');
        if (promptsOverlay?.classList.contains('active')) {
            closePromptsCenter();
            return;
        }
    }
});

// ============================================
// FILES CENTER
// ============================================

// Sample files data (replace with API call)
let userFiles = [
    {
        id: 1,
        name: "Clinical Trial Analysis Report",
        type: "report",
        createdAt: "Jan 16, 2024, 9:18 AM",
        lastActivity: "Jan 24, 2024, 9:18 AM",
        recipients: ["N", "S"],
        recipientColors: ["#f59e0b", "#ec4899"],
        status: "draft"
    },
    {
        id: 2,
        name: "FDA Approval Pathway Guide",
        type: "pdf",
        createdAt: "Jan 15, 2024, 9:18 AM",
        lastActivity: "Jan 23, 2024, 9:18 AM",
        recipients: ["F", "Q"],
        recipientColors: ["#8b5cf6", "#06b6d4"],
        status: "completed"
    },
    {
        id: 3,
        name: "PubMed Literature Review",
        type: "doc",
        createdAt: "Jan 14, 2024, 9:18 AM",
        lastActivity: "Jan 23, 2024, 9:18 AM",
        recipients: ["M"],
        recipientColors: ["#10b981"],
        status: "completed"
    },
    {
        id: 4,
        name: "Competitive Landscape Analysis",
        type: "report",
        createdAt: "Jan 13, 2024, 9:20 AM",
        lastActivity: "Jan 22, 2024, 9:18 AM",
        recipients: ["Q", "F", "3+"],
        recipientColors: ["#f43f5e", "#3b82f6", "#6b7280"],
        status: "sent"
    },
    {
        id: 5,
        name: "Drug Safety Profile Data",
        type: "data",
        createdAt: "Jan 12, 2024, 9:18 AM",
        lastActivity: "Jan 21, 2024, 10:24 AM",
        recipients: ["A", "E"],
        recipientColors: ["#f97316", "#22c55e"],
        status: "draft"
    },
    {
        id: 6,
        name: "Patent Landscape Report",
        type: "pdf",
        createdAt: "Jan 10, 2024, 11:18 AM",
        lastActivity: "Jan 21, 2024, 10:22 AM",
        recipients: ["Q", "S", "R"],
        recipientColors: ["#a855f7", "#ec4899", "#ef4444"],
        status: "completed"
    },
    {
        id: 7,
        name: "Molecule Structure Image",
        type: "image",
        createdAt: "Jan 10, 2024, 11:18 AM",
        lastActivity: "Jan 21, 2024, 10:20 AM",
        recipients: ["P"],
        recipientColors: ["#6366f1"],
        status: "sent"
    },
    {
        id: 8,
        name: "Clinical Endpoints Summary",
        type: "doc",
        createdAt: "Jan 10, 2024, 10:18 AM",
        lastActivity: "Jan 20, 2024, 10:18 AM",
        recipients: ["J", "Q"],
        recipientColors: ["#14b8a6", "#f59e0b"],
        status: "expired"
    }
];

let currentFilesTab = 'all';

function openFilesCenter() {
    const overlay = document.getElementById('filesOverlay');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    renderFiles(userFiles);
}

function closeFilesCenter(event) {
    if (event && event.target !== event.currentTarget) return;
    const overlay = document.getElementById('filesOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
}

function switchFilesTab(tab, btn) {
    currentFilesTab = tab;
    
    // Update active tab
    document.querySelectorAll('.files-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    // Filter files
    let filtered = userFiles;
    if (tab === 'reports') {
        filtered = userFiles.filter(f => f.type === 'report' || f.type === 'pdf');
    } else if (tab === 'uploads') {
        filtered = userFiles.filter(f => f.type === 'image');
    } else if (tab === 'drafts') {
        filtered = userFiles.filter(f => f.status === 'draft');
    }
    
    renderFiles(filtered);
}

function renderFiles(files) {
    const tbody = document.getElementById('filesTableBody');
    const empty = document.getElementById('filesEmpty');
    const table = document.getElementById('filesTable');
    
    if (files.length === 0) {
        table.style.display = 'none';
        empty.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    empty.style.display = 'none';
    
    tbody.innerHTML = files.map(file => `
        <tr>
            <td><input type="checkbox"></td>
            <td>
                <div class="file-name-cell">
                    <div class="file-icon-wrapper ${file.type}">
                        ${getFileIcon(file.type)}
                    </div>
                    <div class="file-name-info">
                        <h4>${file.name}</h4>
                        <p>Created: ${file.createdAt}</p>
                    </div>
                </div>
            </td>
            <td class="file-date">${file.lastActivity}</td>
            <td>
                <div class="file-recipients">
                    ${file.recipients.map((r, i) => `
                        <div class="recipient-avatar ${r.includes('+') ? 'more' : ''}" style="background: ${file.recipientColors[i]}">
                            ${r}
                        </div>
                    `).join('')}
                </div>
            </td>
            <td>
                <span class="file-status-badge ${file.status}">${capitalizeFirst(file.status)}</span>
            </td>
            <td>
                <div class="file-actions-cell">
                    <button class="btn-view-file" onclick="viewFile(${file.id})">View</button>
                    <button class="btn-file-more" onclick="showFileMenu(${file.id})">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getFileIcon(type) {
    const icons = {
        report: '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        pdf: '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>',
        doc: '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        image: '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
        data: '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>'
    };
    return icons[type] || icons.doc;
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function viewFile(fileId) {
    const file = userFiles.find(f => f.id === fileId);
    if (file) {
        showNotification(`Opening: ${file.name}`, 'info');
    }
}

function showFileMenu(fileId) {
    showNotification('File menu coming soon!', 'info');
}

function uploadNewFile() {
    // Trigger file upload
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = '.pdf,.doc,.docx,.png,.jpg,.jpeg,.xlsx,.csv';
    input.onchange = (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            showNotification(`Uploading ${files.length} file(s)...`, 'info');
            // TODO: Implement actual file upload
        }
    };
    input.click();
}

// Update sidebar button handlers
function navigateToExplore() {
    openFilesCenter();
}

function navigateToLibrary() {
    openPromptsCenter();
}

    </script>
</body>
</html>